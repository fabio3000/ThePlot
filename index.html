<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Plot | Your life is a movie.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=AdWPwOjuX1h1gYLtvpb63&currency=EUR"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #09090b; 
            color: #f4f4f5; 
            background-image: radial-gradient(circle at 50% 0%, #27272a 0%, #09090b 70%);
            min-height: 100vh;
        }
        h1, h2, h3, .serif { font-family: 'Playfair Display', serif; }
        .film-grain {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            pointer-events: none; z-index: 50; opacity: 0.04;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }
        .gold-text { background: linear-gradient(to right, #fbbf24, #d97706); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .ticket-cutout {
            mask-image: radial-gradient(circle at 0 50%, transparent 10px, black 11px), radial-gradient(circle at 100% 50%, transparent 10px, black 11px);
            mask-size: 51% 100%; mask-repeat: no-repeat; mask-position: left, right;
        }
        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #3f3f46; border-radius: 10px; }
        .blur-reveal { filter: blur(5px); transition: filter 0.5s ease; cursor: pointer; }
        .blur-reveal:hover { filter: blur(0px); }
    </style>
    <script>
        window.addEventListener('error', function(e) {
            const app = document.getElementById('app');
            if (app && app.innerHTML.includes('Loading')) {
                app.innerHTML = `<div class="max-w-lg mx-auto mt-20 p-8 bg-zinc-900 border border-red-500/50 text-red-200 rounded-2xl text-center z-50 relative"><h2 class="text-2xl font-bold mb-4 serif">Verbindung blockiert</h2><p class="text-sm">Bitte öffne die Seite über https://... auf GitHub Pages.</p></div>`;
            }
        }, true);
    </script>
</head>
<body class="flex flex-col relative overflow-x-hidden">
    <div class="film-grain"></div>

    <div id="app" class="flex-1 flex flex-col pb-12 z-10 relative">
        <div class="text-center mt-40 flex flex-col items-center">
            <div class="w-16 h-16 border-t-2 border-l-2 border-amber-500 rounded-full animate-spin mb-6"></div>
            <div class="text-2xl serif italic text-zinc-400">Loading your scene...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, addDoc, onSnapshot, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DATENBANK VERBINDUNG
        const firebaseConfig = {
          apiKey: "AIzaSyDzN7StXcxZVkYcs3pQBh1rAYypqKF54PE",
          authDomain: "equimatch-a9a03.firebaseapp.com",
          projectId: "equimatch-a9a03",
          storageBucket: "equimatch-a9a03.firebasestorage.app",
          messagingSenderId: "1064864391538",
          appId: "1:1064864391538:web:ceeca48c28a9e7a63f3deb"
        };

        let appInit, auth, db;
        const ALIASES = ["The Writer", "The Observer", "The Wanderer", "The Musician", "The Stranger"];

        let state = { 
            user: null, view: 'loading', profile: null, 
            currentDrop: null, // Wird jetzt aus der DB geladen
            hasTicket: false, messages: [], errorMsg: null, 
            authMode: 'login', logoClicks: 0
        };

        const appDiv = document.getElementById('app');

        setTimeout(() => {
            if (state.view === 'loading') appDiv.innerHTML = `<div class="text-center mt-20 text-red-500">Netzwerkfehler. Bitte lade die Seite neu.</div>`;
        }, 5000);

        try {
            appInit = initializeApp(firebaseConfig);
            auth = getAuth(appInit);
            db = getFirestore(appInit);
            
            onAuthStateChanged(auth, async (user) => {
                state.user = user;
                if (user) {
                    // 1. Profil laden
                    onSnapshot(doc(db, 'plot_users', user.uid), (docSnap) => {
                        if (docSnap.exists()) {
                            state.profile = docSnap.data();
                        } else {
                            state.profile = { hasPremium: false, tickets: [], alias: ALIASES[Math.floor(Math.random()*ALIASES.length)], isAdmin: false };
                            setDoc(doc(db, 'plot_users', user.uid), state.profile);
                        }
                        checkRouting();
                    });

                    // 2. Aktuellen Drop live aus der Datenbank laden
                    onSnapshot(collection(db, 'plot_drops'), (snap) => {
                        const drops = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        state.currentDrop = drops.find(d => d.isActive) || null;
                        
                        if(state.currentDrop) {
                            state.hasTicket = state.profile?.tickets && state.profile?.tickets.includes(state.currentDrop.id);
                            
                            // Chat laden
                            onSnapshot(collection(db, `plot_messages_${state.currentDrop.id}`), (msgSnap) => {
                                state.messages = msgSnap.docs.map(d => d.data()).sort((a,b) => a.timestamp - b.timestamp);
                                if(state.view === 'room') { render(); scrollToBottom(); }
                            });
                        }
                        checkRouting();
                    });

                } else {
                    state.view = 'auth'; render();
                }
            });
        } catch(error) {
            appDiv.innerHTML = `<div class="max-w-2xl mx-auto mt-20 p-8 bg-red-900/30 border border-red-500 text-red-200 rounded-xl">Firebase Fehler: ${error.message}</div>`;
        }

        function checkRouting() {
            if (!state.user || !state.profile) return;
            if (state.profile.isAdmin && state.view !== 'admin') {
                state.view = 'admin';
            } else if (!state.profile.isAdmin) {
                if(!state.currentDrop) state.view = 'nodrop';
                else if(state.view === 'loading' || state.view === 'auth' || state.view === 'nodrop') {
                    state.view = state.hasTicket ? 'ticket' : 'home';
                }
            }
            render();
        }

        function scrollToBottom() {
            setTimeout(() => {
                const chatBox = document.getElementById('chat_messages');
                if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
            }, 50);
        }

        // --- AUTH & NAVIGATION ---
        window.setView = (view) => { state.errorMsg = null; state.view = view; render(); };
        window.toggleAuthMode = () => { state.authMode = state.authMode === 'login' ? 'register' : 'login'; state.errorMsg = null; render(); };
        window.handleAuth = async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth_email').value;
            const pass = document.getElementById('auth_pass').value;
            try {
                if (state.authMode === 'login') await signInWithEmailAndPassword(auth, email, pass);
                else await createUserWithEmailAndPassword(auth, email, pass);
            } catch (err) { state.errorMsg = err.message; render(); }
        };
        window.handleLogout = () => { signOut(auth); };

        // --- ADMIN LOGIN (SECRET CLICK) ---
        window.handleLogoClick = async () => {
            state.logoClicks++;
            if (state.logoClicks === 5) {
                state.logoClicks = 0;
                const pwd = prompt("Director's Password:");
                if (pwd === "director2026") {
                    await setDoc(doc(db, 'plot_users', state.user.uid), { isAdmin: true }, { merge: true });
                    alert("Admin Access Granted.");
                }
            }
        };

        // --- ADMIN FUNKTIONEN ---
        window.createDrop = async (e) => {
            e.preventDefault();
            if(!state.profile.isAdmin) return;
            
            // Erst alle alten auf inaktiv setzen
            const snap = await getDocs(collection(db, 'plot_drops'));
            snap.forEach(async (d) => { await updateDoc(d.ref, { isActive: false }); });

            const questsArray = document.getElementById('admin_quests').value.split('\n').filter(q => q.trim() !== '');

            const newDrop = {
                id: 'drop_' + Date.now(),
                title: document.getElementById('admin_title').value,
                vibe: document.getElementById('admin_vibe').value,
                blurLocation: document.getElementById('admin_blurloc').value,
                exactLocation: document.getElementById('admin_exactloc').value,
                timeText: document.getElementById('admin_time').value,
                spotsLeft: parseInt(document.getElementById('admin_spots').value),
                prop: document.getElementById('admin_prop').value,
                secretDrink: document.getElementById('admin_drink').value,
                quests: questsArray,
                isActive: true,
                phase: 'lobby', // lobby, live, credits
                activeQuestIndex: 0
            };

            await setDoc(doc(db, 'plot_drops', newDrop.id), newDrop);
            alert("Neues Ticket / Szene live geschaltet!");
        };

        window.setPhaseLive = async (phase) => {
            if(!state.profile.isAdmin || !state.currentDrop) return;
            await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), { phase: phase });
        };

        window.nextQuestLive = async () => {
            if(!state.profile.isAdmin || !state.currentDrop) return;
            const nextIdx = state.currentDrop.activeQuestIndex + 1;
            if(nextIdx < state.currentDrop.quests.length) {
                await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), { activeQuestIndex: nextIdx });
            }
        };

        // --- USER FUNKTIONEN ---
        window.claimTicket = async () => {
            if (!state.profile.hasPremium) {
                state.view = 'paywall'; render();
                setTimeout(() => {
                    if (window.paypal) {
                        document.getElementById('paypal-button-container').innerHTML = '';
                        paypal.Buttons({
                            createOrder: (data, actions) => actions.order.create({ purchase_units: [{ description: "The Plot Premium", amount: { currency_code: "EUR", value: "49.00" } }] }),
                            onApprove: (data, actions) => actions.order.capture().then((details) => window.unlockPremium())
                        }).render('#paypal-button-container');
                    } else {
                        document.getElementById('paypal-button-container').innerHTML = `<button onclick="window.unlockPremium()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-4 rounded-xl transition text-sm uppercase tracking-widest shadow-[0_0_20px_rgba(217,119,6,0.4)]">[Demo] Freischalten</button>`;
                    }
                }, 100);
            } else {
                const newTickets = [...(state.profile.tickets || []), state.currentDrop.id];
                await setDoc(doc(db, 'plot_users', state.user.uid), { tickets: newTickets }, { merge: true });
                // Verringere Spots
                await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), { spotsLeft: Math.max(0, state.currentDrop.spotsLeft - 1) });
                state.hasTicket = true; state.view = 'ticket'; render();
            }
        };

        window.unlockPremium = async () => {
            await setDoc(doc(db, 'plot_users', state.user.uid), { hasPremium: true }, { merge: true });
            state.view = 'home'; render(); alert("Director's Cut unlocked.");
        };

        window.sendMessage = async () => {
            const input = document.getElementById('chat_input');
            const text = input.value.trim();
            if (!text || !state.currentDrop) return;
            try {
                await addDoc(collection(db, `plot_messages_${state.currentDrop.id}`), {
                    senderId: state.user.uid, senderAlias: state.profile.alias || 'Stranger', text: text, timestamp: Date.now()
                });
                input.value = ''; scrollToBottom();
            } catch (e) { console.error(e); }
        };

        window.submitCredits = () => {
            alert("Deine Auswahl wurde anonym gespeichert. Falls es ein Match gibt, wird der Chat für euch freigeschaltet!");
            window.setView('ticket');
        };


        // --- UI RENDERER ---
        function render() {
            if (state.view === 'loading') return;

            let html = `
                <nav class="p-6 flex justify-between items-center max-w-5xl mx-auto w-full z-20">
                    <div onclick="window.handleLogoClick()" class="text-2xl font-black tracking-tighter serif italic text-zinc-100 cursor-pointer select-none">The Plot.</div>
                    <div class="text-xs uppercase tracking-widest text-zinc-500 font-semibold flex items-center gap-4">
                        ${state.profile?.isAdmin ? "<span class='text-red-500'>Director</span>" : state.profile?.hasPremium ? "<span class='text-amber-500'>Director's Cut</span>" : ""}
                        ${state.user ? `<button onclick="window.handleLogout()" class="hover:text-white transition">Exit</button>` : ''}
                    </div>
                </nav>
                <div class="max-w-lg mx-auto px-4 w-full flex-1 flex flex-col justify-center z-20">
            `;

            if (state.errorMsg) html += `<div class="bg-red-900/30 border border-red-500/50 text-red-200 p-4 rounded-lg mb-6 text-sm">${state.errorMsg}</div>`;

            // --- ADMIN DASHBOARD ---
            if (state.view === 'admin') {
                html += `
                    <div class="mb-8">
                        <h1 class="text-3xl serif italic mb-2 text-red-500">Director's Dashboard</h1>
                        <p class="text-zinc-400 text-sm">Erschaffe Szenen. Kontrolliere das Pacing.</p>
                    </div>

                    ${state.currentDrop ? `
                        <div class="bg-red-900/20 border border-red-500/30 p-6 rounded-2xl mb-8">
                            <h3 class="font-bold text-white mb-4">Live-Kontrolle: ${state.currentDrop.title}</h3>
                            <div class="flex gap-2 mb-4">
                                <button onclick="window.setPhaseLive('lobby')" class="flex-1 py-2 text-xs font-bold uppercase rounded ${state.currentDrop.phase === 'lobby' ? 'bg-red-600 text-white' : 'bg-zinc-800 text-zinc-400'}">1. Lobby</button>
                                <button onclick="window.setPhaseLive('live')" class="flex-1 py-2 text-xs font-bold uppercase rounded ${state.currentDrop.phase === 'live' ? 'bg-red-600 text-white' : 'bg-zinc-800 text-zinc-400'}">2. Live Date</button>
                                <button onclick="window.setPhaseLive('credits')" class="flex-1 py-2 text-xs font-bold uppercase rounded ${state.currentDrop.phase === 'credits' ? 'bg-red-600 text-white' : 'bg-zinc-800 text-zinc-400'}">3. Credits</button>
                            </div>
                            ${state.currentDrop.phase === 'live' ? `
                                <div class="bg-zinc-900 p-4 rounded-xl border border-zinc-700">
                                    <p class="text-xs text-amber-500 mb-2 font-bold uppercase">Aktuelle Quest auf allen Handys:</p>
                                    <p class="text-sm italic mb-4">"${state.currentDrop.quests[state.currentDrop.activeQuestIndex]}"</p>
                                    <button onclick="window.nextQuestLive()" class="w-full bg-amber-600 text-white py-2 rounded text-xs font-bold uppercase">Nächste Quest triggern</button>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    <div class="bg-zinc-900/80 p-8 rounded-3xl border border-zinc-800">
                        <h2 class="text-xl serif italic mb-6">Neue Szene (Drop) erschaffen</h2>
                        <form onsubmit="window.createDrop(event)" class="space-y-4 text-sm">
                            <input id="admin_title" required placeholder="Titel (z.B. Midnight Matcha)" class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-red-500">
                            <textarea id="admin_vibe" required placeholder="Vibe (Atmosphäre beschreiben)" class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-red-500 h-20"></textarea>
                            <input id="admin_blurloc" required placeholder="Verschwommene Location (z.B. Café, Belgisches Viertel)" class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-red-500">
                            <input id="admin_exactloc" required placeholder="Genaue Adresse & Tisch" class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-red-500">
                            <div class="flex gap-2">
                                <input id="admin_time" required placeholder="Zeit (z.B. Heute, 20 Uhr)" class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-red-500">
                                <input id="admin_spots" type="number" required placeholder="Plätze (z.B. 4)" class="w-32 p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-red-500">
                            </div>
                            <input id="admin_prop" required placeholder="Requisite (z.B. Bring ein Buch mit)" class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-red-500">
                            <input id="admin_drink" required placeholder="Geheimpasswort / Drink" class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-red-500">
                            <div>
                                <label class="text-xs text-zinc-500 block mb-1">Side Quests (1 pro Zeile, Icebreaker ganz oben)</label>
                                <textarea id="admin_quests" required class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-red-500 h-32"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-white text-black font-bold py-3 rounded mt-4">Drop veröffentlichen</button>
                        </form>
                    </div>
                `;
            }
            // --- KEIN DROP AKTIV ---
            else if (state.view === 'nodrop') {
                html += `
                    <div class="text-center">
                        <div class="w-16 h-16 mx-auto bg-zinc-900 rounded-full flex items-center justify-center mb-6 border border-zinc-800"><svg class="w-6 h-6 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg></div>
                        <h1 class="text-3xl serif italic mb-3">Keine aktiven Szenen.</h1>
                        <p class="text-zinc-500 text-sm">Der nächste Drop wird bald enthüllt. Schalte deine Push-Benachrichtigungen ein.</p>
                    </div>
                `;
            }
            // --- LOGIN ---
            else if (state.view === 'auth') {
                html += `
                    <div class="text-center mb-10">
                        <h1 class="text-4xl serif italic mb-3">Claim your storyline.</h1>
                        <p class="text-zinc-400 text-sm leading-relaxed">Solo-Dates ohne sozialen Druck.<br>Versteckte Orte. Echte Begegnungen.</p>
                    </div>
                    <form onsubmit="window.handleAuth(event)" class="space-y-4">
                        <input id="auth_email" type="email" placeholder="Email" required class="w-full p-4 bg-zinc-900/50 border border-zinc-800 rounded-xl outline-none focus:border-amber-500/50 text-zinc-200">
                        <input id="auth_pass" type="password" placeholder="Password" required minlength="6" class="w-full p-4 bg-zinc-900/50 border border-zinc-800 rounded-xl outline-none focus:border-amber-500/50 text-zinc-200">
                        <button type="submit" class="w-full bg-zinc-100 text-zinc-900 hover:bg-white font-bold py-4 rounded-xl transition text-sm uppercase tracking-widest mt-4">${state.authMode === 'login' ? 'Enter' : 'Join the Cast'}</button>
                    </form>
                    <button onclick="window.toggleAuthMode()" class="w-full text-center mt-6 text-xs text-zinc-500 hover:text-zinc-300 uppercase tracking-widest">${state.authMode === 'login' ? 'Apply for membership' : 'Already cast? Login'}</button>
                `;
            }
            // --- DROP ANSICHT (TICKET KAUFEN) ---
            else if (state.view === 'home') {
                html += `
                    <div class="mb-4 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                        <span class="text-xs uppercase tracking-widest text-red-500 font-bold">Current Drop</span>
                    </div>
                    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-8 backdrop-blur-sm relative overflow-hidden group">
                        <div class="absolute inset-0 opacity-20 bg-[url('https://images.unsplash.com/photo-1511556820780-d912e42b4980?auto=format&fit=crop&q=80')] bg-cover bg-center transition duration-700 group-hover:scale-105 group-hover:opacity-30"></div>
                        <div class="relative z-10">
                            <h2 class="text-4xl serif italic mb-2">${state.currentDrop.title}</h2>
                            <p class="text-zinc-400 text-sm mb-8 leading-relaxed">"${state.currentDrop.vibe}"</p>
                            <div class="space-y-3 mb-10">
                                <div class="flex justify-between items-center text-sm border-b border-zinc-800/50 pb-3"><span class="text-zinc-500 uppercase tracking-widest text-xs">Location</span><span class="text-zinc-300 flex items-center gap-2"><svg class="w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> Locked</span></div>
                                <div class="flex justify-between items-center text-sm border-b border-zinc-800/50 pb-3"><span class="text-zinc-500 uppercase tracking-widest text-xs">Time</span><span class="text-zinc-300">${state.currentDrop.timeText}</span></div>
                                <div class="flex justify-between items-center text-sm"><span class="text-zinc-500 uppercase tracking-widest text-xs">Capacity</span><span class="text-amber-500 font-bold">${state.currentDrop.spotsLeft} Spots left</span></div>
                            </div>
                            <button onclick="window.claimTicket()" ${state.currentDrop.spotsLeft === 0 ? 'disabled' : ''} class="w-full ${state.currentDrop.spotsLeft === 0 ? 'bg-zinc-800 text-zinc-500' : 'bg-zinc-100 text-zinc-900 hover:bg-white shadow-[0_0_20px_rgba(255,255,255,0.1)]'} font-bold py-4 rounded-xl transition text-sm uppercase tracking-widest">${state.currentDrop.spotsLeft === 0 ? 'Sold Out' : 'Claim Ticket'}</button>
                        </div>
                    </div>
                `;
            }
            // --- PAYWALL ---
            else if (state.view === 'paywall') {
                html += `
                    <div class="text-center mb-8">
                        <h1 class="text-3xl serif italic mb-3">Join the Director's Cut</h1>
                        <p class="text-zinc-400 text-sm leading-relaxed">Sichere dir Exklusivität. Garantiert keine Oberflächlichkeit. Echte Begegnungen.</p>
                    </div>
                    <div class="bg-zinc-900/80 border border-zinc-800 rounded-3xl p-8 backdrop-blur-md mb-6">
                        <div class="text-4xl font-light text-center mb-6 serif italic">49€ <span class="text-sm font-sans text-zinc-500 not-italic">/ month</span></div>
                        <ul class="space-y-4 text-sm text-zinc-300 mb-8">
                            <li class="flex items-center gap-3"><svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> 4 Secret Drop Tickets pro Monat</li>
                            <li class="flex items-center gap-3"><svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Icebreakers & Live Quests vor Ort</li>
                        </ul>
                        <div id="paypal-button-container" class="w-full min-h-[150px]"></div>
                    </div>
                    <button onclick="window.setView('home')" class="w-full text-center text-xs text-zinc-500 hover:text-zinc-300 uppercase tracking-widest">Maybe later</button>
                `;
            }
            // --- TICKET ---
            else if (state.view === 'ticket') {
                html += `
                    <div class="text-center mb-8 animate-fade-in">
                        <h1 class="text-3xl serif italic mb-2 gold-text">Your Scene is Ready.</h1>
                        <p class="text-zinc-400 text-sm">You are the main character. Go alone. Embrace the plot.</p>
                    </div>
                    
                    <div class="bg-[#e4e4e7] text-zinc-900 rounded-xl ticket-cutout p-8 relative shadow-2xl mx-4 transform rotate-1 transition hover:rotate-0 duration-500">
                        <div class="absolute right-6 top-1/2 -translate-y-1/2 flex flex-col items-end opacity-20 pointer-events-none"><div class="w-1 h-32 bg-black mb-1"></div><div class="w-2 h-32 bg-black mb-1"></div><div class="w-0.5 h-32 bg-black mb-1"></div><div class="w-3 h-32 bg-black"></div></div>
                        <div class="uppercase tracking-widest text-[10px] text-zinc-500 font-bold mb-1">Admit One</div>
                        <h2 class="text-3xl serif italic font-black mb-6">${state.currentDrop.title}</h2>
                        <div class="space-y-4 mb-8">
                            <div>
                                <div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold mb-1">Location</div>
                                ${state.currentDrop.phase === 'lobby' 
                                    ? `<div class="font-semibold text-sm blur-reveal" title="Wird kurz vorher freigeschaltet">${state.currentDrop.blurLocation}</div><div class="text-xs text-red-500 mt-1 font-bold">Unlocks later</div>` 
                                    : `<div class="font-bold text-amber-700 leading-tight">${state.currentDrop.exactLocation}</div>`}
                            </div>
                            
                            ${state.currentDrop.phase !== 'lobby' ? `
                                <div class="bg-white/50 p-3 rounded-lg border border-black/10"><div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold mb-1">Your Prop (Requisite)</div><div class="font-semibold text-sm italic">${state.currentDrop.prop}</div></div>
                                <div class="bg-white/50 p-3 rounded-lg border border-black/10"><div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold mb-1">Secret Password</div><div class="font-semibold text-sm italic">${state.currentDrop.secretDrink}</div></div>
                            ` : ''}

                            <div class="flex justify-between pt-2 border-t border-black/10">
                                <div><div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold">Time</div><div class="font-semibold">${state.currentDrop.timeText}</div></div>
                                <div class="text-right"><div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold">Your Alias</div><div class="font-semibold italic text-amber-700">${state.profile?.alias}</div></div>
                            </div>
                        </div>
                    </div>

                    ${state.currentDrop.phase === 'lobby' ? `<button onclick="window.setView('room')" class="mt-10 w-full bg-zinc-800 border border-zinc-700 hover:bg-zinc-700 text-white font-bold py-4 rounded-xl transition text-sm uppercase tracking-widest">Lobby Chat öffnen</button>` 
                    : state.currentDrop.phase === 'live' ? `<button onclick="window.setView('room')" class="mt-10 w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-4 rounded-xl transition shadow-[0_0_20px_rgba(217,119,6,0.4)] text-sm uppercase tracking-widest animate-pulse">Start Live Scene</button>` 
                    : `<button onclick="window.setView('room')" class="mt-10 w-full bg-white text-black font-bold py-4 rounded-xl transition text-sm uppercase tracking-widest">View Credits</button>`}
                `;
            }
            // --- ROOM (LOBBY / LIVE / CREDITS) ---
            else if (state.view === 'room') {
                if (state.currentDrop.phase === 'lobby') {
                    html += `
                        <div class="absolute inset-0 flex flex-col bg-[#09090b] z-50">
                            <div class="p-6 border-b border-zinc-800/50 flex justify-between items-center backdrop-blur-md bg-zinc-900/50">
                                <div><h3 class="font-bold text-zinc-100 serif italic text-xl">The Lobby</h3><div class="text-[10px] uppercase tracking-widest text-amber-500 font-bold mt-1">Chat ends at start</div></div>
                                <button onclick="window.setView('ticket')" class="text-zinc-500 hover:text-white uppercase tracking-widest text-xs font-bold">Leave</button>
                            </div>
                            <div id="chat_messages" class="flex-1 overflow-y-auto p-6 chat-scroll flex flex-col gap-6 bg-gradient-to-b from-transparent to-zinc-900/50">
                                <div class="text-center my-4"><span class="bg-zinc-800 text-zinc-400 text-[10px] uppercase tracking-widest px-4 py-2 rounded-full border border-zinc-700/50">Anonymous connection to the cast.</span></div>
                                ${state.messages.map(msg => { const isMe = msg.senderId === state.user?.uid; return `<div class="max-w-[85%] ${isMe ? 'self-end text-right' : 'self-start'}"><div class="text-[10px] uppercase tracking-widest ${isMe ? 'text-amber-500/70' : 'text-zinc-500'} mb-1 font-bold">${isMe ? 'You' : msg.senderAlias}</div><div class="${isMe ? 'bg-amber-900/20 text-amber-50 border border-amber-900/30' : 'bg-zinc-800/50 text-zinc-200 border border-zinc-700/50'} p-4 rounded-2xl ${isMe ? 'rounded-tr-sm' : 'rounded-tl-sm'} shadow-sm text-sm font-medium leading-relaxed backdrop-blur-sm">${msg.text}</div></div>`; }).join('')}
                            </div>
                            <div class="p-4 bg-zinc-900/80 border-t border-zinc-800/50 backdrop-blur-md pb-8">
                                <div class="flex gap-2 relative max-w-lg mx-auto"><input id="chat_input" type="text" class="flex-1 p-4 bg-zinc-950/50 rounded-xl border border-zinc-800 outline-none focus:border-amber-500/50 text-zinc-200 transition" placeholder="Whisper something..." onkeypress="if(event.key === 'Enter') window.sendMessage()"><button onclick="window.sendMessage()" class="bg-zinc-100 text-zinc-900 px-6 rounded-xl font-bold hover:bg-white transition">➔</button></div>
                            </div>
                        </div>
                    `;
                } else if (state.currentDrop.phase === 'live') {
                    const quest = state.currentDrop.quests[state.currentDrop.activeQuestIndex] || "Keine Quests verfügbar.";
                    const isLast = state.currentDrop.activeQuestIndex >= state.currentDrop.quests.length - 1;
                    
                    html += `
                        <div class="absolute inset-0 flex flex-col bg-[#09090b] z-50 items-center justify-center p-6 text-center">
                            <button onclick="window.setView('ticket')" class="absolute top-8 right-8 text-zinc-500 hover:text-white uppercase tracking-widest text-xs font-bold">Ticket ansehen</button>
                            <div class="mb-12"><h2 class="text-4xl serif italic mb-3 gold-text">Action.</h2><p class="text-zinc-400 text-sm">Die Szene läuft. Legt die Handys weg und sprecht miteinander.</p></div>
                            <div class="w-full max-w-sm bg-zinc-900/80 border border-zinc-700/50 rounded-3xl p-10 backdrop-blur-md shadow-[0_0_40px_rgba(0,0,0,0.5)]">
                                <div class="text-[10px] uppercase tracking-widest text-amber-500 font-bold mb-6 animate-pulse">Live Side Quest ${(state.currentDrop.activeQuestIndex || 0) + 1}</div>
                                <h3 class="text-2xl serif italic text-white leading-relaxed mb-8">${quest}</h3>
                                <div class="text-[10px] uppercase tracking-widest text-zinc-500">${isLast ? 'Genießt den restlichen Abend.' : 'Wartet auf die nächste Anweisung des Directors.'}</div>
                            </div>
                        </div>
                    `;
                } else if (state.currentDrop.phase === 'credits') {
                    html += `
                        <div class="absolute inset-0 flex flex-col bg-[#09090b] z-50 p-6 overflow-y-auto pb-20">
                            <button onclick="window.setView('ticket')" class="absolute top-8 right-8 text-zinc-500 hover:text-white uppercase tracking-widest text-xs font-bold">Close</button>
                            <div class="text-center mt-16 mb-12"><h2 class="text-4xl serif italic mb-3">The End.</h2><p class="text-zinc-400 text-sm">Cut! Wer war in deiner Szene? Wähle anonym aus, wen du für eine Fortsetzung wiedersehen möchtest.</p></div>
                            <div class="max-w-sm mx-auto w-full space-y-4">
                                ${ALIASES.filter(a => a !== (state.profile?.alias || 'The Stranger')).slice(0, 3).map(alias => `<label class="flex items-center justify-between p-5 border border-zinc-800 rounded-2xl cursor-pointer hover:bg-zinc-900 transition group"><span class="text-lg serif italic text-zinc-300 group-hover:text-amber-500 transition">${alias}</span><input type="checkbox" class="w-5 h-5 accent-amber-500 bg-zinc-900 border-zinc-700 rounded"></label>`).join('')}
                                <button onclick="window.submitCredits()" class="w-full bg-zinc-100 text-black font-bold py-4 rounded-xl mt-8 uppercase tracking-widest text-sm shadow-[0_0_20px_rgba(255,255,255,0.1)] hover:bg-white transition">Credits rollen</button>
                            </div>
                        </div>
                    `;
                }
            }

            html += `</div>`;
            appDiv.innerHTML = html;
        }
    </script>
</body>
</html>


