<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EquiMatch | Wahres Potenzial erkennen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=AdWPwOjuX1h1gYLtvpb63&currency=EUR"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

    <div id="app" class="pb-12">
        <div class="text-center mt-20 text-teal-600 font-bold animate-pulse">Lade EquiMatch...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDzN7StXcxZVkYcs3pQBh1rAYypqKF54PE",
          authDomain: "equimatch-a9a03.firebaseapp.com",
          projectId: "equimatch-a9a03",
          storageBucket: "equimatch-a9a03.firebasestorage.app",
          messagingSenderId: "1064864391538",
          appId: "1:1064864391538:web:ceeca48c28a9e7a63f3deb",
          measurementId: "G-8RGBYGNGED"
        };

        let appInit, auth, db;
        let state = { 
            user: null, 
            view: 'loading', 
            role: null, 
            profile: null, 
            talents: [], 
            companies: [], 
            applications: [], 
            messages: [], // NEU: Nachrichten-Speicher
            applyingTo: null, 
            activeChatAppId: null, // NEU: Welcher Chat ist offen?
            showVerifyModal: false, // NEU: Verifizierungs-Fenster
            verifyStep: 0, // 0 = Eingabe, 1 = Scannen, 2 = Analyse
            errorMsg: null, 
            showPaywall: false,
            authMode: 'login'
        };

        const appDiv = document.getElementById('app');

        try {
            appInit = initializeApp(firebaseConfig);
            auth = getAuth(appInit);
            db = getFirestore(appInit);
            
            onAuthStateChanged(auth, (user) => {
                state.user = user;
                if (user) loadData();
                else { state.view = 'auth'; render(); }
            });

        } catch(error) {
            appDiv.innerHTML = `<div class="max-w-2xl mx-auto mt-20 p-8 bg-red-50 text-red-700 rounded-xl font-bold">Systemfehler: ${error.message}</div>`;
        }

        function loadData() {
            try {
                onSnapshot(collection(db, 'talents'), (snap) => {
                    state.talents = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    checkProfile(); render();
                });
                onSnapshot(collection(db, 'companies'), (snap) => {
                    state.companies = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    checkProfile(); render();
                });
                onSnapshot(collection(db, 'applications'), (snap) => {
                    state.applications = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    render();
                });
                // NEU: Nachrichten laden
                onSnapshot(collection(db, 'messages'), (snap) => {
                    state.messages = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    if (state.activeChatAppId) render(); // Re-render if chat open
                });
            } catch(e) { console.error(e); }
        }

        function checkProfile() {
            if (!state.user) return;
            const myTalent = state.talents.find(t => t.uid === state.user.uid);
            const myCompany = state.companies.find(c => c.uid === state.user.uid);
            if (myTalent) { state.profile = myTalent; state.role = 'talent'; state.view = 'dashboard'; }
            else if (myCompany) { state.profile = myCompany; state.role = 'company'; state.view = 'dashboard'; }
            else if (state.view === 'loading') { state.view = 'role_select'; }
        }

        // --- AUTH & NAVIGATION ---
        window.setView = (view) => { state.errorMsg = null; state.view = view; render(); };
        window.toggleAuthMode = () => { state.authMode = state.authMode === 'login' ? 'register' : 'login'; state.errorMsg = null; render(); };
        
        window.handleAuth = async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth_email').value;
            const pass = document.getElementById('auth_pass').value;
            try {
                if (state.authMode === 'login') await signInWithEmailAndPassword(auth, email, pass);
                else await createUserWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                state.errorMsg = "Authentifizierungs-Fehler: " + err.message; render();
            }
        };

        window.handleLogout = () => { signOut(auth); };

        // --- PROFILE SPEICHERN ---
        window.saveTalent = async () => {
            if (!state.user) return;
            try {
                const data = {
                    uid: state.user.uid,
                    superpower: document.getElementById('t_superpower').value,
                    background: document.getElementById('t_background').value,
                    skills: document.getElementById('t_skills').value,
                    health: document.getElementById('t_health').value,
                    about: document.getElementById('t_about').value,
                    redFlags: document.getElementById('t_redflags').value,
                    verified: state.profile?.verified || false
                };
                if(!data.superpower || !data.background) throw new Error("Bitte fülle die Hauptfelder aus.");
                await setDoc(doc(db, 'talents', state.user.uid), data);
            } catch (error) { state.errorMsg = error.message; render(); }
        };

        window.saveCompany = async () => {
            if (!state.user) return;
            try {
                const data = {
                    uid: state.user.uid,
                    name: document.getElementById('c_name').value,
                    culture: document.getElementById('c_culture').value,
                    openness: document.getElementById('c_openness').value,
                    perks: document.getElementById('c_perks').value,
                    credits: state.profile?.credits ?? 3
                };
                await setDoc(doc(db, 'companies', state.user.uid), data);
            } catch (error) { state.errorMsg = error.message; render(); }
        };

        // --- NEU: VERIFIZIERUNG ---
        window.openVerifyModal = () => {
            state.showVerifyModal = true;
            state.verifyStep = 0;
            render();
        };
        window.closeVerifyModal = () => { state.showVerifyModal = false; render(); };
        
        window.runVerification = () => {
            const link = document.getElementById('v_link').value;
            if (!link) { alert("Bitte gib einen Link ein."); return; }
            
            state.verifyStep = 1; render(); // "Scanne..."
            
            setTimeout(() => {
                state.verifyStep = 2; render(); // "Analysiere non-traditionelle Zertifikate..."
            }, 2000);
            
            setTimeout(async () => {
                await setDoc(doc(db, 'talents', state.user.uid), { verified: true }, { merge: true });
                state.showVerifyModal = false;
                alert("Erfolgreich! Deine interkulturellen und non-traditionellen Fähigkeiten wurden geprüft und verifiziert.");
                render();
            }, 4500);
        };

        // --- NEU: CHAT SYSTEM ---
        window.openChat = (appId) => {
            state.activeChatAppId = appId; render();
            // Scroll to bottom
            setTimeout(() => {
                const chatBox = document.getElementById('chat_messages');
                if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
            }, 100);
        };
        
        window.closeChat = () => { state.activeChatAppId = null; render(); };
        
        window.sendMessage = async () => {
            if (!state.user || !state.activeChatAppId) return;
            const input = document.getElementById('chat_input');
            const text = input.value.trim();
            if (!text) return;
            
            try {
                await addDoc(collection(db, 'messages'), {
                    applicationId: state.activeChatAppId,
                    senderId: state.user.uid,
                    senderName: state.profile.name || state.profile.superpower || 'Talent',
                    text: text,
                    timestamp: Date.now()
                });
                input.value = '';
                // Auto-scroll
                setTimeout(() => {
                    const chatBox = document.getElementById('chat_messages');
                    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
                }, 100);
            } catch (e) { alert("Fehler beim Senden."); }
        };

        // --- MONETARISIERUNG & ANFRAGEN ---
        window.openPaywall = () => {
            state.showPaywall = true; render();
            setTimeout(() => {
                if (window.paypal) {
                    document.getElementById('paypal-button-container').innerHTML = '';
                    paypal.Buttons({
                        createOrder: (data, actions) => actions.order.create({ purchase_units: [{ description: "EquiMatch Premium", amount: { currency_code: "EUR", value: "99.00" } }] }),
                        onApprove: (data, actions) => actions.order.capture().then((details) => window.completePremiumPurchase(details.payer.name.given_name)),
                        onError: (err) => { state.errorMsg = "PayPal Fehler: " + err; render(); }
                    }).render('#paypal-button-container');
                }
            }, 100);
        };

        window.completePremiumPurchase = async (payerName) => {
            await setDoc(doc(db, 'companies', state.user.uid), { credits: 999 }, { merge: true });
            state.showPaywall = false;
            alert("Zahlung erfolgreich. Premium aktiviert!"); render();
        };

        window.openApplyModal = (talentId) => {
            if (state.profile.credits <= 0) { window.openPaywall(); return; }
            state.applyingTo = talentId; state.errorMsg = null; render();
        };

        window.closeApplyModal = () => { state.applyingTo = null; state.showPaywall = false; state.errorMsg = null; render(); };

        window.submitApplication = async () => {
            const msg = document.getElementById('apply_message').value;
            if (!msg) { state.errorMsg = "Nachricht fehlt."; render(); return; }
            try {
                document.getElementById('apply_btn').innerText = "Sende...";
                await addDoc(collection(db, 'applications'), { companyId: state.user.uid, companyName: state.profile.name, talentId: state.applyingTo, message: msg, status: 'pending' });
                await setDoc(doc(db, 'companies', state.user.uid), { credits: state.profile.credits - 1 }, { merge: true });
                state.applyingTo = null; state.errorMsg = null; render();
            } catch (error) { state.errorMsg = error.message; render(); }
        };

        // --- UI RENDERER ---
        function render() {
            if (state.view === 'loading') return;

            let html = `
                <nav class="bg-white p-4 shadow-sm flex justify-between items-center mb-8 border-b border-teal-100 sticky top-0 z-10">
                    <div class="text-xl font-bold text-teal-700 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                        EquiMatch
                    </div>
                    <div class="text-sm font-medium text-slate-600 flex items-center gap-4">
                        ${state.role === 'company' ? `<span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-xs font-bold">Credits: ${state.profile?.credits > 100 ? '∞' : (state.profile?.credits || 0)}</span>` : ''}
                        ${state.user ? `<span>Eingeloggt als ${state.user.email}</span> <button onclick="window.handleLogout()" class="text-xs text-red-500 hover:underline">Logout</button>` : ''}
                    </div>
                </nav>
                <div class="max-w-5xl mx-auto px-4">
            `;

            if (state.errorMsg) {
                html += `<div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-sm mb-6 font-medium">${state.errorMsg}</div>`;
            }

            // 1. LOGIN / REGISTER SCREEN
            if (state.view === 'auth') {
                html += `
                    <div class="max-w-md mx-auto bg-white p-8 rounded-3xl shadow-xl mt-10">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-slate-800">${state.authMode === 'login' ? 'Willkommen zurück' : 'Account erstellen'}</h2>
                            <p class="text-slate-500 mt-2">Der Jobmarkt für wahre Potenziale.</p>
                        </div>
                        <form onsubmit="window.handleAuth(event)" class="space-y-4">
                            <div><label class="block text-sm font-semibold mb-1">E-Mail Adresse</label><input id="auth_email" type="email" required class="w-full p-3 bg-slate-50 rounded-xl border outline-none focus:ring-2 focus:ring-teal-500"></div>
                            <div><label class="block text-sm font-semibold mb-1">Passwort</label><input id="auth_pass" type="password" required minlength="6" class="w-full p-3 bg-slate-50 rounded-xl border outline-none focus:ring-2 focus:ring-teal-500"></div>
                            <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-xl transition">${state.authMode === 'login' ? 'Einloggen' : 'Registrieren'}</button>
                        </form>
                        <div class="text-center mt-6">
                            <button onclick="window.toggleAuthMode()" class="text-sm text-teal-600 hover:underline font-medium">${state.authMode === 'login' ? 'Noch kein Account? Hier registrieren' : 'Schon ein Account? Hier einloggen'}</button>
                        </div>
                    </div>
                `;
            }
            // 2. ROLLE WÄHLEN
            else if (state.view === 'role_select') {
<!-- ... (gleicher Code wie vorher) ... -->
                html += `
                    <div class="text-center mb-12 mt-10">
                        <h1 class="text-4xl font-extrabold text-slate-800 mb-4">Lass uns dein Profil einrichten</h1>
                        <p class="text-slate-500 text-lg">Wer bist du auf EquiMatch?</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                        <button onclick="window.setView('talent')" class="p-10 bg-white rounded-2xl shadow-sm border border-slate-200 hover:border-teal-500 transition text-left group">
                            <h2 class="text-2xl font-bold mb-2 text-slate-800">Talent</h2>
                            <p class="text-slate-500">Ich suche ein gesundes Arbeitsumfeld, das meine echten Fähigkeiten schätzt.</p>
                        </button>
                        <button onclick="window.setView('company')" class="p-10 bg-white rounded-2xl shadow-sm border border-slate-200 hover:border-indigo-500 transition text-left group">
                            <h2 class="text-2xl font-bold mb-2 text-slate-800">Unternehmen</h2>
                            <p class="text-slate-500">Wir suchen Talente abseits vom Mainstream und bieten eine gesunde Kultur.</p>
                        </button>
                    </div>
                `;
            }
            // 3. DEEP PROFILING: TALENT
            else if (state.view === 'talent') {
<!-- ... (gleicher Code wie vorher) ... -->
                html += `
                    <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-100 max-w-2xl mx-auto mb-20">
                        <h2 class="text-3xl font-bold mb-2 text-slate-800">Dein Deep-Profile</h2>
                        <p class="text-slate-500 mb-8">Wir pfeifen auf starre Ausbildungsberufe. Zeig uns, was du *wirklich* kannst.</p>
                        
                        <div class="space-y-6">
                            <div class="bg-teal-50 p-5 rounded-2xl border border-teal-100">
                                <label class="block text-sm font-bold text-teal-900 mb-2">Deine "Superkraft" (Statt starrer Jobtitel)</label>
                                <input id="t_superpower" type="text" value="${state.profile?.superpower || ''}" class="w-full p-3 rounded-xl border-none outline-none focus:ring-2 focus:ring-teal-500 shadow-sm" placeholder="z.B. Interkulturelle Kommunikation">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Dein einzigartiger Hintergrund</label>
                                <textarea id="t_background" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 h-24 outline-none focus:ring-2 focus:ring-teal-500" placeholder="Z.B. Modern Cultures (Durham) & British Council Programm...">${state.profile?.background || ''}</textarea>
                            </div>
                            <div><label class="block text-sm font-semibold text-slate-700 mb-2">Hard & Soft Skills (Komma-getrennt)</label><input id="t_skills" type="text" value="${state.profile?.skills || ''}" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none" placeholder="Z.B. Textanalyse, Empathie, Englisch C2"></div>
                            <div class="h-px bg-slate-200 my-6"></div>
                            <div><label class="block text-sm font-semibold text-slate-700 mb-2">Wichtigkeit Mentale Gesundheit (1-10)</label><input id="t_health" type="range" min="1" max="10" value="${state.profile?.health || 8}" class="w-full accent-teal-600"></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-semibold text-slate-700 mb-2">Was du brauchst (Needs)</label><textarea id="t_about" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 h-24">${state.profile?.about || ''}</textarea></div>
                                <div><label class="block text-sm font-semibold text-slate-700 mb-2">Red Flags (No-Gos)</label><textarea id="t_redflags" class="w-full p-3 bg-red-50 rounded-xl border border-red-200 h-24 text-red-900">${state.profile?.redFlags || ''}</textarea></div>
                            </div>
                        </div>
                        <button onclick="window.saveTalent()" class="w-full bg-slate-900 hover:bg-slate-800 text-white p-4 rounded-xl font-bold mt-8 shadow-lg transition">Profil aktivieren & speichern</button>
                    </div>
                `;
            }
            // 4. DEEP PROFILING: COMPANY
            else if (state.view === 'company') {
<!-- ... (gleicher Code wie vorher) ... -->
                html += `
                    <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-100 max-w-2xl mx-auto mb-20">
                        <h2 class="text-3xl font-bold mb-2 text-slate-800">Unternehmensprofil</h2>
                        <div class="space-y-6">
                            <div><label class="block text-sm font-semibold text-slate-700 mb-1">Firmenname</label><input id="c_name" type="text" value="${state.profile?.name || ''}" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200"></div>
                            <div class="bg-indigo-50 p-5 rounded-2xl border border-indigo-100">
                                <label class="block text-sm font-bold text-indigo-900 mb-2">Offenheit für unkonventionelle Talente</label>
                                <select id="c_openness" class="w-full p-3 rounded-xl border-none outline-none shadow-sm">
                                    <option value="high" ${state.profile?.openness === 'high' ? 'selected' : ''}>Sehr hoch - Wir suchen Potenzial, keine Standard-Zertifikate!</option>
                                    <option value="medium" ${state.profile?.openness === 'medium' ? 'selected' : ''}>Mittel - Wir schauen uns auch internationale Abschlüsse gerne an.</option>
                                    <option value="low" ${state.profile?.openness === 'low' ? 'selected' : ''}>Eher traditionell</option>
                                </select>
                            </div>
                            <div><label class="block text-sm font-semibold text-slate-700 mb-2">Euer Culture Score (1-10)</label><input id="c_culture" type="range" min="1" max="10" value="${state.profile?.culture || 7}" class="w-full accent-indigo-600"></div>
                            <div><label class="block text-sm font-semibold text-slate-700 mb-1">Health Benefits & Perks</label><textarea id="c_perks" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 h-20">${state.profile?.perks || ''}</textarea></div>
                        </div>
                        <button onclick="window.saveCompany()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-xl font-bold mt-8 shadow-lg transition">Profil aktivieren</button>
                    </div>
                `;
            }
            // 5. DASHBOARD TALENT
            else if (state.view === 'dashboard' && state.role === 'talent') {
                const myApps = state.applications.filter(a => a.talentId === state.user.uid);
                html += `
                    <div class="mb-8 flex justify-between items-center flex-wrap gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-800 mb-1">Deine Superkraft wirkt.</h2>
                            <p class="text-slate-500">Du wirst für das gefunden, was du wirklich kannst.</p>
                        </div>
                        ${!state.profile.verified ? `<button onclick="window.openVerifyModal()" class="bg-blue-600 text-white px-5 py-2.5 rounded-xl font-bold hover:bg-blue-700 shadow-md transition flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Profil analysieren & verifizieren</button>` : `<div class="text-green-700 bg-green-100 px-5 py-2.5 rounded-xl font-bold shadow-sm flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Identität & Skills Geprüft</div>`}
                    </div>
                    
                    <button onclick="window.setView('talent')" class="mb-6 text-sm text-slate-500 hover:text-teal-600 underline">Profil bearbeiten</button>

                    <div class="space-y-4">
                        ${myApps.length === 0 ? `<div class="bg-white p-12 rounded-3xl border-2 border-dashed border-slate-200 text-center"><p class="text-slate-500 text-lg">Noch keine Anfragen. Dein Deep-Profile arbeitet gerade für dich.</p></div>` : ''}
                        ${myApps.map(app => `
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex justify-between items-center gap-4 flex-wrap">
                                <div class="flex-1">
                                    <h3 class="font-bold text-xl">${app.companyName} beweist Interesse</h3>
                                    <div class="bg-slate-50 p-4 rounded-xl text-slate-700 italic border-l-4 border-teal-400 mt-3">"${app.message}"</div>
                                </div>
                                <button onclick="window.openChat('${app.id}')" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-xl shadow-md transition whitespace-nowrap">Chat öffnen</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            // 6. DASHBOARD COMPANY
            else if (state.view === 'dashboard' && state.role === 'company') {
                html += `
                    <div class="mb-8 flex justify-between items-center bg-indigo-900 p-8 rounded-3xl text-white shadow-xl">
                        <div><h2 class="text-2xl font-bold mb-1">Wahre Potenziale entdecken</h2><p class="text-indigo-200">Unabhängig von starren Abschlüssen.</p></div>
                        <div class="text-right"><div class="text-sm text-indigo-300">Verbleibende Anfragen</div><div class="text-4xl font-black">${state.profile.credits > 100 ? '∞' : (state.profile.credits || 0)}</div></div>
                    </div>
                    
                    <button onclick="window.setView('company')" class="mb-6 text-sm text-slate-500 hover:text-indigo-600 underline">Firmenprofil bearbeiten</button>

                    <div class="grid grid-cols-1 gap-6">
                `;
                state.talents.forEach(t => {
                    // Check ob bereits beworben
                    const existingApp = state.applications.find(a => a.talentId === t.uid && a.companyId === state.user.uid);
                    const skills = t.skills ? t.skills.split(',').map(s => `<span class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-lg text-sm font-semibold mr-2 mb-2 inline-block border border-indigo-100">${s.trim()}</span>`).join('') : '';
                    
                    html += `
                        <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 hover:shadow-lg transition relative">
                            ${t.verified ? `<div class="absolute top-6 right-6 bg-blue-100 text-blue-700 text-xs font-bold px-3 py-1 rounded-full flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Geprüft</div>` : ''}
                            
                            <div class="mb-4"><span class="bg-teal-100 text-teal-800 px-3 py-1 rounded-full text-xs font-bold tracking-wide uppercase">Superkraft</span></div>
                            <h3 class="font-black text-2xl text-slate-800 mb-4">${t.superpower || 'Ungeschriebenes Talent'}</h3>
                            
                            <div class="grid md:grid-cols-2 gap-6 mb-6">
                                <div><p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Einzigartiger Hintergrund</p><p class="text-sm text-slate-700 bg-slate-50 p-4 rounded-xl border border-slate-100 leading-relaxed">${t.background || 'Nicht angegeben'}</p></div>
                                <div><p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Health & Needs</p><p class="text-sm text-slate-700 bg-slate-50 p-4 rounded-xl border border-slate-100 leading-relaxed"><span class="font-bold">Priorität: ${t.health}/10</span><br><br>"${t.about}"</p></div>
                            </div>
                            
                            ${skills ? `<div class="mb-6">${skills}</div>` : ''}
                            ${t.redFlags ? `<div class="mb-6 bg-red-50 p-4 rounded-xl border border-red-100"><p class="text-xs font-bold text-red-500 uppercase tracking-wider mb-1">Red Flags</p><p class="text-sm text-red-800">${t.redFlags}</p></div>` : ''}
                            
                            ${existingApp ? `
                                <div class="flex gap-4">
                                    <div class="bg-slate-100 text-slate-500 flex-1 py-4 rounded-xl font-bold text-center flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Bereits angefragt</div>
                                    <button onclick="window.openChat('${existingApp.id}')" class="bg-indigo-600 hover:bg-indigo-700 text-white flex-1 py-4 rounded-xl font-bold shadow-md transition">Nachrichten (Chat)</button>
                                </div>
                            ` : `
                                <button onclick="window.openApplyModal('${t.uid}')" class="bg-slate-900 text-white w-full py-4 rounded-xl font-bold hover:bg-indigo-600 transition shadow-md">Profil anfragen</button>
                            `}
                        </div>
                    `;
                });
                html += `</div>`;
            }

            html += `</div>`;

            // --- NEU: VERIFIZIERUNGS MODAL ---
            if (state.showVerifyModal) {
                html += `
                    <div class="fixed inset-0 bg-slate-900/70 backdrop-blur-md flex items-center justify-center p-4 z-50">
                        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center">
                            <h3 class="text-2xl font-bold mb-2">Profil Verifizierung</h3>
                            <p class="text-sm text-slate-500 mb-6">Wir analysieren deine Zertifikate und Portfolios mithilfe unserer KI, um Firmen deine Kompetenz zu bestätigen.</p>
                            
                            ${state.verifyStep === 0 ? `
                                <input id="v_link" type="text" class="w-full p-4 border border-slate-200 bg-slate-50 rounded-xl mb-4 outline-none focus:ring-2 focus:ring-teal-500" placeholder="Link (z.B. LinkedIn, Uni-Nachweis, Portfolio)">
                                <div class="flex gap-2">
                                    <button onclick="window.closeVerifyModal()" class="px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-100 flex-1">Abbrechen</button>
                                    <button onclick="window.runVerification()" class="px-4 py-3 rounded-xl font-bold bg-blue-600 text-white hover:bg-blue-700 flex-1">Starten</button>
                                </div>
                            ` : state.verifyStep === 1 ? `
                                <div class="py-10 text-teal-600 font-bold animate-pulse text-lg flex flex-col items-center">
                                    <svg class="w-10 h-10 mb-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                    Scanne Quell-Datenbanken...
                                </div>
                            ` : `
                                <div class="py-10 text-indigo-600 font-bold animate-pulse text-lg flex flex-col items-center">
                                    <svg class="w-10 h-10 mb-4 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Analysiere non-traditionelle Zertifikate und interkulturelle Fähigkeiten...
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }

            // --- NEU: CHAT MODAL ---
            if (state.activeChatAppId) {
                const appInfo = state.applications.find(a => a.id === state.activeChatAppId);
                const chatMsgs = state.messages.filter(m => m.applicationId === state.activeChatAppId).sort((a,b) => a.timestamp - b.timestamp);
                
                html += `
                    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                        <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full h-[600px] flex flex-col overflow-hidden border border-slate-200">
                            <!-- Header -->
                            <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-slate-800">Gespräch mit ${state.role === 'talent' ? appInfo?.companyName : 'dem Talent'}</h3>
                                    <p class="text-xs text-green-600 font-medium">Sichere Verbindung</p>
                                </div>
                                <button onclick="window.closeChat()" class="p-2 bg-slate-200 rounded-full text-slate-600 hover:bg-slate-300">✕</button>
                            </div>
                            
                            <!-- Messages Area -->
                            <div id="chat_messages" class="flex-1 overflow-y-auto p-4 bg-slate-100 chat-scroll flex flex-col gap-3">
                                <div class="text-center text-xs text-slate-400 my-2">Anfrage-Nachricht: "${appInfo?.message}"</div>
                                ${chatMsgs.length === 0 ? `<div class="text-center text-slate-500 mt-10 text-sm">Schreibe die erste Nachricht!</div>` : ''}
                                ${chatMsgs.map(msg => {
                                    const isMe = msg.senderId === state.user.uid;
                                    return `
                                        <div class="max-w-[80%] ${isMe ? 'self-end bg-teal-600 text-white rounded-l-2xl rounded-tr-2xl' : 'self-start bg-white text-slate-800 border border-slate-200 rounded-r-2xl rounded-tl-2xl'} p-3 shadow-sm text-sm">
                                            <div class="text-[10px] ${isMe ? 'text-teal-200' : 'text-slate-400'} mb-1 font-semibold">${isMe ? 'Du' : msg.senderName}</div>
                                            ${msg.text}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <!-- Input Area -->
                            <div class="p-4 bg-white border-t border-slate-200 flex gap-2">
                                <input id="chat_input" type="text" class="flex-1 p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none focus:border-teal-500" placeholder="Deine Nachricht..." onkeypress="if(event.key === 'Enter') window.sendMessage()">
                                <button onclick="window.sendMessage()" class="bg-teal-600 text-white px-5 rounded-xl font-bold hover:bg-teal-700">Senden</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // --- PAYWALL & APPLY MODALS (bleiben erhalten) ---
            if (state.applyingTo && !state.showPaywall) {
                html += `
                    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-lg w-full">
                            <h3 class="text-2xl font-bold mb-2">Bewerbung an Talent</h3>
                            <p class="text-sm text-slate-500 mb-6">Zeigt, warum ihr als Firma genau diesen unkonventionellen Hintergrund sucht.</p>
                            <textarea id="apply_message" class="w-full p-4 border border-slate-200 bg-slate-50 rounded-xl mb-6 h-32 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Dein Abschluss passt perfekt zu unserem Projekt..."></textarea>
                            <div class="flex justify-end gap-3">
                                <button onclick="window.closeApplyModal()" class="px-5 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-100">Abbrechen</button>
                                <button id="apply_btn" onclick="window.submitApplication()" class="px-6 py-3 rounded-xl font-bold bg-indigo-600 text-white hover:bg-indigo-700">Senden (1 Credit)</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (state.showPaywall) {
                html += `
                    <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4 z-50">
                        <div class="bg-white p-10 rounded-3xl shadow-2xl max-w-md w-full text-center relative overflow-hidden">
                            <h3 class="text-2xl font-extrabold mb-3">Freianfragen aufgebraucht</h3>
                            <p class="text-slate-600 mb-6">Sichere dir unbegrenzten Zugriff auf außergewöhnliche Talente abseits des Mainstreams.</p>
                            <div class="bg-slate-50 border border-slate-200 p-4 rounded-2xl mb-8">
                                <div class="text-3xl font-extrabold">99€ <span class="text-sm text-slate-500">/ Monat</span></div>
                            </div>
                            <div id="paypal-button-container" class="w-full min-h-[150px] relative z-10 mb-2"></div>
                            <button onclick="window.closeApplyModal()" class="w-full py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-100 transition relative z-0">Später entscheiden</button>
                        </div>
                    </div>
                `;
            }

            appDiv.innerHTML = html;
        }
    </script>
</body>
</html>


