<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EquiMatch | Gesunde Arbeitswelt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { font-family: sans-serif; }</style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

    <!-- App Container -->
    <div id="app" class="pb-12">
        <div class="text-center mt-20 text-teal-600 font-bold animate-pulse">Lade System...</div>
    </div>

    <!-- Firebase & Logik -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

     // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDzN7StXcxZVkYcs3pQBh1rAYypqKF54PE",
  authDomain: "equimatch-a9a03.firebaseapp.com",
  projectId: "equimatch-a9a03",
  storageBucket: "equimatch-a9a03.firebasestorage.app",
  messagingSenderId: "1064864391538",
  appId: "1:1064864391538:web:ceeca48c28a9e7a63f3deb",
  measurementId: "G-8RGBYGNGED"
};

        let appInit, auth, db;
        let state = { user: null, view: 'loading', role: null, profile: null, talents: [], companies: [], applications: [] };

        const appDiv = document.getElementById('app');

        // 1. Initialisierung mit Fehlerabfang (Verhindert weißen Bildschirm)
        try {
            if(firebaseConfig.apiKey === "DEIN_API_KEY_HIER") {
                throw new Error("Bitte trage deine Firebase-Daten im Code ein!");
            }
            appInit = initializeApp(firebaseConfig);
            auth = getAuth(appInit);
            db = getFirestore(appInit);
            
            // Anonyme Anmeldung starten
            signInAnonymously(auth).catch(e => { throw new Error("Firebase Auth muss in der Console aktiviert werden (Anonym)."); });
            
            onAuthStateChanged(auth, (user) => {
                state.user = user;
                if (user) loadData();
                else { state.view = 'role_select'; render(); }
            });

        } catch(error) {
            appDiv.innerHTML = `
                <div class="max-w-2xl mx-auto mt-20 p-8 bg-red-50 border-l-4 border-red-500 rounded-xl">
                    <h2 class="text-2xl font-bold text-red-700 mb-4">Datenbank-Setup fehlt!</h2>
                    <p class="mb-4">${error.message}</p>
                    <ol class="list-decimal pl-5 space-y-2 font-medium">
                        <li>Gehe zu <a href="https://firebase.google.com" target="_blank" class="text-blue-600 underline">firebase.google.com</a> und erstelle ein Projekt.</li>
                        <li>Füge eine "Web-App" (</>) hinzu.</li>
                        <li>Kopiere die config-Daten in Zeile 23-28 dieser HTML-Datei.</li>
                        <li>Aktiviere in Firebase unter "Build -> Authentication" den Anbieter "Anonym".</li>
                        <li>Aktiviere "Build -> Firestore Database" im Testmodus.</li>
                    </ol>
                </div>
            `;
        }

        // 2. Daten laden (Echtzeit)
        function loadData() {
            try {
                onSnapshot(collection(db, 'talents'), (snap) => {
                    state.talents = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    checkProfile(); render();
                });
                onSnapshot(collection(db, 'companies'), (snap) => {
                    state.companies = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    checkProfile(); render();
                });
                onSnapshot(collection(db, 'applications'), (snap) => {
                    state.applications = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    render();
                });
            } catch(e) {
                console.error("Datenbank-Lesefehler:", e);
            }
        }

        function checkProfile() {
            if (!state.user) return;
            const myTalent = state.talents.find(t => t.uid === state.user.uid);
            const myCompany = state.companies.find(c => c.uid === state.user.uid);
            if (myTalent) { state.profile = myTalent; state.role = 'talent'; state.view = 'dashboard'; }
            else if (myCompany) { state.profile = myCompany; state.role = 'company'; state.view = 'dashboard'; }
            else if (state.view === 'loading') { state.view = 'role_select'; }
        }

        // 3. Aktionen
        window.setView = (view) => { state.view = view; render(); };
        
        window.saveTalent = async () => {
            const data = {
                uid: state.user.uid,
                title: document.getElementById('t_title').value,
                health: document.getElementById('t_health').value,
                about: document.getElementById('t_about').value
            };
            await setDoc(doc(db, 'talents', state.user.uid), data);
        };

        window.saveCompany = async () => {
            const data = {
                uid: state.user.uid,
                name: document.getElementById('c_name').value,
                culture: document.getElementById('c_culture').value
            };
            await setDoc(doc(db, 'companies', state.user.uid), data);
        };

        window.applyToTalent = async (talentId) => {
            const msg = prompt("Warum passt eure Kultur zu diesem Talent?");
            if (!msg) return;
            await addDoc(collection(db, 'applications'), {
                companyId: state.user.uid,
                companyName: state.profile.name,
                talentId: talentId,
                message: msg
            });
            alert("Anfrage versendet!");
        };

        // 4. UI Renderer
        function render() {
            if (state.view === 'loading') return;

            let html = `
                <nav class="bg-white p-4 shadow-sm flex justify-between items-center mb-8">
                    <div class="text-xl font-bold text-teal-600">EquiMatch.</div>
                    <div class="text-sm text-slate-500">${state.profile?.name || state.profile?.title || 'Anonym'}</div>
                </nav>
                <div class="max-w-4xl mx-auto px-4">
            `;

            if (state.view === 'role_select') {
                html += `
                    <div class="text-center mb-10"><h1 class="text-3xl font-bold">Fokus auf Mental Health & Kultur</h1></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <button onclick="window.setView('talent')" class="p-8 bg-white rounded-xl shadow border border-slate-200 hover:border-teal-400">
                            <h2 class="text-xl font-bold mb-2">Ich bin ein Talent</h2><p class="text-sm text-slate-500">Profil anlegen & gefunden werden.</p>
                        </button>
                        <button onclick="window.setView('company')" class="p-8 bg-white rounded-xl shadow border border-slate-200 hover:border-teal-400">
                            <h2 class="text-xl font-bold mb-2">Wir sind eine Firma</h2><p class="text-sm text-slate-500">Gesunde Talente finden.</p>
                        </button>
                    </div>
                `;
            }
            else if (state.view === 'talent') {
                html += `
                    <div class="bg-white p-8 rounded-xl shadow max-w-md mx-auto">
                        <h2 class="text-xl font-bold mb-4">Talent-Profil</h2>
                        <input id="t_title" type="text" placeholder="Beruf (z.B. Coach)" class="w-full p-3 bg-slate-50 rounded border mb-4">
                        <label class="block text-sm font-bold mb-1">Mental Health Priorität (1-10)</label>
                        <input id="t_health" type="range" min="1" max="10" value="8" class="w-full mb-4 accent-teal-600">
                        <textarea id="t_about" placeholder="Bedürfnisse an den Arbeitgeber..." class="w-full p-3 bg-slate-50 rounded border mb-6 h-24"></textarea>
                        <button onclick="window.saveTalent()" class="w-full bg-teal-600 text-white p-3 rounded font-bold">Speichern</button>
                    </div>
                `;
            }
            else if (state.view === 'company') {
                html += `
                    <div class="bg-white p-8 rounded-xl shadow max-w-md mx-auto">
                        <h2 class="text-xl font-bold mb-4">Firmen-Profil</h2>
                        <input id="c_name" type="text" placeholder="Firmenname" class="w-full p-3 bg-slate-50 rounded border mb-4">
                        <label class="block text-sm font-bold mb-1">Culture Score (1-10)</label>
                        <input id="c_culture" type="range" min="1" max="10" value="7" class="w-full mb-6 accent-teal-600">
                        <button onclick="window.saveCompany()" class="w-full bg-teal-600 text-white p-3 rounded font-bold">Speichern</button>
                    </div>
                `;
            }
            else if (state.view === 'dashboard' && state.role === 'talent') {
                const myApps = state.applications.filter(a => a.talentId === state.user.uid);
                html += `<h2 class="text-2xl font-bold mb-4">Anfragen von Firmen</h2><div class="space-y-4">`;
                if(myApps.length === 0) html += `<p>Noch keine Anfragen. Firmen melden sich hier bei dir.</p>`;
                myApps.forEach(app => {
                    html += `<div class="bg-white p-6 rounded-xl shadow border border-teal-100">
                        <h3 class="font-bold text-lg">${app.companyName}</h3><p class="italic bg-slate-50 p-2 mt-2">"${app.message}"</p>
                    </div>`;
                });
                html += `</div>`;
            }
            else if (state.view === 'dashboard' && state.role === 'company') {
                html += `<h2 class="text-2xl font-bold mb-4">Talente im Netzwerk</h2><div class="grid md:grid-cols-2 gap-4">`;
                state.talents.forEach(t => {
                    html += `<div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="font-bold">${t.title}</h3>
                        <p class="text-sm mt-2 mb-4">Mental Health Bedarf: ${t.health}/10<br><i>"${t.about}"</i></p>
                        <button onclick="window.applyToTalent('${t.uid}')" class="bg-teal-100 text-teal-800 w-full p-2 rounded font-bold">Anfragen</button>
                    </div>`;
                });
                html += `</div>`;
            }

            html += `</div>`;
            appDiv.innerHTML = html;
        }
    </script>
</body>
</html>


