<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Plot | Your life is a movie.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=AdWPwOjuX1h1gYLtvpb63&currency=EUR"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #09090b; color: #f4f4f5; background-image: radial-gradient(circle at 50% 0%, #27272a 0%, #09090b 70%); min-height: 100vh; overflow-x: hidden; touch-action: pan-y; }
        h1, h2, h3, .serif { font-family: 'Playfair Display', serif; }
        .film-grain { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 50; opacity: 0.04; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); }
        .gold-text { background: linear-gradient(to right, #fbbf24, #d97706); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Haptisches Ticket */
        .ticket-wrapper { display: flex; perspective: 1000px; position: relative; gap: 2px; }
        .ticket-main { flex: 1; background: linear-gradient(135deg, #e4e4e7 0%, #d4d4d8 100%); border-radius: 16px 0 0 16px; padding: 32px; position: relative; box-shadow: -5px 10px 30px rgba(0,0,0,0.5); border-right: 3px dashed #9ca3af; transition: border-color 0.5s; }
        .ticket-stub { width: 90px; background: linear-gradient(135deg, #d4d4d8 0%, #a1a1aa 100%); border-radius: 0 16px 16px 0; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; cursor: grab; box-shadow: 5px 10px 30px rgba(0,0,0,0.5); transform-origin: top left; transition: transform 0.1s ease-out; }
        .ticket-stub:active { cursor: grabbing; }
        
        .ticket-stub::before { content: ''; position: absolute; top: 0; right: 0; border-width: 0 45px 45px 0; border-style: solid; border-color: #09090b #09090b #f4f4f5 #f4f4f5; border-radius: 0 16px 0 0; box-shadow: -3px 3px 6px rgba(0,0,0,0.4); transition: border-width 0.2s ease; z-index: 10; pointer-events: none; }
        .ticket-stub::after { content: 'ZIEHEN'; position: absolute; top: 12px; right: 4px; font-size: 8px; font-weight: 900; color: #52525b; transform: rotate(45deg); z-index: 11; pointer-events: none; letter-spacing: 1px; }
        .ticket-stub-text { writing-mode: vertical-rl; transform: rotate(180deg); color: #52525b; font-weight: 800; text-transform: uppercase; letter-spacing: 4px; font-size: 14px; user-select: none; }
        
        .ticket-wrapper.torn .ticket-stub { transform: rotate(25deg) translateY(300px) translateX(50px) scale(0.9); opacity: 0; pointer-events: none; transition: transform 0.8s cubic-bezier(0.55, 0.085, 0.68, 0.53), opacity 0.6s ease; }
        .ticket-wrapper.torn .ticket-main { border-right-color: transparent; }

        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #52525b; border-radius: 10px; }
        .blur-reveal { filter: blur(8px); user-select: none; transition: filter 1.5s ease; }
        
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { pointer-events: auto; background: rgba(24, 24, 27, 0.95); backdrop-filter: blur(8px); border: 1px solid #3f3f46; color: white; padding: 16px 24px; border-radius: 12px; font-size: 14px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 12px; }
        .toast.show { transform: translateX(0); }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.success { border-left: 4px solid #10b981; }
        .toast.info { border-left: 4px solid #f59e0b; }

        @keyframes breathe { 0% { transform: scale(1); opacity: 0.5; } 40% { transform: scale(1.5); opacity: 0.1; } 70% { transform: scale(1.5); opacity: 0.1; } 100% { transform: scale(1); opacity: 0.5; } }
        .animate-breathe { animation: breathe 8s infinite ease-in-out; }
        .progress-bar-smooth { transition: width 1s linear; }
    </style>
</head>
<body class="flex flex-col relative">
    <div class="film-grain"></div>
    <div id="toast-container"></div>

    <div id="app" class="flex-1 flex flex-col pb-20 z-10 relative">
        <div class="text-center mt-40 flex flex-col items-center">
            <div class="w-16 h-16 border-t-2 border-l-2 border-amber-500 rounded-full animate-spin mb-6"></div>
            <div class="text-2xl serif italic text-zinc-400">Loading your scene...</div>
        </div>
    </div>

    <!-- Dev Menu für Admin & Tests -->
    <div id="dev-menu" class="fixed bottom-12 right-4 z-[9990] bg-zinc-900/90 border border-zinc-700 p-4 rounded-xl backdrop-blur-md opacity-20 hover:opacity-100 transition-opacity pointer-events-auto shadow-2xl hidden">
        <div class="text-[9px] uppercase tracking-widest text-amber-500 font-bold text-center mb-2">Director's Controls</div>
        <div class="flex flex-col gap-2">
            <div class="flex gap-2">
                <button onclick="window.shiftTime(0)" class="flex-1 px-2 py-1 bg-zinc-800 text-[10px] text-zinc-400 rounded hover:bg-zinc-700">Reset</button>
                <button onclick="window.triggerEventStart()" class="flex-1 px-2 py-1 bg-amber-900/50 text-[10px] text-amber-400 rounded border border-amber-700/50 hover:bg-amber-800/50">Start Event!</button>
            </div>
        </div>
    </div>

    <!-- Navbar Unten (Mobile App Feeling) -->
    <div id="bottom-nav" class="fixed bottom-0 left-0 w-full bg-zinc-950/90 backdrop-blur-lg border-t border-zinc-800 z-40 flex justify-around items-center px-6 py-4 hidden pb-6">
        <button onclick="window.setView('home')" class="text-zinc-400 hover:text-amber-500 transition flex flex-col items-center gap-1">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span class="text-[9px] uppercase tracking-widest font-bold">Drops</span>
        </button>
        <button onclick="window.setView('ticket')" class="text-zinc-400 hover:text-amber-500 transition flex flex-col items-center gap-1 relative">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path></svg>
            <span class="text-[9px] uppercase tracking-widest font-bold">Ticket</span>
        </button>
        <button onclick="window.setView('chats')" class="text-zinc-400 hover:text-amber-500 transition flex flex-col items-center gap-1">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
            <span class="text-[9px] uppercase tracking-widest font-bold">Chats</span>
        </button>
        <button onclick="window.toggleSettings()" class="text-zinc-400 hover:text-amber-500 transition flex flex-col items-center gap-1">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            <span class="text-[9px] uppercase tracking-widest font-bold">Profil</span>
        </button>
    </div>

    <!-- Versionsnummer -->
    <div class="fixed top-4 left-4 z-50 text-[10px] text-zinc-700 font-mono select-none pointer-events-none">
        v0.9.3 Beta
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, deleteUser } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, addDoc, onSnapshot, getDocs, updateDoc, deleteDoc, query, where, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let apiKey = "";
        try {
            const configModule = await import('./config.js');
            apiKey = configModule.PLOT_CONFIG.GEMINI_API_KEY;
        } catch(e) { console.warn("config.js nicht gefunden."); }

        const firebaseConfig = {
          apiKey: "AIzaSyDzN7StXcxZVkYcs3pQBh1rAYypqKF54PE",
          authDomain: "equimatch-a9a03.firebaseapp.com",
          projectId: "equimatch-a9a03",
          storageBucket: "equimatch-a9a03.firebasestorage.app",
          messagingSenderId: "1064864391538",
          appId: "1:1064864391538:web:ceeca48c28a9e7a63f3deb"
        };

        let appInit, auth, db;
        const CITIES = ["Paderborn", "Köln", "Berlin", "Hamburg", "München"];
        
        let state = { 
            user: null, view: 'loading', profile: null, currentDrop: null, allDrops: [],
            hasTicket: false, messages: [], authMode: 'login', logoClicks: 0,
            showSettings: false, showBreathe: false, selectedCity: "Paderborn", aiLoading: false,
            devTimeOffset: 0, editingDropId: null, openChatId: null
        };

        const appDiv = document.getElementById('app');
        let countdownInterval;
        let isTransitioning = false; 
        let isRegistering = false; 
        let unsubs = []; 

        window.showToast = (msg, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = `<svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            if(type === 'success') icon = `<svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            if(type === 'error') icon = `<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77-1.333.192 3 1.732 3z"></path></svg>`;
            toast.innerHTML = `${icon} <div><div class="font-bold text-xs uppercase tracking-widest text-zinc-400 mb-0.5">Notification</div><div>${msg}</div></div>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 4000);
        };

        async function generateSmartAlias(vibe) {
            let v = vibe.toLowerCase().replace(/the\s/g, ''); 
            let adj = "Stranger";
            
            if(v.includes('kreativ') || v.includes('kunst') || v.includes('malen')) adj = "Artist";
            else if(v.includes('ruhig') || v.includes('still') || v.includes('leise')) adj = "Observer";
            else if(v.includes('kaffee') || v.includes('cafe')) adj = "Brewer";
            else if(v.includes('lesen') || v.includes('buch')) adj = "Reader";
            else if(v.includes('natur') || v.includes('wald') || v.includes('wandern')) adj = "Wanderer";
            else if(v.includes('nacht') || v.includes('dunkel') || v.includes('abend')) adj = "Nightowl";
            else if(v.includes('tief') || v.includes('denken') || v.includes('philosoph')) adj = "Thinker";
            else if(v.includes('spontan') || v.includes('abenteuer')) adj = "Adventurer";
            else {
                const words = vibe.split(/[\s,]+/);
                if(words.length > 0 && words[0].length > 2) {
                    adj = words[0].charAt(0).toUpperCase() + words[0].slice(1);
                }
            }

            let finalAlias = `The ${adj}`;
            let attempts = 0;
            while(attempts < 5) {
                const q = query(collection(db, 'plot_users'), where('alias', '==', finalAlias));
                const snap = await getDocs(q);
                if(snap.empty) return finalAlias;
                finalAlias = `The ${adj} ${Math.floor(Math.random()*1000)}`;
                attempts++;
            }
            return finalAlias;
        }

        function clearListeners() {
            unsubs.forEach(u => u());
            unsubs = [];
            if(window.unsubChat) { window.unsubChat(); window.unsubChat = null; }
            if(countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
        }

        try {
            appInit = initializeApp(firebaseConfig);
            auth = getAuth(appInit);
            db = getFirestore(appInit);
            
            onAuthStateChanged(auth, async (user) => {
                state.user = user;
                if (user) {
                    clearListeners();

                    const unsubProfile = onSnapshot(doc(db, 'plot_users', user.uid), (docSnap) => {
                        if (docSnap.exists()) {
                            state.profile = docSnap.data();
                            state.selectedCity = state.profile.city || state.selectedCity;
                            checkRouting();
                        } else if (!isRegistering) {
                            state.profile = { hasPremium: false, tickets: [], completedDrops: [], alias: "The Stranger", isAdmin: false, city: state.selectedCity };
                            setDoc(doc(db, 'plot_users', user.uid), state.profile);
                        }
                    });
                    unsubs.push(unsubProfile);

                    const unsubDrops = onSnapshot(collection(db, 'plot_drops'), (snap) => {
                        const allDrops = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        state.allDrops = allDrops;
                        
                        const completed = state.profile?.completedDrops || [];
                        state.currentDrop = allDrops.find(d => d.isActive && d.city === state.selectedCity && !completed.includes(d.id)) || null;
                        
                        if(state.currentDrop) {
                            state.hasTicket = state.profile?.tickets?.includes(state.currentDrop.id) || false;
                            if (window.unsubChat) window.unsubChat();
                            window.unsubChat = onSnapshot(collection(db, `plot_messages_${state.currentDrop.id}`), (msgSnap) => {
                                state.messages = msgSnap.docs.map(d => d.data()).sort((a,b) => a.timestamp - b.timestamp);
                                if(state.view === 'room' && state.currentDrop.phase === 'lobby') { render(); scrollToBottom(); }
                            });
                            if(!countdownInterval) countdownInterval = setInterval(automatedPacingLogic, 1000);
                        } else {
                            if (window.unsubChat) { window.unsubChat(); window.unsubChat = null; }
                            state.messages = [];
                        }
                        
                        // Wenn wir in einem alten Chat sind
                        if(state.openChatId && state.view === 'chats') {
                             if (window.unsubChat) window.unsubChat();
                             window.unsubChat = onSnapshot(collection(db, `plot_messages_${state.openChatId}`), (msgSnap) => {
                                state.messages = msgSnap.docs.map(d => d.data()).sort((a,b) => a.timestamp - b.timestamp);
                                render(); scrollToBottom();
                            });
                        }

                        checkRouting();
                    });
                    unsubs.push(unsubDrops);

                } else {
                    clearListeners();
                    state.user = null; state.profile = null; state.currentDrop = null; state.hasTicket = false;
                    state.view = 'auth'; render();
                }
            });
        } catch(error) { window.showToast("Systemfehler: " + error.message, "error"); }

        // ==========================================
        // AUTOMATION & TIME TRAVEL
        // ==========================================
        async function automatedPacingLogic() {
            if (!state.currentDrop || isTransitioning) return;
            const now = Date.now() + state.devTimeOffset;
            let shouldRender = false;
            if (state.view === 'ticket' || state.view === 'room') shouldRender = true;

            try {
                if (state.currentDrop.phase === 'lobby' && state.currentDrop.eventTime && now >= state.currentDrop.eventTime) {
                    isTransitioning = true;
                    await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), { phase: 'live', activeQuestIndex: 0, questStartTime: now, readyVotes: [] });
                    isTransitioning = false;
                }
                else if (state.currentDrop.phase === 'live' && state.currentDrop.questStartTime) {
                    const questDuration = 15 * 60 * 1000; 
                    if (now - state.currentDrop.questStartTime >= questDuration) {
                        isTransitioning = true; await window.advanceToIntermission(); isTransitioning = false;
                    }
                }
                else if (state.currentDrop.phase === 'intermission' && state.currentDrop.intermissionStartTime) {
                    const breakDuration = 60 * 1000; 
                    if (now - state.currentDrop.intermissionStartTime >= breakDuration) {
                        isTransitioning = true; await window.advanceToNextQuest(); isTransitioning = false;
                    }
                }
            } catch(e) { isTransitioning = false; }
            if(shouldRender) render();
        }

        window.advanceToIntermission = async () => { await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), { phase: 'intermission', intermissionStartTime: Date.now() + state.devTimeOffset, readyVotes: [] }); };
        window.advanceToNextQuest = async () => {
            const nextIdx = (state.currentDrop.activeQuestIndex || 0) + 1;
            if(nextIdx >= (state.currentDrop.quests?.length || 1)) {
                await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), { phase: 'credits' });
            } else {
                await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), { phase: 'live', activeQuestIndex: nextIdx, questStartTime: Date.now() + state.devTimeOffset, readyVotes: [] });
            }
        };

        window.voteReady = async () => {
            if (!state.currentDrop || state.currentDrop.phase !== 'live') return;
            const dropRef = doc(db, 'plot_drops', state.currentDrop.id);
            const currentVotes = state.currentDrop.readyVotes || [];
            
            if (!currentVotes.includes(state.user.uid)) {
                const newVotes = [...currentVotes, state.user.uid];
                await updateDoc(dropRef, { readyVotes: newVotes });
                const totalParticipants = Math.max(1, (state.currentDrop.totalSpots || 4) - state.currentDrop.spotsLeft);
                if (newVotes.length >= totalParticipants) {
                    window.showToast("Alle sind bereit. Story geht weiter!", "success");
                    window.advanceToIntermission();
                } else { window.showToast("Warte auf die anderen...", "info"); }
            }
        };

        window.submitCredits = async () => {
            const selected = document.querySelector('input[name="credit_option"]:checked');
            if(selected && selected.value !== 'none') {
                 await addDoc(collection(db, 'plot_connections'), { userId: state.user.uid, dropId: state.currentDrop.id, preference: selected.value, timestamp: Date.now() });
                 window.showToast("Vibe gespeichert. Chat bleibt 7 Tage aktiv.", "success");
            } else {
                 window.showToast("Szene geschlossen. Chat bleibt 7 Tage aktiv.", "info");
            }
            
            // Mark as completed so it moves to 'Chats' and unblocks Home
            await updateDoc(doc(db, 'plot_users', state.user.uid), {
                completedDrops: arrayUnion(state.currentDrop.id)
            });
            window.setView('chats');
        };

        // ==========================================
        // UI & NAVIGATION
        // ==========================================
        function checkRouting() {
            if (!state.user || !state.profile) return;
            const needsRouting = ['loading', 'auth', 'nodrop', 'home', 'ticket'].includes(state.view);
            
            if(state.profile.isAdmin) {
                document.getElementById('dev-menu').classList.remove('hidden');
            }
            if(!['auth', 'loading', 'room', 'admin'].includes(state.view)) {
                document.getElementById('bottom-nav').classList.remove('hidden');
            } else {
                document.getElementById('bottom-nav').classList.add('hidden');
            }

            if (needsRouting) {
                if (state.profile.isAdmin) state.view = 'admin';
                else if (!state.currentDrop) state.view = 'nodrop';
                else {
                    state.hasTicket = state.profile?.tickets?.includes(state.currentDrop.id);
                    state.view = state.hasTicket ? 'ticket' : 'home';
                }
            }
            render();
        }

        function scrollToBottom() { setTimeout(() => { const chatBox = document.getElementById('chat_messages'); if (chatBox) chatBox.scrollTop = chatBox.scrollHeight; }, 50); }

        window.setView = (view) => { 
            state.view = view; state.showSettings = false; state.showBreathe = false; 
            if(view !== 'chats') state.openChatId = null;
            checkRouting(); render(); 
        };
        window.toggleAuthMode = () => { state.authMode = state.authMode === 'login' ? 'register' : 'login'; render(); };
        window.toggleSettings = () => { state.showSettings = !state.showSettings; render(); };
        window.toggleBreathe = () => { state.showBreathe = !state.showBreathe; render(); };

        // --- TICKET DRAG LOGIC ---
        let startY = 0;
        window.startTear = (e) => {
            if(state.currentDrop?.phase === 'lobby') return; // Can only tear when live
            startY = e.touches ? e.touches[0].clientY : e.clientY;
            document.addEventListener('mousemove', window.onTearMove);
            document.addEventListener('touchmove', window.onTearMove, {passive: false});
            document.addEventListener('mouseup', window.endTear);
            document.addEventListener('touchend', window.endTear);
        };
        window.onTearMove = (e) => {
            if(!startY) return;
            let y = e.touches ? e.touches[0].clientY : e.clientY;
            let diff = y - startY;
            if(diff > 0 && diff < 150) {
                e.preventDefault(); // prevent scrolling
                const stub = document.getElementById('ticket-stub');
                if(stub) stub.style.transform = `rotate(180deg) translateY(${-diff}px) rotateX(${diff/2}deg)`;
            }
        };
        window.endTear = (e) => {
            document.removeEventListener('mousemove', window.onTearMove);
            document.removeEventListener('touchmove', window.onTearMove);
            document.removeEventListener('mouseup', window.endTear);
            document.removeEventListener('touchend', window.endTear);
            let y = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            let stub = document.getElementById('ticket-stub');
            if (y - startY > 60) {
                window.activateTicket();
            } else if(stub) {
                stub.style.transform = 'rotate(180deg)'; 
            }
            startY = 0;
        };

        window.activateTicket = () => {
            const ticket = document.getElementById('main-ticket');
            if(ticket && !ticket.classList.contains('torn')) {
                ticket.classList.add('torn'); 
                setTimeout(() => window.setView('room'), 800);
            } else {
                window.setView('room');
            }
        };

        // --- AUTH & PROFILE ---
        window.handleAuth = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('auth_submit_btn');
            const email = document.getElementById('auth_email').value; 
            const pass = document.getElementById('auth_pass').value;
            let city = "Paderborn";
            let vibe = "Mysteriös";
            
            if (state.authMode === 'register') {
                city = document.getElementById('reg_city').value;
                vibe = document.getElementById('reg_vibe').value || "Mysteriös";
            }
            if(btn) { btn.disabled = true; btn.innerText = "Processing..."; }

            try {
                if (state.authMode === 'login') {
                    state.view = 'loading'; render();
                    await signInWithEmailAndPassword(auth, email, pass);
                    window.showToast("Welcome back.", "success");
                } else {
                    isRegistering = true;
                    if(btn) btn.innerText = "Casting Role...";
                    let generatedAlias = await generateSmartAlias(vibe);

                    state.view = 'loading'; render();
                    const userCred = await createUserWithEmailAndPassword(auth, email, pass);
                    
                    state.selectedCity = city;
                    state.profile = { hasPremium: false, tickets: [], completedDrops: [], alias: generatedAlias, isAdmin: false, city: city };
                    await setDoc(doc(db, 'plot_users', userCred.user.uid), state.profile);
                    
                    window.showToast(`Szene betreten als ${generatedAlias}`, "success");
                    isRegistering = false;
                }
            } catch (err) { 
                window.showToast(err.message, "error"); 
                state.view = 'auth'; isRegistering = false; render();
            }
        };
        
        window.handleLogout = () => { state.showSettings = false; state.view = 'loading'; render(); signOut(auth); window.showToast("Logged out.", "info"); };
        window.resetPassword = async () => {
            if(!state.user) return;
            try { await sendPasswordResetEmail(auth, state.user.email); window.showToast("Passwort Reset-Link gesendet.", "success"); } catch(e) { window.showToast(e.message, "error"); }
        };

        window.deleteAcc = async () => {
            if(confirm("Bist du sicher? Dies kann nicht rückgängig gemacht werden.")) {
                try { 
                    const uid = state.user.uid;
                    state.showSettings = false; render();
                    await deleteDoc(doc(db, 'plot_users', uid)); 
                    await deleteUser(auth.currentUser); 
                    window.showToast("Account gelöscht.", "success");
                } catch(e) { 
                    window.showToast("Bitte logge dich sicherheitshalber erst aus und wieder ein, bevor du löschst.", "error"); 
                }
            }
        };

        window.changeCity = async (e) => { await setDoc(doc(db, 'plot_users', state.user.uid), { city: e.target.value }, { merge: true }); window.showToast(`City changed to ${e.target.value}`, "info"); };
        window.regenerateAlias = async () => { 
            const newAlias = await generateSmartAlias(state.profile.alias || "Stranger");
            await setDoc(doc(db, 'plot_users', state.user.uid), { alias: newAlias }, { merge: true }); 
            window.showToast(`Neue Identität: ${newAlias}`, "success"); 
        };

        // --- ADMIN FUNCTIONS ---
        window.handleLogoClick = async () => {
            state.logoClicks++;
            if (state.logoClicks === 5) {
                state.logoClicks = 0;
                if(prompt("Director's Password:") === "director2026") {
                    await setDoc(doc(db, 'plot_users', state.user.uid), { isAdmin: true }, { merge: true }); 
                    window.showToast("Admin Access Granted.", "success");
                }
            }
        };

        window.editDrop = (id) => {
            const drop = state.allDrops.find(d => d.id === id);
            if(!drop) return;
            state.editingDropId = id;
            document.getElementById('admin_city').value = drop.city;
            document.getElementById('admin_title').value = drop.title;
            document.getElementById('admin_vibe').value = drop.vibe;
            document.getElementById('admin_blurloc').value = drop.blurLocation;
            document.getElementById('admin_exactloc').value = drop.exactLocation;
            document.getElementById('admin_spots').value = drop.totalSpots || 4;
            document.getElementById('admin_prop').value = drop.prop;
            document.getElementById('admin_drink').value = drop.secretDrink;
            document.getElementById('admin_quests').value = drop.quests.join('\n');
            const d = new Date(drop.eventTime);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            document.getElementById('admin_time').value = d.toISOString().slice(0,16);
            
            document.getElementById('admin_form_title').innerText = "Drop bearbeiten";
            window.scrollTo(0,0);
        };

        window.deleteDrop = async (id) => {
            if(confirm("Drop wirklich löschen?")) {
                await deleteDoc(doc(db, 'plot_drops', id));
                window.showToast("Drop gelöscht.", "success");
            }
        };

        window.toggleDropActive = async (id, currentStatus) => {
            await updateDoc(doc(db, 'plot_drops', id), { isActive: !currentStatus });
        };

        window.createDrop = async (e) => {
            e.preventDefault();
            if(!state.profile.isAdmin) return;
            const city = document.getElementById('admin_city').value;
            
            if(!state.editingDropId) {
                const snap = await getDocs(collection(db, 'plot_drops'));
                snap.forEach(async (d) => { if(d.data().city === city) await updateDoc(d.ref, { isActive: false }); });
            }

            const timeInput = document.getElementById('admin_time').value; 
            const eventTimestamp = new Date(timeInput).getTime();
            const totalSpots = parseInt(document.getElementById('admin_spots').value);

            const dropData = {
                city: city,
                title: document.getElementById('admin_title').value,
                vibe: document.getElementById('admin_vibe').value,
                blurLocation: document.getElementById('admin_blurloc').value,
                exactLocation: document.getElementById('admin_exactloc').value,
                eventTime: eventTimestamp,
                totalSpots: totalSpots,
                prop: document.getElementById('admin_prop').value,
                secretDrink: document.getElementById('admin_drink').value,
                quests: document.getElementById('admin_quests').value.split('\n').filter(q => q.trim() !== '')
            };

            if(state.editingDropId) {
                await updateDoc(doc(db, 'plot_drops', state.editingDropId), dropData);
                window.showToast(`Drop aktualisiert!`, "success");
                state.editingDropId = null;
                document.getElementById('admin_form_title').innerText = "Neuer Drop";
            } else {
                const newDrop = {
                    ...dropData,
                    id: 'drop_' + Date.now(),
                    spotsLeft: totalSpots,
                    isActive: true, phase: 'lobby', liveStartTime: null, activeQuestIndex: 0, questStartTime: null, intermissionStartTime: null, readyVotes: []
                };
                await setDoc(doc(db, 'plot_drops', newDrop.id), newDrop); 
                window.showToast(`Drop veröffentlicht!`, "success");
            }
            e.target.reset();
        };

        // --- TIME TRAVEL ---
        window.shiftTime = (ms) => {
            if(ms === 0) state.devTimeOffset = 0;
            else state.devTimeOffset += ms;
            window.showToast(ms === 0 ? "Zeit normalisiert." : `Zeit simuliert.`, "info");
            automatedPacingLogic();
        };

        window.triggerEventStart = () => {
            if(!state.currentDrop || !state.currentDrop.eventTime) return;
            state.devTimeOffset = state.currentDrop.eventTime - Date.now() + 1000; 
            window.showToast("Zeitsprung zum Eventstart!", "info");
            automatedPacingLogic();
        };

        // --- CHAT LOGIC ---
        window.openPastChat = (dropId) => {
            state.openChatId = dropId;
            state.messages = []; // Clear current
            
            if (window.unsubChat) window.unsubChat();
            window.unsubChat = onSnapshot(collection(db, `plot_messages_${dropId}`), (msgSnap) => {
                state.messages = msgSnap.docs.map(d => d.data()).sort((a,b) => a.timestamp - b.timestamp);
                render(); scrollToBottom();
            });
            render();
        };

        window.sendMessage = async (dropIdOverride = null) => {
            const idToUse = dropIdOverride || state.currentDrop?.id;
            const input = document.getElementById('chat_input'); const text = input.value.trim();
            if (!text || !idToUse) return;
            try {
                await addDoc(collection(db, `plot_messages_${idToUse}`), { senderId: state.user.uid, senderAlias: state.profile.alias || 'Stranger', text: text, timestamp: Date.now() });
                input.value = ''; scrollToBottom();
            } catch (e) { window.showToast("Failed to send.", "error"); }
        };

        function formatTimeLeft(ms) {
            if(ms <= 0) return "Jetzt";
            const h = Math.floor(ms / (1000 * 60 * 60));
            const m = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((ms % (1000 * 60)) / 1000);
            return `${h}h ${m}m ${s}s`;
        }
        function formatMMSS(ms) {
            if(ms <= 0) return "00:00";
            const m = Math.floor(ms / 60000).toString().padStart(2, '0');
            const s = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
            return `${m}:${s}`;
        }
        function formatEventDate(timestamp) {
            const d = new Date(timestamp);
            return d.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit' }) + " Uhr";
        }

        // --- UI RENDERER ---
        function render() {
            try {
                if (state.view === 'loading') {
                    appDiv.innerHTML = `<div class="text-center mt-40 flex flex-col items-center"><div class="w-16 h-16 border-t-2 border-l-2 border-amber-500 rounded-full animate-spin mb-6"></div><div class="text-2xl serif italic text-zinc-400">Loading your scene...</div></div>`;
                    return;
                }

                let html = `
                    <nav class="p-6 flex justify-between items-center max-w-5xl mx-auto w-full z-20 pt-8">
                        <div class="text-2xl font-black tracking-tighter serif italic text-zinc-100 select-none">The Plot.</div>
                        <div class="text-xs uppercase tracking-widest text-zinc-500 font-semibold flex items-center gap-4">
                            ${state.profile?.isAdmin ? "<span class='text-red-500'>Director</span>" : state.profile?.hasPremium ? "<span class='text-amber-500'>Director's Cut</span>" : ""}
                        </div>
                    </nav>
                    <div class="max-w-lg mx-auto px-4 w-full flex-1 flex flex-col justify-center z-20">
                `;

                if (state.view === 'admin') {
                    let defaultDate = new Date(); defaultDate.setDate(defaultDate.getDate() + 1); defaultDate.setHours(20, 0, 0, 0);
                    let isoDate = defaultDate.toISOString().slice(0, 16);

                    html += `
                        <div class="mb-8"><h1 class="text-3xl serif italic mb-2 text-red-500">Director's Hub</h1><p class="text-zinc-400 text-sm">Verwalte alle Drops.</p></div>
                        
                        <div class="space-y-4 mb-8">
                            ${state.allDrops.map(d => `
                                <div class="bg-zinc-900 p-4 rounded-xl border ${d.isActive ? 'border-amber-500' : 'border-zinc-700'} flex justify-between items-center">
                                    <div>
                                        <div class="text-sm font-bold text-white">${d.title} <span class="text-zinc-500 text-xs font-normal">(${d.city})</span></div>
                                        <div class="text-xs text-zinc-400">${formatEventDate(d.eventTime)} | Phase: ${d.phase}</div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="window.toggleDropActive('${d.id}', ${d.isActive})" class="px-2 py-1 text-[10px] uppercase font-bold rounded ${d.isActive ? 'bg-amber-900 text-amber-500' : 'bg-zinc-800 text-zinc-400'}">${d.isActive ? 'Active' : 'Hidden'}</button>
                                        <button onclick="window.editDrop('${d.id}')" class="px-2 py-1 bg-zinc-800 text-zinc-300 text-[10px] rounded hover:bg-zinc-700">Edit</button>
                                        <button onclick="window.deleteDrop('${d.id}')" class="px-2 py-1 bg-red-900/50 text-red-400 text-[10px] rounded hover:bg-red-900">Del</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="bg-zinc-900/80 p-8 rounded-3xl border border-zinc-800 mb-10">
                            <div class="flex justify-between items-center mb-6">
                                <h2 id="admin_form_title" class="text-xl serif italic">${state.editingDropId ? 'Drop bearbeiten' : 'Neuer Drop'}</h2>
                            </div>
                            <form onsubmit="window.createDrop(event)" class="space-y-4 text-sm">
                                <select id="admin_city" class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-amber-500">${CITIES.map(c => `<option value="${c}">${c}</option>`).join('')}</select>
                                <input id="admin_title" required placeholder="Titel" class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-red-500">
                                <textarea id="admin_vibe" required placeholder="Vibe" class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none h-16 focus:border-red-500"></textarea>
                                <input id="admin_blurloc" required placeholder="Grobe Area" class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-red-500">
                                <input id="admin_exactloc" required placeholder="Exakte Adresse" class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-red-500">
                                <div class="flex gap-2">
                                    <input id="admin_time" type="datetime-local" required value="${isoDate}" class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-red-500">
                                    <input id="admin_spots" type="number" value="4" class="w-24 p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-red-500">
                                </div>
                                <input id="admin_prop" required placeholder="Requisite" class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-red-500">
                                <input id="admin_drink" required placeholder="Geheimpasswort" class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none focus:border-red-500">
                                <textarea id="admin_quests" required placeholder="Quests (1 pro Zeile)" class="w-full p-3 bg-zinc-950 border border-zinc-800 rounded outline-none h-24 focus:border-red-500"></textarea>
                                <button type="submit" class="w-full bg-white text-black font-bold py-3 rounded mt-4 hover:bg-zinc-200 transition">${state.editingDropId ? 'Speichern' : 'Veröffentlichen'}</button>
                                ${state.editingDropId ? `<button type="button" onclick="state.editingDropId=null; render()" class="w-full bg-zinc-800 text-white font-bold py-3 rounded mt-2">Abbrechen</button>` : ''}
                            </form>
                        </div>
                    `;
                }
                else if (state.view === 'chats') {
                    if(state.openChatId) {
                        const dropInfo = state.allDrops.find(d => d.id === state.openChatId);
                        html += `
                            <div class="absolute inset-0 flex flex-col bg-[#09090b] z-50 pointer-events-auto pb-20">
                                <div class="p-6 border-b border-zinc-800/50 flex justify-between items-center backdrop-blur-md bg-zinc-900/50 pt-10">
                                    <div><h3 class="font-bold text-zinc-100 serif italic text-xl">${dropInfo?.title || 'Storyline'}</h3><div class="text-[10px] uppercase tracking-widest text-amber-500 font-bold mt-1">Löscht sich nach 7 Tagen</div></div>
                                    <button onclick="state.openChatId = null; render()" class="text-zinc-500 hover:text-white uppercase tracking-widest text-xs font-bold transition">Zurück</button>
                                </div>
                                <div id="chat_messages" class="flex-1 overflow-y-auto p-6 chat-scroll flex flex-col gap-6 bg-gradient-to-b from-transparent to-zinc-900/50">
                                    ${state.messages.length === 0 ? `<div class="text-center text-zinc-500 text-sm mt-10">Noch keine Nachrichten in dieser Storyline.</div>` : ''}
                                    ${state.messages.map(msg => { const isMe = msg.senderId === state.user?.uid; return `<div class="max-w-[85%] ${isMe ? 'self-end text-right' : 'self-start'}"><div class="text-[10px] uppercase tracking-widest ${isMe ? 'text-amber-500/70' : 'text-zinc-500'} mb-1 font-bold">${isMe ? 'You' : msg.senderAlias}</div><div class="${isMe ? 'bg-amber-900/20 text-amber-50 border border-amber-900/30' : 'bg-zinc-800/50 text-zinc-200 border border-zinc-700/50'} p-4 rounded-2xl ${isMe ? 'rounded-tr-sm' : 'rounded-tl-sm'} shadow-sm text-sm font-medium leading-relaxed backdrop-blur-sm">${msg.text}</div></div>`; }).join('')}
                                </div>
                                <div class="p-4 bg-zinc-900/80 border-t border-zinc-800/50 backdrop-blur-md pb-8"><div class="flex gap-2 relative max-w-lg mx-auto"><input id="chat_input" type="text" class="flex-1 p-4 bg-zinc-950/50 rounded-xl border border-zinc-800 outline-none focus:border-amber-500/50 text-zinc-200 transition shadow-inner" placeholder="Nachricht..." onkeypress="if(event.key === 'Enter') window.sendMessage('${state.openChatId}')"><button onclick="window.sendMessage('${state.openChatId}')" class="bg-zinc-100 text-zinc-900 px-6 rounded-xl font-bold hover:bg-white transition">➔</button></div></div>
                            </div>
                        `;
                    } else {
                        const completedDrops = state.profile?.completedDrops || [];
                        const pastEvents = state.allDrops.filter(d => completedDrops.includes(d.id));
                        
                        html += `
                            <div class="mb-8"><h1 class="text-4xl serif italic mb-2 gold-text">Storylines.</h1><p class="text-zinc-400 text-sm">Deine vergangenen Szenen und Connections.</p></div>
                            <div class="space-y-4 mb-20">
                                ${pastEvents.length === 0 ? `<div class="text-center p-10 border border-zinc-800 border-dashed rounded-3xl text-zinc-500 text-sm">Du hast noch keine Szenen abgeschlossen.</div>` : ''}
                                ${pastEvents.map(d => {
                                    const age = Date.now() - (d.eventTime || Date.now());
                                    const daysLeft = 7 - Math.floor(age / (1000*60*60*24));
                                    if(daysLeft <= 0) return ''; // Nach 7 Tagen verstecken
                                    
                                    return `
                                    <div onclick="window.openPastChat('${d.id}')" class="bg-zinc-900/50 border border-zinc-800 hover:border-amber-500/50 p-6 rounded-3xl cursor-pointer transition group relative overflow-hidden">
                                        <div class="relative z-10 flex justify-between items-center">
                                            <div>
                                                <h3 class="text-xl serif italic text-zinc-100 mb-1 group-hover:text-amber-400 transition">${d.title}</h3>
                                                <p class="text-xs text-zinc-500 uppercase tracking-widest">${formatEventDate(d.eventTime)}</p>
                                            </div>
                                            <div class="bg-zinc-950 px-3 py-2 rounded-lg text-xs font-bold text-amber-500 border border-zinc-800 flex items-center gap-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                                                Chat (${daysLeft}d)
                                            </div>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        `;
                    }
                }
                else if (state.view === 'nodrop') {
                    html += `
                        <div class="text-center">
                            <div class="w-16 h-16 mx-auto bg-zinc-900 rounded-full flex items-center justify-center mb-6 border border-zinc-800"><svg class="w-6 h-6 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div>
                            <h1 class="text-3xl serif italic mb-3">Keine Szenen in ${state.selectedCity}.</h1>
                            <p class="text-zinc-500 text-sm">Die Regie plant gerade den nächsten Plot. Hab etwas Geduld.</p>
                        </div>
                    `;
                }
                else if (state.view === 'auth') {
                    html += `
                        <div class="text-center mb-10"><h1 class="text-4xl serif italic mb-3">Claim your storyline.</h1><p class="text-zinc-400 text-sm leading-relaxed">Solo-Dates ohne Dating-Angst.<br>Echte Begegnungen. Magisches Pacing.</p></div>
                        <form onsubmit="window.handleAuth(event)" class="space-y-4">
                            <input id="auth_email" type="email" placeholder="Email" required class="w-full p-4 bg-zinc-900/50 border border-zinc-800 rounded-xl outline-none focus:border-amber-500/50 text-zinc-200 transition">
                            <input id="auth_pass" type="password" placeholder="Password" required minlength="6" class="w-full p-4 bg-zinc-900/50 border border-zinc-800 rounded-xl outline-none focus:border-amber-500/50 text-zinc-200 transition">
                            
                            ${state.authMode === 'register' ? `
                                <div class="pt-4 pb-2 border-t border-zinc-800/50">
                                    <label class="text-xs uppercase tracking-widest text-zinc-500 font-bold block mb-2">Deine Stadt</label>
                                    <select id="reg_city" class="w-full p-4 bg-zinc-900/50 border border-zinc-800 rounded-xl outline-none focus:border-amber-500/50 text-zinc-200 mb-4">${CITIES.map(c => `<option value="${c}">${c}</option>`).join('')}</select>
                                    
                                    <label class="text-xs uppercase tracking-widest text-zinc-500 font-bold block mb-2">Dein Vibe (z.B. Kreativ, ruhig, Kaffee)</label>
                                    <input id="reg_vibe" type="text" placeholder="Wir generieren deinen einzigartigen Alias." required class="w-full p-4 bg-zinc-900/50 border border-zinc-800 rounded-xl outline-none focus:border-amber-500/50 text-zinc-200 transition text-sm">
                                </div>
                            ` : ''}

                            <button id="auth_submit_btn" type="submit" class="w-full bg-zinc-100 text-zinc-900 hover:bg-white font-bold py-4 rounded-xl transition text-sm uppercase tracking-widest mt-4 shadow-[0_0_15px_rgba(255,255,255,0.1)]">
                                ${state.authMode === 'login' ? 'Enter' : 'Join the Cast'}
                            </button>
                        </form>
                        <button onclick="window.toggleAuthMode()" class="w-full text-center mt-6 text-xs text-zinc-500 hover:text-zinc-300 uppercase tracking-widest transition">${state.authMode === 'login' ? 'Neu hier? Ticket lösen' : 'Bereits Teil der Cast? Login'}</button>
                    `;
                }
                else if (state.view === 'home') {
                    html += `
                        <div class="mb-4 flex justify-between items-center"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span><span class="text-xs uppercase tracking-widest text-red-500 font-bold">Nächster Drop in ${state.currentDrop.city}</span></div></div>
                        <div class="bg-zinc-900/60 border border-zinc-800 rounded-3xl p-8 backdrop-blur-sm relative overflow-hidden group shadow-2xl">
                            <div class="absolute inset-0 opacity-20 bg-[url('https://images.unsplash.com/photo-1511556820780-d912e42b4980?auto=format&fit=crop&q=80')] bg-cover bg-center transition duration-1000 group-hover:scale-105 group-hover:opacity-30"></div>
                            <div class="relative z-10">
                                <h2 class="text-4xl serif italic mb-2">${state.currentDrop.title}</h2>
                                <p class="text-zinc-400 text-sm mb-8 leading-relaxed">"${state.currentDrop.vibe}"</p>
                                <div class="space-y-4 mb-10">
                                    <div class="flex justify-between items-center text-sm border-b border-zinc-800/50 pb-4"><span class="text-zinc-500 uppercase tracking-widest text-xs">Location</span><span class="text-zinc-300 flex items-center gap-2"><svg class="w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> Locked</span></div>
                                    <div class="flex justify-between items-center text-sm border-b border-zinc-800/50 pb-4"><span class="text-zinc-500 uppercase tracking-widest text-xs">Time</span><span class="text-zinc-300">${formatEventDate(state.currentDrop.eventTime)}</span></div>
                                    <div class="flex justify-between items-center text-sm"><span class="text-zinc-500 uppercase tracking-widest text-xs">Capacity</span><span class="text-amber-500 font-bold">${state.currentDrop.spotsLeft} Spots left</span></div>
                                </div>
                                <button onclick="window.claimTicket()" ${state.currentDrop.spotsLeft === 0 ? 'disabled' : ''} class="w-full ${state.currentDrop.spotsLeft === 0 ? 'bg-zinc-800 text-zinc-500' : 'bg-zinc-100 text-zinc-900 hover:bg-white shadow-[0_0_20px_rgba(255,255,255,0.1)]'} font-bold py-4 rounded-xl transition text-sm uppercase tracking-widest">${state.currentDrop.spotsLeft === 0 ? 'Sold Out' : 'Claim Ticket'}</button>
                            </div>
                        </div>
                    `;
                }
                else if (state.view === 'paywall') {
                    html += `
                        <div class="text-center mb-8"><h1 class="text-3xl serif italic mb-3">Join the Director's Cut</h1><p class="text-zinc-400 text-sm leading-relaxed">Sichere dir Exklusivität. Keine Dating-App Erschöpfung mehr. Echte Begegnungen.</p></div>
                        <div class="bg-zinc-900/80 border border-zinc-800 rounded-3xl p-8 backdrop-blur-md mb-6 shadow-2xl">
                            <div class="text-4xl font-light text-center mb-6 serif italic">49€ <span class="text-sm font-sans text-zinc-500 not-italic">/ month</span></div>
                            <ul class="space-y-4 text-sm text-zinc-300 mb-8">
                                <li class="flex items-center gap-3"><svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Unlimited Drop Tickets</li>
                                <li class="flex items-center gap-3"><svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Premium Aliases</li>
                                <li class="flex items-center gap-3"><svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Safe In-App "Soft Connection" Messaging</li>
                            </ul>
                            <div id="paypal-button-container" class="w-full min-h-[150px]"></div>
                        </div>
                        <button onclick="window.setView('home')" class="w-full text-center text-xs text-zinc-500 hover:text-zinc-300 uppercase tracking-widest transition">Maybe later</button>
                    `;
                }
                else if (state.view === 'ticket') {
                    const now = Date.now() + state.devTimeOffset;
                    const msUntilEvent = state.currentDrop.eventTime - now;
                    const isWithinOneHour = msUntilEvent <= (60 * 60 * 1000); 

                    html += `
                        <div class="text-center mb-8 animate-fade-in"><h1 class="text-3xl serif italic mb-2 gold-text">Your Scene is Ready.</h1><p class="text-zinc-400 text-sm">You are the main character. Go alone. Embrace the plot.</p></div>
                        
                        <div class="ticket-wrapper mx-4 group" id="main-ticket">
                            <div class="ticket-main">
                                <h2 class="text-3xl serif italic font-black mb-6 text-zinc-900">${state.currentDrop.title}</h2>
                                <div class="space-y-4 mb-2 text-zinc-900">
                                    <div>
                                        <div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold mb-1">Location</div>
                                        ${isWithinOneHour 
                                            ? `<div class="font-bold text-amber-700 leading-tight">${state.currentDrop.exactLocation}</div>` 
                                            : `<div class="font-semibold text-sm blur-reveal" title="Wird 1h vorher freigeschaltet">${state.currentDrop.blurLocation}</div>
                                               <div class="text-xs text-red-500 mt-1 font-bold">Unlocks in: ${formatTimeLeft(msUntilEvent - 3600000)}</div>`
                                        }
                                    </div>
                                    
                                    ${state.currentDrop.phase !== 'lobby' ? `<div class="bg-white/50 p-3 rounded-lg border border-black/10 shadow-sm"><div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold mb-1">Your Prop (Requisite)</div><div class="font-semibold text-sm italic">${state.currentDrop.prop}</div></div><div class="bg-white/50 p-3 rounded-lg border border-black/10 shadow-sm"><div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold mb-1">Secret Password</div><div class="font-semibold text-sm italic">${state.currentDrop.secretDrink}</div></div>` : ''}
                                    
                                    <div class="flex justify-between pt-4 border-t border-black/10">
                                        <div><div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold">Time</div><div class="font-semibold">${formatEventDate(state.currentDrop.eventTime)}</div></div>
                                        <div class="text-right"><div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold">Your Alias</div><div class="font-semibold italic text-amber-700">${state.profile?.alias}</div></div>
                                    </div>
                                </div>
                            </div>
                            <div class="ticket-stub" id="ticket-stub" onmousedown="window.startTear(event)" ontouchstart="window.startTear(event)">
                                <div class="text-xs text-zinc-500 animate-bounce mb-2">↓</div>
                                <span class="ticket-stub-text">ABREIßEN</span>
                            </div>
                        </div>

                        <div class="text-center mt-6 text-zinc-500 text-xs uppercase tracking-widest animate-pulse">Ziehe das Eselsohr nach unten, um die Lobby zu betreten</div>
                        <button onclick="window.shareScene()" class="w-full text-center mt-6 text-xs text-zinc-500 hover:text-amber-500 uppercase tracking-widest transition flex justify-center items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg> Share your Scene</button>
                    `;
                }
                else if (state.view === 'room') {
                    const now = Date.now() + state.devTimeOffset;

                    if (state.currentDrop.phase === 'lobby') {
                        if(state.showBreathe) {
                            html += `
                                <div class="absolute inset-0 flex flex-col items-center justify-center bg-[#09090b] z-50 p-6 text-center pointer-events-auto">
                                    <button onclick="window.toggleBreathe()" class="absolute top-8 right-8 text-zinc-500 hover:text-white uppercase tracking-widest text-xs font-bold transition">Zurück</button>
                                    <h2 class="text-3xl serif italic mb-12 text-zinc-300">Ground Yourself.</h2>
                                    <div class="relative w-48 h-48 flex items-center justify-center"><div class="absolute inset-0 bg-amber-500/20 rounded-full animate-breathe blur-xl"></div><div class="absolute inset-4 border border-amber-500/30 rounded-full animate-breathe" style="animation-delay: 0.5s"></div><div class="w-24 h-24 bg-zinc-800 rounded-full z-10 flex items-center justify-center shadow-2xl border border-zinc-700/50"><span class="text-xs uppercase tracking-widest text-amber-500 font-bold">Breathe</span></div></div>
                                    <p class="text-zinc-500 text-sm mt-12 max-w-xs leading-relaxed">Atme 4 Sekunden ein. Halte 7 Sekunden. Atme 8 Sekunden aus. Du bist sicher.</p>
                                </div>
                            `;
                        } else {
                            html += `
                                <div class="absolute inset-0 flex flex-col bg-[#09090b] z-50 pointer-events-auto pb-20">
                                    <div class="p-6 border-b border-zinc-800/50 flex justify-between items-center backdrop-blur-md bg-zinc-900/50 pt-10">
                                        <div><h3 class="font-bold text-zinc-100 serif italic text-xl">The Lobby</h3><div class="text-[10px] uppercase tracking-widest text-amber-500 font-bold mt-1">Starts at ${formatEventDate(state.currentDrop.eventTime)}</div></div>
                                        <div class="flex items-center gap-4"><button onclick="window.toggleBreathe()" class="text-amber-500/70 hover:text-amber-500 transition" title="Nervous?"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button><button onclick="window.setView('ticket')" class="text-zinc-500 hover:text-white uppercase tracking-widest text-xs font-bold transition">Leave</button></div>
                                    </div>
                                    <div id="chat_messages" class="flex-1 overflow-y-auto p-6 chat-scroll flex flex-col gap-6 bg-gradient-to-b from-transparent to-zinc-900/50">
                                        <div class="text-center my-4"><span class="bg-zinc-800 text-zinc-400 text-[10px] uppercase tracking-widest px-4 py-2 rounded-full border border-zinc-700/50 shadow-sm">Anonymous connection to the cast.</span></div>
                                        ${state.messages.map(msg => { const isMe = msg.senderId === state.user?.uid; return `<div class="max-w-[85%] ${isMe ? 'self-end text-right' : 'self-start'}"><div class="text-[10px] uppercase tracking-widest ${isMe ? 'text-amber-500/70' : 'text-zinc-500'} mb-1 font-bold">${isMe ? 'You' : msg.senderAlias}</div><div class="${isMe ? 'bg-amber-900/20 text-amber-50 border border-amber-900/30' : 'bg-zinc-800/50 text-zinc-200 border border-zinc-700/50'} p-4 rounded-2xl ${isMe ? 'rounded-tr-sm' : 'rounded-tl-sm'} shadow-sm text-sm font-medium leading-relaxed backdrop-blur-sm">${msg.text}</div></div>`; }).join('')}
                                    </div>
                                    <div class="p-4 bg-zinc-900/80 border-t border-zinc-800/50 backdrop-blur-md pb-8"><div class="flex gap-2 relative max-w-lg mx-auto"><input id="chat_input" type="text" class="flex-1 p-4 bg-zinc-950/50 rounded-xl border border-zinc-800 outline-none focus:border-amber-500/50 text-zinc-200 transition shadow-inner" placeholder="Whisper something..." onkeypress="if(event.key === 'Enter') window.sendMessage()"><button onclick="window.sendMessage()" class="bg-zinc-100 text-zinc-900 px-6 rounded-xl font-bold hover:bg-white transition shadow-[0_0_15px_rgba(255,255,255,0.1)]">➔</button></div></div>
                                </div>
                            `;
                        }
                    } else if (state.currentDrop.phase === 'live') {
                        const qIndex = state.currentDrop.activeQuestIndex || 0;
                        const quest = state.currentDrop.quests[qIndex] || "Keine Quests verfügbar.";
                        
                        const timeLimit = 15 * 60 * 1000;
                        const elapsed = now - (state.currentDrop.questStartTime || now);
                        const timeLeft = Math.max(0, timeLimit - elapsed);
                        const progressPercent = Math.min(100, (elapsed / timeLimit) * 100);
                        
                        const totalParticipants = Math.max(1, (state.currentDrop.totalSpots || 4) - state.currentDrop.spotsLeft);
                        const votes = state.currentDrop.readyVotes?.length || 0;
                        const hasVoted = state.currentDrop.readyVotes?.includes(state.user?.uid);

                        html += `
                            <div class="absolute inset-0 flex flex-col bg-[#09090b] z-50 items-center justify-center p-6 text-center pointer-events-auto pb-20">
                                <button onclick="window.setView('ticket')" class="absolute top-8 right-8 text-zinc-500 hover:text-white uppercase tracking-widest text-xs font-bold transition">Ticket</button>
                                
                                <div class="mb-12">
                                    <h2 class="text-4xl serif italic mb-3 gold-text">Eure Szene.</h2>
                                    <p class="text-zinc-400 text-sm tracking-widest uppercase">Lass die Geschichte sich entfalten.</p>
                                </div>
                                
                                <div class="w-full max-w-sm bg-zinc-900/80 border border-zinc-700/50 rounded-3xl p-8 backdrop-blur-md shadow-[0_0_50px_rgba(0,0,0,0.6)] flex flex-col items-center">
                                    <div class="w-full flex justify-between text-[10px] uppercase tracking-widest text-amber-500 font-bold mb-4">
                                        <span>Quest ${qIndex + 1} / ${state.currentDrop.quests.length}</span>
                                        <span class="font-mono">${formatMMSS(timeLeft)}</span>
                                    </div>
                                    
                                    <h3 class="text-2xl serif italic text-white leading-relaxed mb-8 flex-1 flex items-center">${quest}</h3>
                                    
                                    <div class="w-full h-1.5 bg-zinc-800 rounded-full mb-8 overflow-hidden shadow-inner">
                                        <div class="h-full bg-amber-500/80 progress-bar-smooth shadow-[0_0_10px_rgba(217,119,6,0.8)]" style="width: ${progressPercent}%"></div>
                                    </div>

                                    <button onclick="window.voteReady()" class="w-full border ${hasVoted ? 'bg-emerald-900/40 border-emerald-500/50 text-emerald-400' : 'bg-zinc-800 border-zinc-700 hover:bg-zinc-700 text-zinc-300'} py-3 rounded-xl text-xs uppercase tracking-widest font-bold transition flex justify-center items-center gap-2">
                                        ${hasVoted ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Warten auf andere' : 'Wir sind fertig'} 
                                        <span class="bg-black/30 px-2 py-0.5 rounded ml-2">${votes}/${totalParticipants}</span>
                                    </button>
                                </div>
                            </div>
                        `;
                    } else if (state.currentDrop.phase === 'intermission') {
                        const breakDuration = 60 * 1000;
                        const elapsed = now - (state.currentDrop.intermissionStartTime || now);
                        const breakLeft = Math.max(0, breakDuration - elapsed);

                        html += `
                            <div class="absolute inset-0 flex flex-col bg-[#09090b] z-50 items-center justify-center p-6 text-center pointer-events-auto pb-20">
                                <h2 class="text-4xl serif italic mb-4 text-blue-300">Kurze Pause.</h2>
                                <p class="text-zinc-400 text-sm max-w-xs leading-relaxed mb-12">Atmet durch. Geht zur Bar oder sammelt eure Gedanken. Gleich geht die nächste Runde los.</p>
                                
                                <div class="relative w-32 h-32 flex items-center justify-center">
                                    <svg class="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="45" fill="none" stroke="#1f2937" stroke-width="4"></circle>
                                        <circle cx="50" cy="50" r="45" fill="none" stroke="#93c5fd" stroke-width="4" stroke-dasharray="283" stroke-dashoffset="${283 - (breakLeft/breakDuration)*283}" class="transition-all duration-1000 ease-linear"></circle>
                                    </svg>
                                    <div class="text-2xl font-mono text-white">${formatMMSS(breakLeft)}</div>
                                </div>
                            </div>
                        `;
                    } else if (state.currentDrop.phase === 'credits') {
                        html += `
                            <div class="absolute inset-0 flex flex-col bg-[#09090b] z-50 p-6 overflow-y-auto pb-20 pointer-events-auto">
                                <button onclick="window.setView('ticket')" class="absolute top-8 right-8 text-zinc-500 hover:text-white uppercase tracking-widest text-xs font-bold transition">Close</button>
                                <div class="text-center mt-12 mb-10"><h2 class="text-4xl serif italic mb-3">The End.</h2><p class="text-zinc-400 text-sm max-w-sm mx-auto leading-relaxed">Wie möchtest du connecten? Kein Druck, alles anonym.</p></div>
                                <div class="max-w-sm mx-auto w-full space-y-6">
                                    <div>
                                        <label class="flex flex-col p-4 border border-zinc-800 rounded-2xl cursor-pointer hover:bg-zinc-900 transition group mb-3">
                                            <div class="flex justify-between items-center mb-1"><span class="font-bold text-zinc-300">Kein Vibe</span><input type="radio" name="credit_option" value="none" class="accent-amber-500"></div><span class="text-xs text-zinc-500">Unsere Wege trennen sich hier.</span>
                                        </label>
                                        <label class="flex flex-col p-4 border border-zinc-800 rounded-2xl cursor-pointer hover:bg-zinc-900 transition group mb-3">
                                            <div class="flex justify-between items-center mb-1"><span class="font-bold text-amber-500">Casual Coffee</span><input type="radio" name="credit_option" value="coffee" class="accent-amber-500"></div><span class="text-xs text-zinc-500">War sympathisch! Lass in 7 Tagen Nummern tauschen.</span>
                                        </label>
                                        <label class="flex flex-col p-4 border border-amber-900/30 rounded-2xl cursor-pointer hover:bg-amber-900/40 transition group shadow-[0_0_15px_rgba(217,119,6,0.1)]">
                                            <div class="flex justify-between items-center mb-1"><span class="font-bold text-fuchsia-400">Deep Talk</span><input type="radio" name="credit_option" value="deep" class="accent-fuchsia-500"></div><span class="text-xs text-fuchsia-200/50">Da war was. Geheimen In-App Briefkasten öffnen.</span>
                                        </label>
                                    </div>
                                    <button onclick="window.submitCredits()" class="w-full bg-zinc-100 text-black font-bold py-4 rounded-xl mt-4 uppercase tracking-widest text-sm hover:bg-white transition">Credits rollen</button>
                                </div>
                            </div>
                        `;
                    }
                }

                html += `</div>`;

                if (state.showSettings) {
                    html += `
                        <div class="fixed inset-0 bg-zinc-950/90 z-[9999] p-6 flex flex-col justify-center animate-fade-in pointer-events-auto">
                            <div class="bg-zinc-900 border border-zinc-800 rounded-3xl p-8 max-w-sm w-full mx-auto shadow-2xl relative">
                                <div class="flex justify-between items-center mb-6"><h2 class="text-2xl serif italic">Settings</h2><button onclick="window.toggleSettings()" class="text-zinc-500 hover:text-white transition">✕</button></div>
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-xs uppercase tracking-widest text-zinc-500 font-bold block mb-2">Location</label>
                                        <select onchange="window.changeCity(event)" class="w-full bg-zinc-950 border border-zinc-800 p-3 rounded-xl text-sm outline-none focus:border-amber-500 transition">
                                            ${CITIES.map(c => `<option value="${c}" ${state.selectedCity === c ? 'selected' : ''}>${c}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="p-4 bg-amber-900/10 border border-amber-500/20 rounded-xl mt-4 flex justify-between items-center">
                                        <div>
                                            <div class="text-[10px] uppercase tracking-widest text-amber-500 font-bold mb-1">Your Alias</div>
                                            <div class="font-serif italic text-lg text-zinc-200">${state.profile?.alias || 'The Stranger'}</div>
                                        </div>
                                        <button onclick="window.regenerateAlias()" class="text-xs bg-amber-900/50 text-amber-400 px-3 py-1.5 rounded hover:bg-amber-800/50 transition border border-amber-700/50">Reroll</button>
                                    </div>
                                </div>
                                <div class="mt-8 space-y-2 border-t border-zinc-800 pt-6">
                                    <button onclick="window.resetPassword()" class="w-full text-left p-3 text-sm text-zinc-400 hover:bg-zinc-800 hover:text-zinc-100 transition rounded-lg">Passwort zurücksetzen</button>
                                    <button onclick="window.handleLogout()" class="w-full text-left p-3 text-sm text-zinc-400 hover:bg-zinc-800 hover:text-zinc-100 transition rounded-lg">Ausloggen</button>
                                    <button onclick="window.deleteAcc()" class="w-full text-left p-3 text-sm text-red-500 hover:bg-red-950/50 transition rounded-lg">Account löschen</button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                appDiv.innerHTML = html;
            } catch (err) {
                appDiv.innerHTML = `<div class="max-w-lg mx-auto mt-20 p-8 bg-red-900/30 border border-red-500 text-red-200 rounded-xl">Render Fehler: ${err.message}</div>`;
            }
        }
    </script>
</body>
</html>


