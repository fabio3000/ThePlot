<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>The Plot | Your life is a movie.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
/* --- BASIS & SCROLL-LOGIK --- */
html, body { 
    margin: 0;
    padding: 0;
    font-family: 'Inter', sans-serif; 
    background-color: #09090b; 
    color: #f4f4f5; 
    background-image: radial-gradient(circle at 50% 0%, #27272a 0%, #09090b 70%); 
    min-height: 100vh;
    width: 100vw;
    
    /* Erlaubt vertikales Scrollen, verhindert aber das Zoomen durch Gesten */
    touch-action: pan-y; 
    -webkit-text-size-adjust: 100%;
    overflow-x: hidden; /* Verhindert seitliches Wackeln */
    overflow-y: auto;
}

h1, h2, h3, .serif { font-family: 'Playfair Display', serif; }

/* --- VISUELLE EFFEKTE --- */
.film-grain { 
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
    pointer-events: none; z-index: 50; opacity: 0.04; 
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); 
}

.gold-text { 
    background: linear-gradient(to right, #fbbf24, #d97706); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; 
}

.paper-texture { position: relative; }
.paper-texture::after { 
    content: ''; position: absolute; inset: 0; 
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='paperNoise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23paperNoise)' opacity='0.08'/%3E%3C/svg%3E"); 
    pointer-events: none; z-index: 10; mix-blend-mode: multiply; border-radius: inherit; 
}

/* --- TICKET-SYSTEM --- */
.ticket-wrapper { 
    display: flex; 
    perspective: 1000px; 
    position: relative; 
    gap: 2px; 
    user-select: none; 
    -webkit-user-select: none; 
    margin: 20px auto;
    max-width: 95%; /* Verhindert, dass das Ticket am Rand klebt */
}

.ticket-main { 
    flex: 1; 
    background: linear-gradient(135deg, #f4f4f5 0%, #e4e4e7 100%); 
    border-radius: 16px 0 0 16px; 
    padding: 32px; 
    position: relative; 
    box-shadow: -5px 10px 30px rgba(0,0,0,0.5); 
    border-right: 3px dashed #9ca3af; 
    transition: border-color 0.5s; 
    overflow: hidden; 
}

.ticket-stub { 
    width: 80px; 
    background: linear-gradient(135deg, #e4e4e7 0%, #d4d4d8 100%); 
    border-radius: 0 16px 16px 0; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    position: relative; 
    cursor: grab; 
    box-shadow: 5px 10px 30px rgba(0,0,0,0.5); 
    transform-origin: top left; 
    transition: transform 0.1s ease-out; 
    
    /* WICHTIG: Keine Browser-Gesten auf dem Stub, damit Dragging flüssig läuft */
    touch-action: none; 
    overflow: hidden; 
}

.ticket-stub:active { cursor: grabbing; }

.ticket-stub::before { 
    content: ''; position: absolute; top: 0; right: 0; border-width: 0 45px 45px 0; 
    border-style: solid; border-color: #09090b #09090b #ffffff #ffffff; 
    border-radius: 0 16px 0 0; box-shadow: -3px 3px 8px rgba(0,0,0,0.3); 
    z-index: 12; pointer-events: none; transition: border-width 0.2s ease; 
}

.ticket-stub-text { 
    writing-mode: vertical-rl; 
    transform: rotate(180deg); 
    color: #52525b; 
    font-weight: 900; 
    text-transform: uppercase; 
    letter-spacing: 4px; 
    font-size: 14px; 
    pointer-events: none; 
    position: relative; 
    z-index: 11; 
}

/* Zerreiß-Effekt */
.ticket-wrapper.torn .ticket-stub { 
    transform: rotate(25deg) translateY(300px) translateX(50px) scale(0.9); 
    opacity: 0; 
    pointer-events: none; 
    transition: transform 0.8s cubic-bezier(0.55, 0.085, 0.68, 0.53), opacity 0.6s ease; 
}
.ticket-wrapper.torn .ticket-main { border-right-color: transparent; }

/* --- UI-ELEMENTE & TOASTS --- */
.chat-scroll { 
    overflow-y: auto !important; 
    touch-action: pan-y !important; 
    -webkit-overflow-scrolling: touch;
}
.chat-scroll::-webkit-scrollbar { width: 4px; }
.chat-scroll::-webkit-scrollbar-thumb { background-color: #52525b; border-radius: 10px; }

.blur-reveal { filter: blur(8px); user-select: none; transition: filter 1.5s ease; }

#toast-container { position: fixed; top: 20px; right: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
.toast { 
    pointer-events: auto; background: rgba(24, 24, 27, 0.95); backdrop-filter: blur(8px); 
    border: 1px solid #3f3f46; color: white; padding: 16px 24px; border-radius: 12px; 
    font-size: 14px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); transform: translateX(120%); 
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 12px; 
}
.toast.show { transform: translateX(0); }
.toast.error { border-left: 4px solid #ef4444; }
.toast.success { border-left: 4px solid #10b981; }

/* Animationen */
@keyframes breathe { 0% { transform: scale(1); opacity: 0.5; } 40% { transform: scale(1.5); opacity: 0.1; } 100% { transform: scale(1); opacity: 0.5; } }
.animate-breathe { animation: breathe 8s infinite ease-in-out; }

.torn-edge { 
    background-image: radial-gradient(circle at 5px 0, transparent 6px, #e4e4e7 7px); 
    background-size: 16px 10px; background-repeat: repeat-x; height: 10px; width: 100%; 
    position: absolute; top: -10px; left: 0; transform: rotate(180deg); 
}

@keyframes pulse-gold {
    0% { box-shadow: 0 0 5px rgba(217, 119, 6, 0.2); border-color: rgba(217, 119, 6, 0.3); }
    50% { box-shadow: 0 0 20px rgba(217, 119, 6, 0.5); border-color: rgba(217, 119, 6, 0.8); }
    100% { box-shadow: 0 0 5px rgba(217, 119, 6, 0.2); border-color: rgba(217, 119, 6, 0.3); }
}
.animate-pulse-gold { animation: pulse-gold 2s infinite ease-in-out; }


    </style>
 

</head>
<body class="flex flex-col relative">
    <div class="film-grain"></div>
    <div id="toast-container"></div>

    <div id="app" class="flex-1 flex flex-col pb-24 z-10 relative">
        <div class="text-center mt-40 flex flex-col items-center">
            <div class="w-16 h-16 border-t-2 border-l-2 border-amber-500 rounded-full animate-spin mb-6"></div>
            <div class="text-2xl serif italic text-zinc-400">Loading your scene...</div>
        </div>
    </div>

    <!-- Dev Menu -->
    <div id="dev-menu" class="fixed bottom-16 left-4 z-[9990] bg-zinc-900/90 border border-zinc-700 p-4 rounded-xl backdrop-blur-md opacity-20 hover:opacity-100 transition-opacity pointer-events-auto shadow-2xl hidden max-w-[200px]">
        <div class="text-[9px] uppercase tracking-widest text-amber-500 font-bold text-center mb-2">Director's Time Machine</div>
        <div class="flex flex-col gap-2">
            <button onclick="window.adminTimeTravel('reveal')" class="px-2 py-1 bg-zinc-800 text-[10px] text-zinc-300 rounded hover:bg-zinc-700 transition">+1h (Reveal)</button>
            <button onclick="window.adminTimeTravel('start')" class="px-2 py-1 bg-amber-900/50 text-[10px] text-amber-400 rounded border border-amber-700/50 hover:bg-amber-800/50 transition">Start Event!</button>
        </div>
    </div>

    <button id="floating-chat-btn" onclick="window.setView('chats')" class="fixed bottom-6 right-6 bg-zinc-800 border border-zinc-600 p-4 rounded-full shadow-2xl text-amber-500 hover:text-amber-400 hover:bg-zinc-700 transition z-40 hidden group">
        <svg class="w-6 h-6 group-hover:scale-110 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
    </button>

    <div id="dev-skip-btn" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 hidden pointer-events-auto">
        <button onclick="window.devSkipToLastQuest()" class="bg-red-900/80 text-red-200 border border-red-700/50 px-3 py-1 rounded-full text-[10px] uppercase tracking-widest font-bold shadow-lg hover:bg-red-800 transition">Dev: Finale (5s)</button>
    </div>

    <!-- Versionsnummer -->
    <div class="fixed bottom-4 left-4 z-50 text-[10px] text-zinc-600 font-mono select-none pointer-events-none">
        0.9.12 Beta
    </div>
   <script src="https://www.paypal.com/sdk/js?client-id=AboxAT2qskA0lY5-23Kj2tu_qY3bOK57rq_LbhtE_cdVOBT37fSHGacBKjgl-zx1XcJM9AZql96OCwc8&currency=EUR"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, deleteUser } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, addDoc, onSnapshot, getDocs, updateDoc, deleteDoc, query, where, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let apiKey = "";
        try {
            const configModule = await import('./config.js');
            apiKey = configModule.PLOT_CONFIG.GEMINI_API_KEY;
        } catch(e) { console.warn("config.js nicht gefunden."); }

        const firebaseConfig = {
  apiKey: "AIzaSyDtwsvmYSONjFufhbJ5I8G_RAMffnh7re0",
  authDomain: "theplot-app.firebaseapp.com",
  projectId: "theplot-app",
  storageBucket: "theplot-app.firebasestorage.app",
  messagingSenderId: "550703275210",
  appId: "1:550703275210:web:81bc0e5a373f87a3c92833"
};

        let appInit, auth, db;
        const CITIES = ["Köln", "Berlin", "Hamburg", "München"];
       const ADJECTIVES = [
    "Silent", "Midnight", "Ethereal", "Velvet", "Neon", "Cosmic", "Lucid", "Crimson", "Golden", 
    "Wandering", "Hidden", "Fading", "Distant", "Electric", "Astral", "Quiet", "Restless", "Bright",
    "Melancholic", "Serene", "Infinite", "Gloaming", "Radiant", "Obscure", "Vivid", "Hollow", 
    "Urban", "Wild", "Solitary", "Fragile", "Brave", "Merciless", "Ancient", "Modern", "Lost",
    "Mystic", "Savage", "Frozen", "Burning", "Lunar", "Solar", "Secret", "Broken", "Polished",
    "Rough", "Gentle", "Haunted", "Blessed", "Cursed", "Heavy", "Weightless", "Indigo", "Amber",
    "Silver", "Shadowy", "Illuminated", "Hidden", "Patient", "Swift", "Cunning", "Naive",
    "Grim", "Joyful", "Bitter", "Sweet", "Floral", "Metallic", "Organic", "Digital", "Analog",
    "Drifting", "Anchored", "Nomadic", "Static", "Vibrant", "Pale", "Deep", "Shallow", "Wide",
    "Narrow", "Echoing", "Muted", "Thunderous", "Soft", "Sharp", "Blurry", "Clear", "Vague",
    "Primal", "Sophisticated", "Rustic", "Industrial", "Nocturnal", "Diurnal", "Eternal", "Brief"
];

const NOUNS = [
    "Observer", "Thinker", "Dreamer", "Poet", "Architect", "Stranger", "Wanderer", "Muse", 
    "Director", "Alchemist", "Nomad", "Oracle", "Traveler", "Illusionist", "Writer", "Artist",
    "Protagonist", "Shadow", "Ghost", "Visionary", "Legend", "Outsider", "Pilot", "Sailor", 
    "Explorer", "Seeker", "Merchant", "Gardener", "Smith", "Herald", "Scholar", "Engine",
    "Compass", "Anchor", "Flame", "Wave", "Mountain", "Forest", "Desert", "Mirror", "Key",
    "Gate", "Path", "Bridge", "Tower", "Cell", "Sanctuary", "Rebel", "Guardian", "Hunter",
    "Prey", "King", "Queen", "Knight", "Pawn", "Bishop", "Rook", "Wolf", "Lion", "Raven",
    "Eagle", "Owl", "Snake", "Dragon", "Phoenix", "Spirit", "Soul", "Body", "Mind", "Heart",
    "Memory", "Future", "Past", "Present", "Moment", "Void", "Cloud", "Storm", "Breeze",
    "Ocean", "River", "Stone", "Leaf", "Flower", "Seed", "Root", "Star", "Moon", "Sun"
];


        
        let state = { 
            user: null, view: 'loading', profile: null, currentDrop: null, allDrops: [],
            hasTicket: false, messages: [], authMode: 'login', logoClicks: 0,
            showSettings: false, showDirectorLogin: false, showBreathe: false, selectedCity: "Köln", aiLoading: false,
            editingDropId: null, openChatId: null, devTimeOffset: 0, socialBattery: null, tempEmail: ''
        };

        const appDiv = document.getElementById('app');
        let countdownInterval;
        let isTransitioning = false; 
        let isRegistering = false; 
        let unsubs = []; 

        window.showToast = (msg, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = `<svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            if(type === 'success') icon = `<svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            if(type === 'error') icon = `<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77-1.333.192 3 1.732 3z"></path></svg>`;
            toast.innerHTML = `${icon} <div><div class="font-bold text-xs uppercase tracking-widest text-zinc-400 mb-0.5">Notification</div><div>${msg}</div></div>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 4000);
        };

        window.shareScene = () => {
            if(!state.currentDrop) return;
            const text = `Mein Vibe ist ${state.profile?.alias}. Ich gehe auf ein Secret Solo-Date in ${state.currentDrop.city}. Werde Teil der Storyline: theplot.app`;
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.select();
            try { document.execCommand('copy'); window.showToast('Ticket kopiert! Poste deinen Vibe.', 'success'); } 
            catch (err) { window.showToast('Kopieren fehlgeschlagen.', 'error'); }
            document.body.removeChild(textArea);
        };

window.sendBroadcast = async () => {
    const input = document.getElementById('broadcast_input');
    const text = input.value.trim();
    if (!text || !state.currentDrop) return;
    
    try {
        await addDoc(collection(db, `plot_messages_${state.currentDrop.id}`), { 
            senderId: 'director', 
            senderAlias: 'Director', 
            text: text, 
            timestamp: Date.now(), 
            isSystem: false,
            isBroadcast: true // Neues Flag für das Design
        });
        input.value = '';
        window.showToast("Broadcast gesendet.", "success");
    } catch (e) { console.error(e); }
};

window.generateShareCard = () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 1080;
    canvas.height = 1920;

    // Aktuelle Zeit-Daten für das Branding
    const now = new Date();
    const currentYear = now.getFullYear(); // Zieht dynamisch 2026
    const formattedDate = now.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });

    // 1. Tiefschwarzer Hintergrund (OLED Ready)
    ctx.fillStyle = '#09090b';
    ctx.fillRect(0, 0, 1080, 1920);

    // 2. High-Quality Film Grain (TikTok Grain Texture)
    ctx.globalAlpha = 0.15;
    for (let i = 0; i < 40000; i++) {
        ctx.fillStyle = Math.random() > 0.5 ? '#ffffff' : '#000000';
        ctx.fillRect(Math.random() * 1080, Math.random() * 1920, 2, 2);
    }
    ctx.globalAlpha = 1.0;

    // 3. Subtiles Glühen hinter dem Namen
    const aura = ctx.createRadialGradient(540, 960, 0, 540, 960, 600);
    aura.addColorStop(0, 'rgba(251, 191, 36, 0.05)');
    aura.addColorStop(1, 'transparent');
    ctx.fillStyle = aura;
    ctx.fillRect(0, 0, 1080, 1920);

    // 4. Branding "The Plot."
    ctx.fillStyle = '#f4f4f5';
    ctx.font = 'italic 700 80px "Playfair Display", serif';
    ctx.textAlign = 'center';
    ctx.fillText('The Plot.', 540, 300);

    // 5. Der Alias als Main Title (Serif Elegance)
    ctx.fillStyle = '#ffffff';
    ctx.font = 'italic 700 110px "Playfair Display", serif';
    ctx.fillText(state.profile?.alias || 'The Stranger', 540, 960);

    // 6. Cineastische Credit-Line
    ctx.fillStyle = '#71717a';
    ctx.font = '400 35px "Inter", sans-serif';
    ctx.letterSpacing = "15px";
    ctx.fillText('ROLE ASSIGNED', 540, 1050);

    // 7. Footer - Dynamische Daten
    ctx.fillStyle = '#3f3f46';
    ctx.letterSpacing = "3px";
    ctx.font = '700 28px "Inter", sans-serif';
    ctx.textAlign = 'center';
    
    // Untere Credits im Movie-Stil
    ctx.fillText(`PRODUCED IN ${state.selectedCity.toUpperCase()} • ${currentYear}`, 540, 1750);
    ctx.font = '400 22px "Inter", sans-serif';
    ctx.fillText(`SCENE DATE: ${formattedDate} • ENTRANCE GRANTED`, 540, 1810);

    // Download-Trigger
    const dataUrl = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.download = `ThePlot_${state.profile?.alias}_${currentYear}.png`;
    link.href = dataUrl;
    link.click();
    window.showToast("Cineastische Card generiert.", "success");
};


        window.setApiKey = () => {
            const currentKey = localStorage.getItem('plot_gemini_key') || "";
            const key = prompt("Google Gemini API Key eingeben (nur für Admin):", currentKey);
            if (key !== null) {
                localStorage.setItem('plot_gemini_key', key.trim());
                window.showToast("API Key sicher lokal gespeichert.", "success");
            }
        };


async function generateUniqueAlias() {
    // Wählt komplett zufällig aus den vollen Listen
    const adj = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
    const noun = NOUNS[Math.floor(Math.random() * NOUNS.length)];
    
    return `The ${adj} ${noun}`; 
}




        function clearListeners() {
            unsubs.forEach(u => u());
            unsubs = [];
            if(window.unsubChat) { window.unsubChat(); window.unsubChat = null; }
            if(countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
        }

             
                    try {
            appInit = initializeApp(firebaseConfig);
            auth = getAuth(appInit);
            db = getFirestore(appInit);
            
            onAuthStateChanged(auth, async (user) => {
                state.user = user;
                if (user) {
                    clearListeners();

                    const unsubProfile = onSnapshot(doc(db, 'plot_users', user.uid), (docSnap) => {
                        if (docSnap.exists()) {
                            state.profile = docSnap.data();
                            state.selectedCity = state.profile.city || state.selectedCity;
                            
                            if (state.view === 'loading') {
                                state.view = 'home'; 
                            }
                            checkRouting();
                            render(true);
                        } else if (!isRegistering) {
                            state.profile = { 
                                hasPremium: false, tickets: [], completedDrops: [], 
                                alias: "The Stranger", isAdmin: false, city: state.selectedCity,
                                extraTickets: 0, monthlyTicketsUsed: 0
                            };
                            setDoc(doc(db, 'plot_users', user.uid), state.profile);
                            state.view = 'home';
                            render(true);
                        }
                    });
                    unsubs.push(unsubProfile);

                    const unsubDrops = onSnapshot(collection(db, 'plot_drops'), (snap) => {
                        const allDrops = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        state.allDrops = allDrops;
                        
                        const completed = state.profile?.completedDrops || [];
                        
                        state.currentDrop = allDrops.find(d => {
                            if (!d.isActive || d.city !== state.selectedCity || completed.includes(d.id)) return false;
                            const hasTicket = state.profile?.tickets?.includes(d.id);
                            if ((d.phase === 'credits' || d.phase === 'finale') && !hasTicket) return false;
                            return true;
                        }) || null;
                        
                        if(state.currentDrop) {
                            state.hasTicket = state.profile?.tickets?.includes(state.currentDrop.id) || false;
                            if (window.unsubChat) window.unsubChat();
                            window.unsubChat = onSnapshot(collection(db, `plot_messages_${state.currentDrop.id}`), (msgSnap) => {
                                state.messages = msgSnap.docs.map(d => d.data()).sort((a,b) => a.timestamp - b.timestamp);
                                if(state.view === 'room') { render(); scrollToBottom(); }
                            });
                            if(!countdownInterval) countdownInterval = setInterval(automatedPacingLogic, 1000);
                        }
                        
                        checkRouting();
                        render();
                    });
                    unsubs.push(unsubDrops);
                    
                    
                                        // 3. Pricing-Snapshot (NEU)
                    const unsubPricing = onSnapshot(doc(db, 'system', 'pricing'), (docSnap) => {
                        if (docSnap.exists()) {
                            state.bundlePrice = docSnap.data().bundlePrice;
                        } else {
                            state.bundlePrice = '15.00';
                            setDoc(doc(db, 'system', 'pricing'), { bundlePrice: '15.00' });
                        }
                        if (state.view === 'paywall') render();
                    });
                    unsubs.push(unsubPricing);



                } else {
                    clearListeners();
                    state.user = null; state.profile = null;
                    state.view = 'auth'; 
                    render(true);
                }
            });
        } catch(error) { 
            window.showToast("Systemfehler: " + error.message, "error"); 
        }


        // ==========================================
        // AUTOMATION (Datenbank-Driven)
        // ==========================================
        async function automatedPacingLogic() {
            if (!state.currentDrop && state.view !== 'chats') return;
            const now = Date.now() + state.devTimeOffset;
            
            let needsVisualTick = false;
            if (state.view === 'ticket') needsVisualTick = true;
            if (state.view === 'room' && state.currentDrop && (state.currentDrop.phase === 'live' || state.currentDrop.phase === 'intermission')) needsVisualTick = true;
            if (state.view === 'chats' && !state.openChatId) needsVisualTick = true; 

            try {
                if (state.currentDrop && state.currentDrop.phase === 'lobby' && state.currentDrop.eventTime && now >= state.currentDrop.eventTime) {
                    isTransitioning = true;
                    await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), { phase: 'live', activeQuestIndex: 0, questStartTime: now, readyVotes: [] });
                    isTransitioning = false;
                }
                else if (state.currentDrop && state.currentDrop.phase === 'live' && state.currentDrop.questStartTime) {
                    const questDuration = 15 * 60 * 1000; 
                    if (now - state.currentDrop.questStartTime >= questDuration) {
                        isTransitioning = true; 
                        const isLastQuest = (state.currentDrop.activeQuestIndex || 0) >= (state.currentDrop.quests?.length - 1);
                        if(isLastQuest) {
                            await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), { phase: 'finale', readyVotes: [] });
                        } else {
                            await window.advanceToIntermission(); 
                        }
                        isTransitioning = false;
                    }
                }
                else if (state.currentDrop && state.currentDrop.phase === 'intermission' && state.currentDrop.intermissionStartTime) {
                    const breakDuration = 60 * 1000; 
                    if (now - state.currentDrop.intermissionStartTime >= breakDuration) {
                        isTransitioning = true; await window.advanceToNextQuest(); isTransitioning = false;
                    }
                }
            } catch(e) { isTransitioning = false; }
            
            if(needsVisualTick) render();
        }

        window.advanceToIntermission = async () => { await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), { phase: 'intermission', intermissionStartTime: Date.now() + state.devTimeOffset, readyVotes: [] }); };
        window.advanceToNextQuest = async () => {
            const nextIdx = (state.currentDrop.activeQuestIndex || 0) + 1;
            if(nextIdx >= (state.currentDrop.quests?.length || 1)) {
                await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), { phase: 'finale' });
            } else {
                await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), { phase: 'live', activeQuestIndex: nextIdx, questStartTime: Date.now() + state.devTimeOffset, readyVotes: [] });
            }
        };

        window.advanceToCredits = async () => {
            if(state.profile.isAdmin) {
                await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), { phase: 'credits' });
            } else {
                // Wenn kein Admin klickt, ändern wir die Phase nicht global, sondern springen lokal (sollte eigentlich Admin-gesteuert sein, 
                // aber für den reibungslosen Ablauf setzen wir die Phase für alle auf Credits, sobald der Erste klickt).
                await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), { phase: 'credits' });
            }
        };

        window.enterRoomFlow = () => {
            if(!state.socialBattery) {
                window.setView('battery_check');
            } else {
                window.setView('room');
            }
        };

window.setSocialBattery = async (level) => {
    const icebreaker = document.getElementById('icebreaker_input')?.value || "";
    state.socialBattery = level;
    const statusText = icebreaker ? `${level} | Frag mich nach: ${icebreaker}` : level;
    
    // NEU: Admins lösen keine Systemnachricht aus
    if (state.profile?.isAdmin) {
        window.showToast("Admin-Modus: Du bist unsichtbar beigetreten.", "info");
        window.setView('room');
        return;
    }

    const alreadyEntered = state.messages.some(m => 
        m.isSystem && m.text.includes(state.profile.alias) && m.text.includes("hat den Raum betreten")
    );
    
    if (!alreadyEntered) {
        try {
            await addDoc(collection(db, `plot_messages_${state.currentDrop.id}`), { 
                senderId: 'system', senderAlias: 'System', 
                text: `${state.profile.alias} hat den Raum betreten. Vibe: ${statusText}`, 
                timestamp: Date.now(), isSystem: true 
            });
        } catch(e) { console.error(e); }
    }
    
    window.showToast(`${level} gesetzt.`, 'info');
    window.setView('room');
};



        window.submitCredits = async () => {
    const selectedBoxes = document.querySelectorAll('input[name="match_selections"]:checked');
    const selectedIds = Array.from(selectedBoxes).map(el => el.value);
    const journalText = document.getElementById('afterglow_journal')?.value || "";
    
    try {
        await addDoc(collection(db, 'plot_connections'), { 
            userId: state.user.uid, dropId: state.currentDrop.id, 
            selections: selectedIds, timestamp: Date.now() 
        });
        
        // Speichere das Journal sicher & privat im User-Profil
        const newJournals = state.profile.journals || {};
        if (journalText.trim() !== "") newJournals[state.currentDrop.id] = journalText;
        
        await updateDoc(doc(db, 'plot_users', state.user.uid), {
            completedDrops: arrayUnion(state.currentDrop.id),
            journals: newJournals
        });
        
        window.showToast("Abend beendet. Journal gespeichert.", "success");
        window.setView('chats');
    } catch(e) { window.showToast("Fehler beim Speichern.", "error"); }
};



        window.voteReady = async () => {
            if (!state.currentDrop || state.currentDrop.phase !== 'live') return;
            const dropRef = doc(db, 'plot_drops', state.currentDrop.id);
            const currentVotes = state.currentDrop.readyVotes || [];
            
            if (!currentVotes.includes(state.user.uid)) {
                const newVotes = [...currentVotes, state.user.uid];
                await updateDoc(dropRef, { readyVotes: newVotes });
                const totalParticipants = Math.max(1, (state.currentDrop.totalSpots || 4) - state.currentDrop.spotsLeft);
                if (newVotes.length >= totalParticipants) {
                    window.showToast("Alle sind bereit. Story geht weiter!", "success");
                    const isLastQuest = (state.currentDrop.activeQuestIndex || 0) >= (state.currentDrop.quests?.length - 1);
                    if(isLastQuest) {
                        await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), { phase: 'finale', readyVotes: [] });
                    } else {
                        window.advanceToIntermission();
                    }
                } else { window.showToast("Warte auf die anderen...", "info"); }
            }
        };


        // ==========================================
        // UI & NAVIGATION
        // ==========================================
        function checkRouting() {
            const devMenu = document.getElementById('dev-menu');
            const skipBtn = document.getElementById('dev-skip-btn');
            
            if (state.profile?.isAdmin && devMenu) devMenu.classList.remove('hidden');
            else if (devMenu) devMenu.classList.add('hidden');

            if (state.profile?.isAdmin && state.currentDrop?.phase === 'live' && state.view === 'room') {
                if (skipBtn) skipBtn.classList.remove('hidden');
            } else {
                if (skipBtn) skipBtn.classList.add('hidden');
            }

            const needsRouting = ['loading', 'auth', 'nodrop', 'home', 'ticket'].includes(state.view);
            if (needsRouting && state.profile) {
                if (state.profile.isAdmin) state.view = 'admin';
                else if (!state.currentDrop) state.view = 'nodrop';
                else {
                    state.hasTicket = state.profile.tickets?.includes(state.currentDrop.id);
                    state.view = state.hasTicket ? 'ticket' : 'home';
                }
            }
        }

        function scrollToBottom() { setTimeout(() => { const chatBox = document.getElementById('chat_messages'); if (chatBox) chatBox.scrollTop = chatBox.scrollHeight; }, 50); }

      window.setView = (view) => { 
    state.view = view; state.showSettings = false; state.showBreathe = false; 
    if(view !== 'chats') state.openChatId = null;
    if(view !== 'room' && view !== 'battery_check') state.socialBattery = null; 
    checkRouting(); 
    render(true); // <-- Das 'true' erzwingt hier das Update!
};

    
    


        
        window.toggleAuthMode = () => { 
            const emailEl = document.getElementById('auth_email');
            if (emailEl) state.tempEmail = emailEl.value;
            state.authMode = state.authMode === 'login' ? 'register' : 'login'; 
            render(); 
        };
        
        window.toggleSettings = () => { state.showSettings = !state.showSettings; render(); };
        window.toggleBreathe = () => { state.showBreathe = !state.showBreathe; render(); };
        window.closeDirectorLogin = () => { state.showDirectorLogin = false; render(); };
        window.cancelEditDrop = () => { state.editingDropId = null; render(); };
        window.closeChat = () => { state.openChatId = null; render(); };

        // --- HAPTISCHE TICKET DRAG LOGIK ---
        let startY = 0;
        let dragEl = null;
        let isStub = false;
        
    window.startTear = (e) => {
    window.isTicketAnimating = true; // <-- Lock für render() aktivieren
    startY = e.touches ? e.touches[0].clientY : e.clientY;
    dragEl = document.getElementById('draggable-ticket');
    isStub = false;
    
    if(!dragEl) {
        dragEl = document.getElementById('ticket-stub');
        isStub = true;
    }
    
    if(dragEl) {
        dragEl.style.transition = 'none'; 
        document.addEventListener('mousemove', window.onTearMove, {passive: false});
        document.addEventListener('touchmove', window.onTearMove, {passive: false});
        document.addEventListener('mouseup', window.endTear);
        document.addEventListener('touchend', window.endTear);
        document.addEventListener('touchcancel', window.endTear); 
    }
};


        
            window.onTearMove = (e) => {
            if(!startY || !dragEl) return;
            e.preventDefault(); 
            let y = e.touches ? e.touches[0].clientY : e.clientY;
            let diff = y - startY;
            
            if (isStub) {
                if(diff > 0) {
                    dragEl.style.transform = `rotate(180deg) translateY(${-diff}px) rotateX(${Math.min(diff/2, 90)}deg)`;
                }
            } else {
                if(diff > 0) {
                    // Limit entfernt: Folgt dem Finger jetzt unendlich und organisch
                    dragEl.style.transform = `translateY(${diff}px) rotate(${diff * 0.03}deg)`;
                    dragEl.style.opacity = Math.max(0.3, 1 - (diff / 800)); 
                }
            }
        };
        
        window.endTear = (e) => {
    document.removeEventListener('mousemove', window.onTearMove);
    document.removeEventListener('touchmove', window.onTearMove);
    document.removeEventListener('mouseup', window.endTear);
    document.removeEventListener('touchend', window.endTear);
    document.removeEventListener('touchcancel', window.endTear); // <-- Auch hier sauber aufräumen
    
    if(!startY) return;
    let y = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
    let diff = y - startY;
    startY = 0;
    
    if(dragEl) dragEl.style.transition = 'transform 0.6s cubic-bezier(0.55, 0.085, 0.68, 0.53), opacity 0.5s ease';

    if (diff > 80) { 
        if(!isStub) {
            // Kinoreife Fall-Animation
            dragEl.style.transform = `translateY(${diff + 800}px) rotate(${diff * 0.1}deg) scale(0.8)`;
            dragEl.style.opacity = '0';
            
            // Warten, bis die Animation fertig ist, erst DANN rendern
            setTimeout(() => {
                window.isTicketAnimating = false; // <-- Lock aufheben
                localStorage.setItem(`torn_${state.user.uid}_${state.currentDrop.id}`, 'true');
                window.showToast("Ticket geöffnet.", "success");
                render(true); // <-- WICHTIG: true erzwingt das Update zum Chat
            }, 500); 
        } else {
            window.activateTicket();
            setTimeout(() => { window.isTicketAnimating = false; }, 600);
        }
    } else if(dragEl) { 
        // Sanftes Zurückfedern
        if (isStub) dragEl.style.transform = 'rotate(180deg)'; 
        else { dragEl.style.transform = 'translateY(0) rotate(0deg)'; dragEl.style.opacity = 1; }
        
        // Lock erst aufheben, wenn das Zurückfedern komplett fertig ist
        setTimeout(() => { window.isTicketAnimating = false; }, 600); 
    } else {
        window.isTicketAnimating = false;
    }
    dragEl = null;
};



        window.activateTicket = () => {
            const ticket = document.getElementById('main-ticket');
            if(ticket && !ticket.classList.contains('torn')) {
                ticket.classList.add('torn'); 
                setTimeout(() => window.enterRoomFlow(), 800);
            } else {
                window.enterRoomFlow();
            }
        };

        // --- AUTH & PROFILE ---
                // --- AUTH & PROFILE ---
              // --- AUTH & PROFILE ---
             window.handleAuth = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('auth_submit_btn');
    const email = document.getElementById('auth_email').value; 
    const pass = document.getElementById('auth_pass').value;
    let city = "Köln";
    let finalAlias = "The Stranger"; 

    if (state.authMode === 'register') {
        city = document.getElementById('reg_city').value;
        const nameInput = document.getElementById('reg_vibe');
        const realName = nameInput ? nameInput.value : "";
        
        if(btn) { btn.disabled = true; btn.innerText = "Casting Role..."; }
        
        // Timeout-Sicherung: Wenn die Generierung länger als 2 Sek dauert, nimm Fallback
        const aliasPromise = generateUniqueAlias(realName);
        const timeoutPromise = new Promise(res => setTimeout(() => res("The Mysterious Stranger"), 2000));
        finalAlias = await Promise.race([aliasPromise, timeoutPromise]);
    } else {
        if(btn) { btn.disabled = true; btn.innerText = "Processing..."; }
    }

    try {
        if (state.authMode === 'login') {
            state.view = 'loading'; render();
            await signInWithEmailAndPassword(auth, email, pass);
        } else {
            isRegistering = true;
            state.view = 'loading'; render();
            
            const userCred = await createUserWithEmailAndPassword(auth, email, pass);
            
            state.selectedCity = city;
            state.profile = { 
                hasPremium: false, tickets: [], completedDrops: [], 
                alias: finalAlias, city: city, isAdmin: false 
            };
            
            await setDoc(doc(db, 'plot_users', userCred.user.uid), state.profile);
            window.showToast(`Rolle zugewiesen: ${finalAlias}`, "success");
            isRegistering = false;
        }
    } catch (err) { 
        window.showToast(err.message, "error"); 
        state.view = 'auth'; isRegistering = false; render();
        if(btn) { btn.disabled = false; btn.innerText = state.authMode === 'login' ? 'Enter' : 'Join the Cast'; }
    }
};


        
        window.handleLogout = () => { 
            state.showSettings = false; 
            state.view = 'loading'; 
            render();
            signOut(auth); 
            window.showToast("Logged out.", "info"); 
        };
        
        window.resetPassword = async () => {
            if(!state.user) return;
            try { await sendPasswordResetEmail(auth, state.user.email); window.showToast("Passwort Reset-Link gesendet.", "success"); } catch(e) { window.showToast(e.message, "error"); }
        };

        window.resetAuthPassword = async () => {
            const email = document.getElementById('auth_email')?.value;
            if(!email) return window.showToast("Bitte gib erst deine E-Mail oben ein.", "info");
            try { await sendPasswordResetEmail(auth, email); window.showToast("Reset-Link gesendet.", "success"); } 
            catch(e) { window.showToast("Fehler: " + e.message, "error"); }
        };

        window.deleteAcc = async () => {
            if(confirm("Bist du sicher? Dies kann nicht rückgängig gemacht werden.")) {
                try { 
                    const userToDelete = auth.currentUser;
                    if(!userToDelete) return;
                    state.showSettings = false; render();
                    await deleteDoc(doc(db, 'plot_users', userToDelete.uid)); 
                    await deleteUser(userToDelete); 
                    window.showToast("Account gelöscht.", "success");
                } catch(e) { 
                    console.error(e);
                    window.showToast("Aus Sicherheitsgründen: Bitte logge dich kurz aus und wieder ein, um den Account zu löschen.", "error"); 
                    state.showSettings = true; render();
                }
            }
        };

        window.changeCity = async (e) => { await setDoc(doc(db, 'plot_users', state.user.uid), { city: e.target.value }, { merge: true }); window.showToast(`City changed to ${e.target.value}`, "info"); };
        window.regenerateAlias = async () => { 
            const newAlias = await generateUniqueAlias();
            await setDoc(doc(db, 'plot_users', state.user.uid), { alias: newAlias }, { merge: true }); 
            window.showToast(`Neue Identität: ${newAlias}`, "success"); 
        };

        // --- ADMIN FUNCTIONS ---
        window.handleLogoClick = () => {
            state.logoClicks++;
            if (state.logoClicks >= 5) {
                state.logoClicks = 0;
                state.showDirectorLogin = true;
                render();
            }
        };


        window.editDrop = (id) => {
            const drop = state.allDrops.find(d => d.id === id);
            if(!drop) return;
            state.editingDropId = id;
            document.getElementById('admin_city').value = drop.city;
            document.getElementById('admin_title').value = drop.title;
            document.getElementById('admin_vibe').value = drop.vibe;
            document.getElementById('admin_blurloc').value = drop.blurLocation;
            document.getElementById('admin_exactloc').value = drop.exactLocation;
            document.getElementById('admin_spots').value = drop.totalSpots || 4;
            document.getElementById('admin_prop').value = drop.prop;
            document.getElementById('admin_drink').value = drop.secretDrink;
            document.getElementById('admin_quests').value = drop.quests.join('\n');
            const d = new Date(drop.eventTime);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            document.getElementById('admin_time').value = d.toISOString().slice(0,16);
            
            document.getElementById('admin_form_title').innerText = "Drop bearbeiten";
            if (document.getElementById('admin_exclusive')) document.getElementById('admin_exclusive').checked = drop.isExclusive || false;

            window.scrollTo(0,0);
        };

        window.deleteDrop = async (id) => {
            if(confirm("Drop wirklich löschen?")) {
                try {
                    await deleteDoc(doc(db, 'plot_drops', id));
                    window.showToast("Drop gelöscht.", "success");
                    render(); 
                } catch(e) {
                    window.showToast("Fehler beim Löschen: " + e.message, "error");
                }
            }
        };

        window.toggleDropActive = async (id, currentStatus) => {
            await updateDoc(doc(db, 'plot_drops', id), { isActive: !currentStatus });
        };
        
        window.enterAdminLiveView = (dropId) => {
    const drop = state.allDrops.find(d => d.id === dropId);
    if(drop) {
        state.currentDrop = drop;
        state.view = 'room'; // Das umgeht die strenge Admin-Weiterleitung!
        render();
    }
};


        window.adminTimeTravel = async (action) => {
            if(!state.currentDrop) return;
            const ref = doc(db, 'plot_drops', state.currentDrop.id);
            const now = Date.now();
            
            try {
                if (action === 'reveal') {
                    await updateDoc(ref, { eventTime: now + (30 * 60 * 1000) });
                    window.showToast("Zeitsprung: Location enthüllt (Noch 30 Min).", "info");
                } else if (action === 'start') {
                    await updateDoc(ref, { eventTime: now - 1000, phase: 'live', activeQuestIndex: 0, questStartTime: now, readyVotes: [] });
                    window.showToast("Zeitsprung: Event gestartet!", "success");
                }
            } catch (e) {
                window.showToast("Fehler beim Zeitsprung.", "error");
            }
        };

        window.devSkipToLastQuest = async () => {
            if(!state.currentDrop || !state.currentDrop.quests) return;
            const lastIndex = state.currentDrop.quests.length - 1;
            const now = Date.now() + state.devTimeOffset;
            const targetStartTime = now - (15 * 60 * 1000) + 5000; 
            
            await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), {
                phase: 'live',
                activeQuestIndex: lastIndex,
                questStartTime: targetStartTime - state.devTimeOffset,
                readyVotes: []
            });
            window.showToast("Dev: Sprung zum Finale (5s)", "info");
        };

        

                      window.generateAIPlot = async () => {
            const localApiKey = localStorage.getItem('plot_gemini_key');
            if(!localApiKey || localApiKey.length < 5) { window.showToast("Bitte hinterlege zuerst deinen API Key (Button oben).", "error"); return; }
            
            const btn = document.getElementById('ai_generate_btn');
            if(btn) { btn.innerText = "✨ Generiere..."; btn.disabled = true; }

            const payload = {
                city: document.getElementById('admin_city').value,
                title: document.getElementById('admin_title').value,
                vibe: document.getElementById('admin_vibe').value,
                blurLocation: document.getElementById('admin_blurloc').value,
                exactLocation: document.getElementById('admin_exactloc').value,
                prop: document.getElementById('admin_prop').value,
                secretDrink: document.getElementById('admin_drink').value,
                quests: document.getElementById('admin_quests').value.split('\n').filter(q=>q.trim())
            };

            let weatherInfo = "Unbekannt";
            try {
                const weatherRes = await fetch(`https://wttr.in/${payload.city}?format=%C+%t`);
                weatherInfo = await weatherRes.text();
            } catch(e) { console.warn("Wetter konnte nicht geladen werden"); }
            
            // NEU: Nur das aktuelle Jetzt-Datum senden, damit die KI abwägen kann, wann das Event startet
            const now = new Date();
            const timeString = now.toLocaleString('de-DE');

            const promptStr = `Du bist Event-Designer für ein achtsames Solo-Date ('The Plot') in ${payload.city}.
            JETZT ist es: ${timeString}. Aktuelles Wetter: ${weatherInfo}.
            
            EISERNE REGELN:
            1. ÜBERSCHREIBE NICHTS KOMPLETT: Behalte bestehende Ideen bei und schmücke sie nur atmosphärisch aus.
            2. Fülle leere Felder passend aus.
            3. WICHTIG: Erfinde ein PERFEKTES Datum und eine Uhrzeit in der nahen Zukunft, die exakt zum Vibe passen (Morgensonne? Mitternacht?). Gib es im Format 'YYYY-MM-DDTHH:mm' zurück!
            4. Quests sollen emotionale, verletzliche Momente triggern und für mentale Erholung sorgen.
            
            Aktueller Entwurf: ${JSON.stringify(payload)}`;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${localApiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{parts: [{text: promptStr}]}],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    title: {type: "STRING"}, vibe: {type: "STRING"}, blurLocation: {type: "STRING"}, exactLocation: {type: "STRING"}, prop: {type: "STRING"}, secretDrink: {type: "STRING"}, quests: {type: "ARRAY", items: {type: "STRING"}},
                                    suggestedDateTime: {type: "STRING", description: "Format: YYYY-MM-DDTHH:mm"} // <-- KI liefert das neue Datum
                                },
                                required: ["title", "vibe", "blurLocation", "exactLocation", "prop", "secretDrink", "quests", "suggestedDateTime"]
                            }
                        }
                    })
                });
                
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                
                document.getElementById('admin_title').value = result.title || ''; 
                document.getElementById('admin_vibe').value = result.vibe || '';
                document.getElementById('admin_blurloc').value = result.blurLocation || ''; 
                document.getElementById('admin_exactloc').value = result.exactLocation || '';
                document.getElementById('admin_prop').value = result.prop || ''; 
                document.getElementById('admin_drink').value = result.secretDrink || '';
                if(result.quests && result.quests.length > 0) document.getElementById('admin_quests').value = result.quests.join('\n');
                
                // NEU: Überschreibt die Zeit im Formular mit der perfekten Zeit der KI
                if(result.suggestedDateTime) document.getElementById('admin_time').value = result.suggestedDateTime;
                
                window.showToast("Szene erfolgreich erweitert.", "success");
            } catch(e) { window.showToast("KI Fehler: " + e.message, "error"); }
            if(btn) { btn.innerText = "✨ KI Auto-Fill"; btn.disabled = false; }
        };
  
                

        window.createDrop = async (e) => {
            e.preventDefault();
            if(!state.profile?.isAdmin) return;
            const city = document.getElementById('admin_city').value;
            
            if(!state.editingDropId) {
                const snap = await getDocs(collection(db, 'plot_drops'));
                snap.forEach(async (d) => { if(d.data().city === city) await updateDoc(d.ref, { isActive: false }); });
            }

            const timeInput = document.getElementById('admin_time').value; 
            const eventTimestamp = new Date(timeInput).getTime();
            const totalSpots = parseInt(document.getElementById('admin_spots').value);

            const dropData = {
                city: city,
                title: document.getElementById('admin_title').value,
                vibe: document.getElementById('admin_vibe').value,
                blurLocation: document.getElementById('admin_blurloc').value,
                exactLocation: document.getElementById('admin_exactloc').value,
                eventTime: eventTimestamp,
                totalSpots: totalSpots,
                prop: document.getElementById('admin_prop').value,
                secretDrink: document.getElementById('admin_drink').value,
                quests: document.getElementById('admin_quests').value.split('\n').filter(q => q.trim() !== '')
                isExclusive: document.getElementById('admin_exclusive') ? document.getElementById('admin_exclusive').checked : false 
            };

            };

            if(state.editingDropId) {
                await updateDoc(doc(db, 'plot_drops', state.editingDropId), dropData);
                window.showToast(`Drop aktualisiert!`, "success");
                state.editingDropId = null;
                document.getElementById('admin_form_title').innerText = "Neuer Drop";
            } else {
                const newDrop = {
                    ...dropData,
                    id: 'drop_' + Date.now(),
                    spotsLeft: totalSpots,
                    isActive: true, phase: 'lobby', liveStartTime: null, activeQuestIndex: 0, questStartTime: null, intermissionStartTime: null, readyVotes: []
                };
                await setDoc(doc(db, 'plot_drops', newDrop.id), newDrop); 
                window.showToast(`Drop veröffentlicht!`, "success");
            }
            e.target.reset();
        };

        window.openPastChat = (dropId) => {
            state.openChatId = dropId;
            state.messages = []; 
            if (window.unsubChat) window.unsubChat();
            window.unsubChat = onSnapshot(collection(db, `plot_messages_${dropId}`), (msgSnap) => {
                state.messages = msgSnap.docs.map(d => d.data()).sort((a,b) => a.timestamp - b.timestamp);
                render(); scrollToBottom();
            });
            render();
        };

        window.sendMessage = async (dropIdOverride = null) => {
    const idToUse = dropIdOverride || state.currentDrop?.id;
    const input = document.getElementById('chat_input'); const text = input.value.trim();
    if (!text || !idToUse) return;
    try {
        await addDoc(collection(db, `plot_messages_${idToUse}`), { senderId: state.user.uid, senderAlias: state.profile?.alias || 'Stranger', text: text, timestamp: Date.now(), isSystem: false });
        input.value = ''; 
        input.blur(); // <-- Tastatur schließen, damit die neuen Nachrichten laden
        scrollToBottom();
    } catch (e) { window.showToast("Failed to send.", "error"); }
};

        window.requestCasting = async () => {
            if (!state.currentDrop) return;
            window.showToast("Casting-Anfrage wird übermittelt...", "info");
            try {
                await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), {
                    requestedBy: arrayUnion(state.user.uid)
                });
                window.showToast("Request gesendet. Die Regie prüft deine Rolle.", "success");
                render(true);
            } catch (err) { window.showToast("Systemfehler beim Casting Request.", "error"); }
        };


window.claimTicket = async () => {
    // 1. Aktuelle Ticket-Stände aus dem Profil laden
    const usedThisMonth = state.profile.monthlyTicketsUsed || 0;
    const extra = state.profile.extraTickets || 0;

    // 2. Prüfung: Wenn Limit von 3 erreicht und keine Extras vorhanden sind -> Paywall
    if (usedThisMonth >= 3 && extra <= 0) {
        window.showToast("Monatslimit (3/3) erreicht. Hol dir Nachschub!", "error");
        window.setView('paywall'); 
        return;
    }

    try {
        let updateData = {};
        
        // Logik: Erst die 3 monatlichen Tickets nutzen, dann die Extra-Tickets
        if (usedThisMonth < 3) {
            updateData.monthlyTicketsUsed = usedThisMonth + 1;
        } else {
            updateData.extraTickets = extra - 1;
        }

        // Ticket ID zum Profil hinzufügen
        const newTickets = [...(state.profile?.tickets || []), state.currentDrop.id];
        updateData.tickets = newTickets;

        // In Firebase speichern
        await setDoc(doc(db, 'plot_users', state.user.uid), updateData, { merge: true });
        
        // Spot im Drop abziehen
        await updateDoc(doc(db, 'plot_drops', state.currentDrop.id), { 
            spotsLeft: Math.max(0, (state.currentDrop.spotsLeft || 1) - 1) 
        });
        
        state.view = 'ticket'; 
        render();
        window.showToast("Rolle gesichert.", "success");
    } catch (err) { 
        window.showToast("Systemfehler beim Buchen.", "error"); 
    }
};



                
        
      

            function formatTimeLeft(ms) {
            if(ms <= 0) return "Jetzt";
            const d = Math.floor(ms / (1000 * 60 * 60 * 24));
            const h = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((ms % (1000 * 60)) / 1000);
            
            if (d > 0) return `${d}d ${h}h ${m}m ${s}s`;
            if (h > 0) return `${h}h ${m}m ${s}s`;
            if (m > 0) return `${m}m ${s}s`;
            return `${s}s`;
        }


        function formatMMSS(ms) {
            if(ms <= 0) return "00:00";
            const m = Math.floor(ms / 60000).toString().padStart(2, '0');
            const s = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
            return `${m}:${s}`;
        }
        function formatEventDate(timestamp) {
            if(!timestamp) return "Unbekannt";
            const d = new Date(timestamp);
            return d.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit' }) + " Uhr";
        }
        
        function formatExactTimeLeft(ms) {
            if(ms <= 0) return "Abgelaufen";
            const d = Math.floor(ms / (1000 * 60 * 60 * 24));
            const h = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            if (d > 0) return `${d}T ${h}Std`;
            if (h > 0) return `${h}Std ${m}Min`;
            return `${m}Min`;
        }

        // --- UI RENDERER ---
        // Ändere die erste Zeile zu:
function render(force = false) {
    // NEU: Stoppt Hintergrund-Updates, solange das Ticket bewegt wird oder die Tastatur offen ist
    if (!force) {
        if (window.isTicketAnimating) return; // <-- Schützt das Ticket!
        
        const active = document.activeElement;
        if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA')) return;
    }


    try {
        // --- NEU: Archiv-Logik ---
const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
const activeDrops = state.allDrops.filter(d => d.eventTime > sevenDaysAgo);
const archivedDrops = state.allDrops.filter(d => d.eventTime <= sevenDaysAgo);

        if (state.view === 'loading') {

                    appDiv.innerHTML = `<div class="text-center mt-40 flex flex-col items-center"><div class="w-16 h-16 border-t-2 border-l-2 border-amber-500 rounded-full animate-spin mb-6"></div><div class="text-2xl serif italic text-zinc-400">Loading your scene...</div></div>`;
                    return;
                }
             

                const activeEl = document.activeElement;
                const isChatInput = activeEl && activeEl.id === 'chat_input';
                let chatInputValue = '';
                let cursorStart = 0;
                let cursorEnd = 0;
                if (isChatInput) {
                    chatInputValue = activeEl.value;
                    try { cursorStart = activeEl.selectionStart; cursorEnd = activeEl.selectionEnd; } catch(e){}
                }

                const chatBtn = document.getElementById('floating-chat-btn');
                if (chatBtn) chatBtn.classList.toggle('hidden', !state.user || ['auth', 'loading', 'chats', 'room', 'battery_check'].includes(state.view));

                let html = `
                    <nav class="p-6 flex justify-between items-center max-w-5xl mx-auto w-full z-20 pt-8">
                        <div onclick="window.handleLogoClick()" class="text-2xl font-black tracking-tighter serif italic text-zinc-100 select-none cursor-pointer">The Plot.</div>
                        <div class="text-xs uppercase tracking-widest text-zinc-500 font-semibold flex items-center gap-4">
                            ${state.profile?.isAdmin ? "<span class='text-red-500 border border-red-500 px-2 py-1 rounded'>Director</span>" : state.profile?.hasPremium ? "<span class='text-amber-500'>Director's Cut</span>" : ""}
                            ${state.user ? `<button onclick="window.toggleSettings()" class="hover:text-white transition pointer-events-auto bg-zinc-900 p-2 rounded-full border border-zinc-700"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>` : ''}
                        </div>
                    </nav>
                    <div class="max-w-lg mx-auto px-4 w-full flex-1 flex flex-col justify-center z-20">
                `;

                if (state.showDirectorLogin) {
                    html += `
                        <div class="absolute inset-0 bg-zinc-950/95 z-[99999] flex flex-col items-center justify-center p-6 pointer-events-auto">
                            <h2 class="text-3xl serif italic text-red-500 mb-6">Director Login</h2>
                            <form onsubmit="window.submitDirectorPassword(event)" class="w-full max-w-xs flex flex-col gap-4">
                                <input id="dir_pwd" type="password" placeholder="Passwort" class="w-full p-4 bg-zinc-900 border border-zinc-800 rounded-xl outline-none focus:border-red-500 text-zinc-200 transition text-center tracking-widest">
                                <button type="submit" class="w-full bg-red-900/50 text-red-400 border border-red-800/50 hover:bg-red-800 hover:text-white font-bold py-4 rounded-xl transition uppercase tracking-widest">Enter</button>
                                <button type="button" onclick="window.closeDirectorLogin()" class="text-xs text-zinc-500 uppercase tracking-widest mt-4">Abbrechen</button>
                            </form>
                        </div>
                    `;
                }

                              if (state.view === 'admin') {
    let defaultDate = new Date(); defaultDate.setDate(defaultDate.getDate() + 1); defaultDate.setHours(20, 0, 0, 0);
    let isoDate = defaultDate.toISOString().slice(0, 16);

    html += `
        <div class="max-w-2xl mx-auto text-center mb-12 animate-fade-in pt-10">
            <h1 class="text-4xl serif italic mb-2 gold-text">Director's Dashboard</h1>
            <p class="text-zinc-500 text-sm tracking-widest uppercase">Erschaffe Magie. Kontrolliere die Zeit.</p>
        </div>
        
        <div class="max-w-xl mx-auto bg-amber-900/5 border border-amber-900/30 p-6 rounded-[32px] mb-8 backdrop-blur-sm">
            <div class="text-[10px] uppercase tracking-widest text-amber-600 font-black mb-4 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span> Live Broadcast
            </div>
            <div class="flex gap-2">
                <input id="broadcast_input" type="text" placeholder="Regieanweisung senden..." 
                       class="flex-1 bg-black/40 border border-zinc-800 rounded-xl px-4 py-3 text-sm text-zinc-200 outline-none focus:border-amber-500 transition">
                <button onclick="window.sendBroadcast()" class="bg-amber-500 text-black px-6 rounded-xl font-bold text-xs uppercase tracking-widest hover:bg-white transition shadow-lg">Senden</button>
            </div>
        </div>

        <div class="max-w-xl mx-auto space-y-6 mb-12">
            <div class="flex justify-between items-center px-4">
                <h3 class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold">Aktuelle Szenen</h3>
                <button onclick="window.setApiKey()" class="text-[9px] bg-zinc-900 text-zinc-400 px-3 py-1 rounded border border-zinc-800 hover:border-zinc-600 transition uppercase font-bold">🔑 API Key</button>
            </div>
            
            ${activeDrops.length > 0 ? activeDrops.map(d => `
                <div class="bg-zinc-900/40 backdrop-blur-md p-8 rounded-[32px] border ${d.isActive ? 'border-amber-900/50 shadow-[0_0_30px_rgba(217,119,6,0.1)]' : 'border-zinc-800'} transition-all">
                    <div class="text-center mb-6">
                        <div class="text-[10px] uppercase tracking-widest text-amber-600 font-bold mb-1">${d.isActive ? 'Live Drop' : 'Entwurf'}</div>
                        <h3 class="text-2xl serif italic text-zinc-100">${d.title}</h3>
                        <div class="text-[10px] text-zinc-500 mt-1 uppercase tracking-tighter">${formatEventDate(d.eventTime)} in ${d.city}</div>
                    </div>
                    
                    <div class="bg-black/20 rounded-2xl p-4 mb-6 border border-white/5">
                        <div class="text-[9px] uppercase tracking-widest text-zinc-600 font-bold mb-3 text-center">Zeitmaschine</div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="window.adminTimeTravel('reveal')" class="py-2 bg-zinc-800/50 text-[9px] text-zinc-400 rounded-lg border border-zinc-700 uppercase font-bold">Reveal</button>
                            <button onclick="window.adminTimeTravel('start')" class="py-2 bg-amber-900/40 text-[9px] text-amber-500 rounded-lg border border-amber-700/50 uppercase font-bold">Event Start</button>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="window.enterAdminLiveView('${d.id}')" class="flex-1 py-3 bg-zinc-800/80 text-zinc-300 text-[10px] uppercase font-bold rounded-xl border border-zinc-700">👀 Live</button>
                        <button onclick="window.editDrop('${d.id}')" class="flex-1 py-3 bg-zinc-800/80 text-zinc-300 text-[10px] uppercase font-bold rounded-xl border border-zinc-700">Edit</button>
                        <button onclick="window.deleteDrop('${d.id}')" class="px-4 py-3 rounded-xl border border-red-900/30 bg-red-900/10 text-red-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        <button onclick="window.toggleDropActive('${d.id}', ${d.isActive})" class="px-4 py-3 rounded-xl border ${d.isActive ? 'bg-amber-500 text-black' : 'bg-zinc-900 text-zinc-500 border-zinc-800'} transition"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/></svg></button>
                    </div>
                </div>
            `).join('') : '<p class="text-center text-zinc-600 text-xs py-10 italic">Keine aktuellen Szenen.</p>'}

            ${archivedDrops.length > 0 ? `
                <div class="pt-10">
                    <details class="group">
                        <summary class="flex justify-between items-center px-4 cursor-pointer list-none opacity-40 hover:opacity-100 transition">
                            <h3 class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold italic">Archivierte Produktionen</h3>
                            <span class="text-zinc-500 group-open:rotate-180 transition-transform">↓</span>
                        </summary>
                        <div class="mt-6 space-y-4 opacity-40 grayscale">
                            ${archivedDrops.map(d => `
                                <div class="bg-zinc-950 p-4 rounded-2xl border border-zinc-900 flex justify-between items-center">
                                    <div class="text-left">
                                        <div class="text-white text-sm font-bold">${d.title}</div>
                                        <div class="text-zinc-500 text-[9px] uppercase tracking-widest">${d.city} • ${formatEventDate(d.eventTime)}</div>
                                    </div>
                                    <button onclick="window.deleteDrop('${d.id}')" class="p-2 text-red-900 hover:text-red-500 transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                </div>
            ` : ''}
        </div>

        <div class="max-w-xl mx-auto grid grid-cols-2 gap-4 mb-12 opacity-60">
            <div class="p-4 bg-zinc-900/20 border border-zinc-800 rounded-2xl">
                <div class="text-[8px] uppercase tracking-widest text-amber-500 font-bold mb-1">Coming Soon</div>
                <div class="text-[10px] text-zinc-300 font-bold">Director's Cut Membership</div>
                <div class="text-[9px] text-zinc-500 mt-1 leading-tight">Exklusive Rollen & Geheime Orte.</div>
            </div>
            <div class="p-4 bg-zinc-900/20 border border-zinc-800 rounded-2xl">
                <div class="text-[8px] uppercase tracking-widest text-amber-500 font-bold mb-1">In Entwicklung</div>
                <div class="text-[10px] text-zinc-300 font-bold">Viral Vibe Cards</div>
                <div class="text-[9px] text-zinc-500 mt-1 leading-tight">Alias als Story-Asset teilen.</div>
            </div>
        </div>

        <div class="max-w-xl mx-auto bg-zinc-900/20 p-10 rounded-[40px] border border-zinc-800/50 backdrop-blur-sm mb-20 shadow-2xl">
            <div class="flex justify-between items-center mb-10">
                <h2 id="admin_form_title" class="text-2xl serif italic text-zinc-200">${state.editingDropId ? 'Szene anpassen' : 'Neuer Drop'}</h2>
                <div class="flex gap-2">
                    <select id="admin_city" class="bg-zinc-950 border border-zinc-700 text-[10px] uppercase font-bold p-2 rounded-lg outline-none focus:border-amber-500">${CITIES.map(c => `<option value="${c}">${c}</option>`).join('')}</select>
                    <button id="ai_generate_btn" type="button" onclick="window.generateAIPlot()" class="bg-amber-500 text-black px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-widest hover:bg-white transition">✨ KI Auto-Fill</button>
                </div>
            </div>
            <form onsubmit="window.createDrop(event)" class="space-y-4">
                <input id="admin_title" required placeholder="Titel" class="w-full p-4 bg-zinc-950/50 border border-zinc-800 rounded-2xl outline-none focus:border-amber-500 transition text-sm">
                <textarea id="admin_vibe" required placeholder="Vibe / Storytelling" class="w-full p-4 bg-zinc-950/50 border border-zinc-800 rounded-2xl outline-none h-24 focus:border-amber-500 transition text-sm leading-relaxed"></textarea>
                               <div class="grid grid-cols-2 gap-4">
                    <input id="admin_blurloc" required placeholder="Grobe Area" class="w-full p-4 bg-zinc-950/50 border border-zinc-800 rounded-2xl outline-none focus:border-amber-500 transition text-sm">
                    <input id="admin_exactloc" required placeholder="Exakte Adresse" class="w-full p-4 bg-zinc-950/50 border border-zinc-800 rounded-2xl outline-none focus:border-amber-500 transition text-sm">
                </div>
                
                <div class="p-4 bg-amber-900/10 border border-amber-500/30 rounded-2xl flex items-center justify-between">
                    <div>
                        <div class="text-[10px] uppercase tracking-widest text-amber-500 font-bold">Premium Casting</div>
                        <div class="text-xs text-zinc-400 mt-1">Erfordert Bewerbung durch die Nutzer.</div>
                    </div>
                    <input type="checkbox" id="admin_exclusive" class="w-6 h-6 accent-amber-500 cursor-pointer">
                </div>
                
                <div class="flex gap-4">
                    <input id="admin_time" type="datetime-local" required value="${isoDate}" class="flex-1 p-4 bg-zinc-950/50 border border-zinc-800 rounded-2xl outline-none focus:border-amber-500 transition text-sm">
                    <input id="admin_spots" type="number" value="4" class="w-20 p-4 bg-zinc-950/50 border border-zinc-800 rounded-2xl outline-none focus:border-amber-500 transition text-center text-sm font-bold">
                </div>

                <div class="flex gap-4">
                    <input id="admin_time" type="datetime-local" required value="${isoDate}" class="flex-1 p-4 bg-zinc-950/50 border border-zinc-800 rounded-2xl outline-none focus:border-amber-500 transition text-sm">
                    <input id="admin_spots" type="number" value="4" class="w-20 p-4 bg-zinc-950/50 border border-zinc-800 rounded-2xl outline-none focus:border-amber-500 transition text-center text-sm font-bold">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input id="admin_prop" required placeholder="Die Requisite" class="w-full p-4 bg-zinc-950/50 border border-zinc-800 rounded-2xl outline-none focus:border-amber-500 transition text-sm italic">
                    <input id="admin_drink" required placeholder="Geheimcode" class="w-full p-4 bg-zinc-950/50 border border-zinc-800 rounded-2xl outline-none focus:border-amber-500 transition text-sm italic">
                </div>
                <textarea id="admin_quests" required placeholder="Quests (Jede Zeile eine neue Quest)..." class="w-full p-4 bg-zinc-950/50 border border-zinc-800 rounded-2xl outline-none h-40 focus:border-amber-500 transition text-sm leading-relaxed"></textarea>
                <button type="submit" class="w-full bg-zinc-100 text-black font-black py-6 rounded-2xl mt-6 hover:bg-white transition uppercase tracking-widest text-xs shadow-2xl">${state.editingDropId ? 'Änderungen speichern' : 'Drop veröffentlichen'}</button>
                ${state.editingDropId ? `<button type="button" onclick="window.cancelEditDrop()" class="w-full text-zinc-600 py-2 text-[10px] uppercase font-bold tracking-widest">Abbrechen</button>` : ''}
            </form>
        </div>
    `;
}


                                                     else if (state.view === 'paywall') {
                    const displayPrice = state.bundlePrice ? state.bundlePrice.replace('.', ',') : '19,00';
                    const checkoutPrice = state.bundlePrice || '19.00';

                    // --- NEU: ANTI-FLICKER SCHUTZ ---
                    // Wenn der Button schon auf dem Bildschirm existiert, 
                    // aktualisieren wir nur den Preis und stoppen das Neu-Zeichnen!
                    if (document.getElementById('paypal-button-container')) {
                        const priceEl = document.getElementById('dynamic-price-display');
                        if (priceEl) priceEl.innerText = displayPrice + ' €';
                        return; // Bricht das Render hier sicher ab
                    }
                    // --------------------------------

                    html += `
                        <div class="text-center p-6 animate-fade-in flex flex-col items-center">
                            <div class="w-16 h-16 bg-amber-500/10 rounded-full flex items-center justify-center mb-4 border border-amber-500/30 shadow-[0_0_30px_rgba(217,119,6,0.2)]">
                                <svg class="w-8 h-8 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 012-2h10a2 2 0 012 2v14a2 2 0 01-2 2H7a2 2 0 01-2-2V5z"></path></svg>
                            </div>
                            <h2 class="text-3xl serif italic mb-3 gold-text">Casting Call.</h2>
                            <p class="text-zinc-400 text-sm mb-8 leading-relaxed max-w-xs mx-auto">Dein monatliches Kontingent von 3 Szenen ist erschöpft? Hol dir ein Bundle, um sofort weiterzuspielen!</p>
                            
                            <div class="bg-zinc-900/50 border border-amber-500/30 p-6 rounded-[32px] mb-6 w-full max-w-sm backdrop-blur-md shadow-[0_0_20px_rgba(0,0,0,0.5)]">
                                <div class="text-[10px] uppercase tracking-[0.2em] text-zinc-500 font-bold mb-2">Director's Bundle</div>
                                
                                <div id="dynamic-price-display" class="text-4xl font-black text-white mb-2">${displayPrice} €</div>
                                
                                <div class="text-[10px] text-amber-500/70 mb-6 font-mono tracking-widest">+5 EXTRA TICKETS</div>
                                
                                <div id="paypal-button-container" class="w-full min-h-[150px] relative z-50 flex items-center justify-center"></div>
                            </div>
                            
                            <button onclick="window.setView('home')" class="text-zinc-600 hover:text-zinc-400 text-[10px] uppercase tracking-[0.2em] font-bold transition">Später</button>
                        </div>
                    `;

                    setTimeout(() => {
                        if (window.paypal && document.getElementById('paypal-button-container') && !document.getElementById('paypal-button-container').innerHTML) {
                            paypal.Buttons({
                                createOrder: function(data, actions) {
                                    return actions.order.create({
                                        purchase_units: [{
                                            amount: { value: checkoutPrice, currency_code: 'EUR' },
                                            custom_id: state.user.uid 
                                        }]
                                    });
                                },
                                onApprove: function(data, actions) {
                                    return actions.order.capture().then(function(details) {
                                        window.showToast("Zahlung autorisiert! Tickets werden geladen.", "success");
                                        window.setView('home');
                                    });
                                }
                            }).render('#paypal-button-container');
                        } else if (!window.paypal) {
                            document.getElementById('paypal-button-container').innerHTML = '<div class="text-red-500 text-xs italic">System blockiert: Bitte lade die Seite neu.</div>';
                        }
                    }, 100);
                }




                else if (state.view === 'chats') {
                                        if(state.openChatId) {
                        const dropInfo = state.allDrops.find(d => d.id === state.openChatId);
                        html += `
                            <div class="absolute inset-0 flex flex-col bg-[#09090b] z-50 pointer-events-auto">
                                
                                <div class="p-4 border-b border-zinc-800/50 flex items-center backdrop-blur-md bg-zinc-900/80 pt-10 sticky top-0 z-20 shadow-md">
                                    <button onclick="window.closeChat()" class="flex items-center gap-2 text-zinc-400 hover:text-white uppercase tracking-widest text-[10px] font-bold transition mr-4 bg-zinc-800/50 px-3 py-2 rounded-full border border-zinc-700">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg> Übersicht
                                    </button>
                                    <h3 class="font-bold text-zinc-100 serif italic truncate text-lg">${dropInfo?.title || 'Storyline'}</h3>
                                </div>
                                
                                <div id="chat_messages" class="flex-1 overflow-y-auto p-4 chat-scroll flex flex-col gap-6 bg-gradient-to-b from-transparent to-zinc-900/50">
                                    
                                    ${state.profile?.journals?.[state.openChatId] ? `
                                    <div class="p-4 bg-amber-900/10 border border-amber-500/20 rounded-2xl shadow-inner mb-2 shrink-0">
                                        <h4 class="text-[10px] uppercase tracking-widest text-amber-500 font-bold mb-2">Dein After-Glow Journal</h4>
                                        <p class="text-sm text-zinc-300 italic leading-relaxed">"${state.profile.journals[state.openChatId]}"</p>
                                    </div>` : ''}

                                    ${state.messages.length === 0 ? `<div class="text-center text-zinc-500 text-sm mt-10">Noch keine Nachrichten in dieser Storyline.</div>` : ''}
                                    ${state.messages.map(msg => { 
                                        if(msg.isSystem) return `<div class="text-center my-2 w-full"><span class="text-[10px] text-zinc-500 uppercase tracking-widest bg-zinc-900/50 px-3 py-1.5 rounded-full border border-zinc-800/50 shadow-sm">${msg.text}</span></div>`;
                                        const isMe = msg.senderId === state.user?.uid; 
                                        return `<div class="max-w-[85%] ${isMe ? 'self-end text-right' : 'self-start'}"><div class="text-[10px] uppercase tracking-widest ${isMe ? 'text-amber-500/70' : 'text-zinc-500'} mb-1 font-bold">${isMe ? 'You' : msg.senderAlias}</div><div class="${isMe ? 'bg-amber-900/20 text-amber-50 border border-amber-900/30' : 'bg-zinc-800/50 text-zinc-200 border border-zinc-700/50'} p-4 rounded-2xl ${isMe ? 'rounded-tr-sm' : 'rounded-tl-sm'} shadow-sm text-sm font-medium leading-relaxed backdrop-blur-sm">${msg.text}</div></div>`; 
                                    }).join('')}
                                </div>
                                
                                <div class="p-4 bg-zinc-900/90 border-t border-zinc-800/50 backdrop-blur-md pb-8">
                                    <div class="flex gap-2 relative max-w-lg mx-auto">
                                        <input id="chat_input" type="text" class="flex-1 p-4 bg-zinc-950 rounded-xl border border-zinc-700 outline-none focus:border-amber-500/50 text-zinc-200 transition shadow-inner" placeholder="Nachricht..." onkeypress="if(event.key === 'Enter') window.sendMessage('${state.openChatId}')">
                                        <button onclick="window.sendMessage('${state.openChatId}')" class="bg-zinc-100 text-zinc-900 px-6 rounded-xl font-bold hover:bg-white transition shadow-[0_0_15px_rgba(255,255,255,0.1)]">➔</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {

                        const completedDrops = state.profile?.completedDrops || [];
                        const pastEvents = state.allDrops.filter(d => completedDrops.includes(d.id));
                        
                        html += `
                            <div class="mb-8 flex justify-between items-center">
                                <div><h1 class="text-4xl serif italic mb-2 gold-text">Storylines.</h1><p class="text-zinc-400 text-sm">Deine Gruppen- und Privat-Chats.</p></div>
                                <button onclick="window.setView('${state.hasTicket ? 'ticket' : 'home'}')" class="text-zinc-500 hover:text-white uppercase tracking-widest text-xs font-bold transition flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg> Zurück</button>
                            </div>
                            <div class="space-y-4 mb-20">
                                ${pastEvents.length === 0 ? `<div class="text-center p-10 border border-zinc-800 border-dashed rounded-3xl text-zinc-500 text-sm">Du hast noch keine aktiven Verbindungen.</div>` : ''}
                                ${pastEvents.map(d => {
                                    const age = Date.now() - (d.eventTime || Date.now());
                                    const msLeft = (7 * 24 * 60 * 60 * 1000) - age;
                                    if(msLeft <= 0) return ''; 
                                    
                                    return `
                                    <div onclick="window.openPastChat('${d.id}')" class="bg-zinc-900/50 border border-zinc-800 hover:border-amber-500/50 p-6 rounded-3xl cursor-pointer transition group relative overflow-hidden flex flex-col gap-4">
                                        <div class="relative z-10 flex justify-between items-start">
                                            <div>
                                                <div class="text-[10px] text-zinc-500 uppercase tracking-widest font-bold mb-1">Gruppenchat</div>
                                                <h3 class="text-xl serif italic text-zinc-100 mb-1 group-hover:text-amber-400 transition leading-tight">${d.title}</h3>
                                            </div>
                                            <div class="bg-zinc-950 px-3 py-1.5 rounded-lg text-[10px] font-bold text-amber-500 border border-amber-900/30 flex items-center gap-1 shadow-inner">
                                                <svg class="w-3 h-3 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                                ${formatExactTimeLeft(msLeft)}
                                            </div>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        `;
                    }
                }
                else if (state.view === 'nodrop') {
                    html += `
                        <div class="text-center">
                            <div class="w-16 h-16 mx-auto bg-zinc-900 rounded-full flex items-center justify-center mb-6 border border-zinc-800"><svg class="w-6 h-6 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div>
                            <h1 class="text-3xl serif italic mb-3">Keine Szenen in ${state.selectedCity}.</h1>
                            <p class="text-zinc-500 text-sm">Die Regie plant gerade den nächsten Plot. Hab etwas Geduld.</p>
                        </div>
                    `;
                }
                else if (state.view === 'auth') {
                    html += `
                        <div class="text-center mb-10"><h1 class="text-4xl serif italic mb-3">Claim your storyline.</h1><p class="text-zinc-400 text-sm leading-relaxed">Solo-Dates ohne Dating-Angst.<br>Echte Begegnungen. Magisches Pacing.</p></div>
                        <form onsubmit="window.handleAuth(event)" class="space-y-4">
                            <input id="auth_email" type="email" placeholder="Email" required value="${state.tempEmail || ''}" class="w-full p-4 bg-zinc-900/50 border border-zinc-800 rounded-xl outline-none focus:border-amber-500/50 text-zinc-200 transition">
                            <div class="relative">
                                <input id="auth_pass" type="password" placeholder="Password" required minlength="6" class="w-full p-4 bg-zinc-900/50 border border-zinc-800 rounded-xl outline-none focus:border-amber-500/50 text-zinc-200 transition">
                                ${state.authMode === 'login' ? `<div class="text-right mt-2"><button type="button" onclick="window.resetAuthPassword()" class="text-[10px] text-zinc-500 hover:text-amber-500 uppercase tracking-widest transition">Passwort vergessen?</button></div>` : ''}
                            </div>
                            
                            ${state.authMode === 'register' ? `
                                <div class="pt-4 pb-2 border-t border-zinc-800/50">
                                    <label class="text-xs uppercase tracking-widest text-zinc-500 font-bold block mb-2">Deine Stadt</label>
                                    <select id="reg_city" class="w-full p-4 bg-zinc-900/50 border border-zinc-800 rounded-xl outline-none focus:border-amber-500/50 text-zinc-200 mb-4">${CITIES.map(c => `<option value="${c}">${c}</option>`).join('')}</select>
                                    
                                    <label class="text-xs uppercase tracking-widest text-zinc-500 font-bold block mb-2">Dein Vibe</label>
                                    <input id="reg_vibe" type="text" placeholder="Wir generieren deinen einzigartigen Alias." required class="w-full p-4 bg-zinc-900/50 border border-zinc-800 rounded-xl outline-none focus:border-amber-500/50 text-zinc-200 transition text-sm">
                                </div>
                            ` : ''}

                            <button id="auth_submit_btn" type="submit" class="w-full bg-zinc-100 text-zinc-900 hover:bg-white font-bold py-4 rounded-xl transition text-sm uppercase tracking-widest mt-4 shadow-[0_0_15px_rgba(255,255,255,0.1)]">
                                ${state.authMode === 'login' ? 'Enter' : 'Join the Cast'}
                            </button>
                        </form>
                        <button onclick="window.toggleAuthMode()" class="w-full text-center mt-6 text-xs text-zinc-500 hover:text-zinc-300 uppercase tracking-widest transition">${state.authMode === 'login' ? 'Neu hier? Ticket lösen' : 'Bereits Teil der Cast? Login'}</button>
                    `;
                }
                               else if (state.view === 'home') {
                    const drop = state.currentDrop;
                    const isExclusive = drop.isExclusive;
                    const hasRequested = drop.requestedBy?.includes(state.user?.uid);
                    const spotsFull = drop.spotsLeft === 0;

                    let btnHtml = '';
                    let badgeHtml = '';

                    if (isExclusive) {
                        badgeHtml = `<span class="bg-amber-900/40 text-amber-500 border border-amber-500/30 px-3 py-1.5 rounded-full text-[9px] uppercase tracking-widest font-black shadow-[0_0_15px_rgba(217,119,6,0.15)] flex items-center gap-1.5"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> Premium Casting</span>`;
                        const btnText = spotsFull ? 'Casting Closed' : (hasRequested ? 'In Review...' : 'Request Casting');
                        const btnClass = (spotsFull || hasRequested) ? 'bg-zinc-900 text-zinc-600 border border-zinc-800' : 'bg-amber-600 hover:bg-amber-500 text-white shadow-[0_0_20px_rgba(217,119,6,0.3)]';
                        btnHtml = `<button ${hasRequested ? '' : 'onclick="window.requestCasting()"'} ${(spotsFull || hasRequested) ? 'disabled' : ''} class="w-full ${btnClass} font-bold py-4 rounded-xl transition text-sm uppercase tracking-widest flex justify-center gap-2 items-center">${hasRequested ? '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>' : ''} ${btnText}</button>`;
                    } else {
                        badgeHtml = `<span class="bg-blue-900/20 text-blue-400 border border-blue-500/20 px-3 py-1.5 rounded-full text-[9px] uppercase tracking-widest font-black flex items-center gap-1.5"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg> Casual Plot</span>`;
                        const btnText = spotsFull ? 'Sold Out' : 'Claim Ticket (Instant)';
                        const btnClass = spotsFull ? 'bg-zinc-800 text-zinc-500' : 'bg-zinc-100 text-zinc-900 hover:bg-white shadow-[0_0_20px_rgba(255,255,255,0.1)]';
                        btnHtml = `<button onclick="window.claimTicket()" ${spotsFull ? 'disabled' : ''} class="w-full ${btnClass} font-bold py-4 rounded-xl transition text-sm uppercase tracking-widest">${btnText}</button>`;
                    }

                    html += `
                        <div class="mb-4 flex flex-wrap justify-between items-center gap-y-3">
                            <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span><span class="text-xs uppercase tracking-widest text-red-500 font-bold">Nächster Drop in ${drop.city}</span></div>
                            ${badgeHtml}
                        </div>
                        <div class="bg-zinc-900/60 border ${isExclusive ? 'border-amber-900/40 shadow-[0_0_40px_rgba(217,119,6,0.1)]' : 'border-zinc-800 shadow-2xl'} rounded-3xl p-8 backdrop-blur-sm relative overflow-hidden group">
                            <div class="absolute inset-0 opacity-20 bg-[url('https://images.unsplash.com/photo-1511556820780-d912e42b4980?auto=format&fit=crop&q=80')] bg-cover bg-center transition duration-1000 group-hover:scale-105 group-hover:opacity-30"></div>
                            <div class="relative z-10">
                                <h2 class="text-4xl serif italic mb-2 ${isExclusive ? 'gold-text' : 'text-zinc-100'}">${drop.title}</h2>
                                <p class="text-zinc-400 text-sm mb-8 leading-relaxed">"${drop.vibe}"</p>
                                <div class="space-y-4 mb-10">
                                    <div class="flex justify-between items-center text-sm border-b border-zinc-800/50 pb-4">
                                        <span class="text-zinc-500 uppercase tracking-widest text-xs">Location</span>
                                        <span class="text-zinc-300 flex items-center gap-2 text-right text-xs">
                                            <span>${drop.blurLocation}</span>
                                            ${isExclusive ? '<svg class="w-3 h-3 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>' : ''}
                                        </span>
                                    </div>
                                    <div class="flex justify-between items-center text-sm border-b border-zinc-800/50 pb-4"><span class="text-zinc-500 uppercase tracking-widest text-xs">Time</span><span class="text-zinc-300">${formatEventDate(drop.eventTime)}</span></div>
                                    <div class="flex justify-between items-center text-sm"><span class="text-zinc-500 uppercase tracking-widest text-xs">Capacity</span><span class="${isExclusive ? 'text-amber-500' : 'text-blue-400'} font-bold">${drop.spotsLeft} Spots left</span></div>
                                </div>
                                ${btnHtml}
                            </div>
                        </div>
                    `;
                }

            

                else if (state.view === 'ticket') {
                    const isTorn = localStorage.getItem(`torn_${state.user?.uid}_${state.currentDrop.id}`) === 'true';
                    const now = Date.now() + state.devTimeOffset;
                    const msUntilEvent = state.currentDrop.eventTime - now;
                    const isWithinOneHour = msUntilEvent <= (60 * 60 * 1000); 

                    if (!isTorn) {
                        html += `
                            <div class="text-center mb-12 animate-fade-in"><h1 class="text-3xl serif italic mb-2 gold-text">Dein Ticket.</h1><p class="text-zinc-400 text-sm">Zieh es nach unten, um die Details zu öffnen.</p></div>
                            
                            <div class="relative mx-6 z-20" id="draggable-ticket" onmousedown="window.startTear(event)" ontouchstart="window.startTear(event)" style="touch-action: none; user-select: none; -webkit-user-select: none;">

                                <div class="paper-texture bg-gradient-to-br from-zinc-200 to-zinc-400 rounded-2xl shadow-[0_20px_50px_rgba(0,0,0,0.5)] flex flex-col items-center justify-center py-16 relative overflow-hidden">
                                    <div class="absolute inset-0 opacity-10 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIiAvPgo8cmVjdCB3aWR0aD0iMSIgaGVpZ2h0PSIxIiBmaWxsPSIjMDAwIiAvPjwvc3ZnPg==')] pointer-events-none"></div>
                                    <div class="uppercase tracking-widest text-[10px] text-zinc-600 font-bold mb-6 relative z-20">Secret Drop</div>
                                    <h2 class="text-4xl serif italic font-black mb-6 text-zinc-900 text-center leading-tight drop-shadow-sm px-4 relative z-20">${state.currentDrop.title}</h2>
                                    <div class="text-[10px] bg-zinc-900 text-zinc-200 px-4 py-1.5 rounded-full font-bold uppercase tracking-widest mb-4 shadow-inner relative z-20">${state.currentDrop.city}</div>
                                    
                                    <div class="absolute bottom-4 left-0 right-0 flex flex-col items-center text-zinc-600 opacity-60 animate-pulse pointer-events-none z-20">
                                        <span class="text-[9px] uppercase tracking-widest font-bold mb-1">Ganzes Ticket ziehen</span>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="text-center mb-8 animate-fade-in"><h1 class="text-3xl serif italic mb-2 gold-text">Your Scene is Ready.</h1><p class="text-zinc-400 text-sm">You are the main character. Go alone.</p></div>
                            
                            <div class="mx-4 paper-texture bg-gradient-to-br from-zinc-100 to-zinc-300 rounded-b-2xl p-8 shadow-2xl relative overflow-hidden border border-white/50 animate-fade-in mt-2">
                                <div class="torn-edge"></div>
                                
                                <div class="flex justify-between items-start mb-6 mt-4 relative z-20">
                                    <div class="uppercase tracking-widest text-[10px] text-zinc-500 font-bold">Admit One</div>
                                    <div class="text-[10px] bg-zinc-800 text-zinc-200 px-2 py-1 rounded font-bold uppercase tracking-widest">${state.currentDrop.city}</div>
                                </div>
                                
                                <h2 class="text-3xl serif italic font-black mb-2 text-zinc-900 leading-tight relative z-20">${state.currentDrop.title}</h2>
                                <p class="text-xs text-zinc-600 mb-8 italic border-b border-zinc-400/50 pb-6 relative z-20">"${state.currentDrop.vibe}"</p>
                                
                                <div class="space-y-5 mb-2 text-zinc-900 relative z-20">
                                    <div>
                                        <div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold mb-1">Grobe Area</div>
                                        <div class="font-bold text-sm text-zinc-800">${state.currentDrop.blurLocation}</div>
                                    </div>
                                    
                                    <div>
                                        <div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold mb-1">Secret Location</div>
                                        ${isWithinOneHour 
                                            ? `<div class="font-bold text-amber-700 leading-tight text-lg">${state.currentDrop.exactLocation}</div>` 
                                            : `<div class="font-black text-lg text-zinc-800 blur-[6px] select-none opacity-50">Geheimer Ort 123, 50667 Köln</div>
                                               <div class="text-xs text-red-600 mt-1 font-bold flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> Unlocks in: ${formatTimeLeft(msUntilEvent - 3600000)}</div>`
                                        }
                                    </div>
                                    
                                    ${state.currentDrop.phase !== 'lobby' ? `<div class="bg-white/80 p-3 rounded-lg shadow-sm border border-zinc-300/50"><div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold mb-1">Your Prop (Requisite)</div><div class="font-semibold text-sm italic">${state.currentDrop.prop}</div></div><div class="bg-white/80 p-3 rounded-lg shadow-sm border border-zinc-300/50"><div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold mb-1">Secret Password</div><div class="font-semibold text-sm italic">${state.currentDrop.secretDrink}</div></div>` : ''}
                                    
                                    <div class="flex justify-between pt-4 border-t border-zinc-400/50">
                                        <div><div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold">Time</div><div class="font-semibold text-sm">${formatEventDate(state.currentDrop.eventTime)}</div></div>
                                        <div class="text-right"><div class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold">Your Alias</div><div class="font-semibold italic text-amber-700 text-sm">${state.profile?.alias}</div></div>
                                    </div>
                                </div>
                            </div>

                            ${state.currentDrop.phase === 'lobby' ? `<button onclick="window.enterRoomFlow()" class="mt-8 mx-4 bg-zinc-800 border border-zinc-700 hover:bg-zinc-700 text-white font-bold py-4 rounded-xl transition text-sm uppercase tracking-widest block w-[calc(100%-32px)] text-center shadow-lg">Lobby Chat öffnen</button>` : state.currentDrop.phase === 'live' ? `<button onclick="window.enterRoomFlow()" class="mt-8 mx-4 bg-amber-600 hover:bg-amber-500 text-white font-bold py-4 rounded-xl transition shadow-[0_0_20px_rgba(217,119,6,0.4)] text-sm uppercase tracking-widest animate-pulse block w-[calc(100%-32px)] text-center">ENTER LIVE SCENE</button>` : `<button onclick="window.enterRoomFlow()" class="mt-8 mx-4 bg-white text-black font-bold py-4 rounded-xl transition text-sm uppercase tracking-widest block w-[calc(100%-32px)] text-center shadow-lg">View Credits (Connect)</button>`}
                            <button onclick="window.shareScene()" class="w-full text-center mt-6 text-xs text-zinc-500 hover:text-amber-500 uppercase tracking-widest transition flex justify-center items-center gap-2 pb-10"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg> Share your Scene</button>
                        `;
                    }
                }
                else if (state.view === 'battery_check') {
                    html += `
                        <div class="absolute inset-0 flex flex-col items-center justify-center bg-[#09090b] z-50 p-6 pointer-events-auto pb-20">
                            <button onclick="window.setView('ticket')" class="absolute top-8 right-8 text-zinc-500 hover:text-white uppercase tracking-widest text-xs font-bold transition">Zurück</button>
                            
                            <h2 class="text-4xl serif italic mb-3 gold-text text-center mt-10">Social Battery.</h2>
                            <p class="text-zinc-400 text-sm text-center mb-10 max-w-xs leading-relaxed">Wie viel soziale Energie hast du heute? Dieser Vibe wird als Systemnachricht im Chat gepostet, um Grenzen sofort klar zu kommunizieren.</p>
                            
                            <div class="space-y-4 w-full max-w-sm">
                                <button onclick="window.setSocialBattery('Stiller Beobachter')" class="w-full p-5 border border-zinc-800 rounded-2xl hover:bg-zinc-900 transition flex flex-col items-start gap-1 group text-left relative overflow-hidden">
                                    <div class="absolute inset-0 bg-blue-500/5 translate-x-[-100%] group-hover:translate-x-0 transition-transform duration-500"></div>
                                    <span class="font-bold text-zinc-300 relative z-10 flex items-center gap-2"><svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg> Stiller Beobachter</span>
                                    <span class="text-xs text-zinc-500 relative z-10">Ich höre lieber zu und bleibe für mich.</span>
                                </button>
                                
                                <button onclick="window.setSocialBattery('Casual Vibe')" class="w-full p-5 border border-zinc-800 rounded-2xl hover:bg-zinc-900 transition flex flex-col items-start gap-1 group text-left relative overflow-hidden">
                                    <div class="absolute inset-0 bg-emerald-500/5 translate-x-[-100%] group-hover:translate-x-0 transition-transform duration-500"></div>
                                    <span class="font-bold text-zinc-300 relative z-10 flex items-center gap-2"><svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Casual Vibe</span>
                                    <span class="text-xs text-zinc-500 relative z-10">Offen für leichte, ungezwungene Interaktion.</span>
                                </button>
                                
                                <button onclick="window.setSocialBattery('Deep Talk Ready')" class="w-full p-5 border border-zinc-800 rounded-2xl hover:bg-zinc-900 transition flex flex-col items-start gap-1 group text-left relative overflow-hidden">
                                    <div class="absolute inset-0 bg-amber-500/5 translate-x-[-100%] group-hover:translate-x-0 transition-transform duration-500"></div>
                                    <span class="font-bold text-amber-500 relative z-10 flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"></path></svg> Deep Talk Ready</span>
                                    <span class="text-xs text-zinc-500 relative z-10">Bereit für echte Verbindung und tiefe Gespräche.</span>
                                </button>
                            </div>
                            
                            <div class="mt-8 w-full max-w-sm">
    <label class="text-[10px] uppercase tracking-widest text-zinc-500 font-bold mb-2 block text-left">Gentle Icebreaker (Optional)</label>
    <input id="icebreaker_input" type="text" placeholder="Frag mich nach..." 
           class="w-full p-4 bg-zinc-900/50 border border-zinc-800 rounded-xl outline-none focus:border-amber-500/50 text-zinc-200 text-sm shadow-inner">
</div>

                        </div>
                    `;
                }
                else if (state.view === 'room') {
                    const now = Date.now() + state.devTimeOffset;

                    if (state.currentDrop.phase === 'lobby') {
                        if(state.showBreathe) {
                            html += `
                                <div class="absolute inset-0 flex flex-col items-center justify-center bg-[#09090b] z-50 p-6 text-center pointer-events-auto">
                                    <button onclick="window.toggleBreathe()" class="absolute top-8 right-8 text-zinc-500 hover:text-white uppercase tracking-widest text-xs font-bold transition">Zurück</button>
                                    <h2 class="text-3xl serif italic mb-12 text-zinc-300">Ground Yourself.</h2>
                                    <div class="relative w-48 h-48 flex items-center justify-center"><div class="absolute inset-0 bg-amber-500/20 rounded-full animate-breathe blur-xl"></div><div class="absolute inset-4 border border-amber-500/30 rounded-full animate-breathe" style="animation-delay: 0.5s"></div><div class="w-24 h-24 bg-zinc-800 rounded-full z-10 flex items-center justify-center shadow-2xl border border-zinc-700/50"><span class="text-xs uppercase tracking-widest text-amber-500 font-bold">Breathe</span></div></div>
                                    <p class="text-zinc-500 text-sm mt-12 max-w-xs leading-relaxed">Atme 4 Sekunden ein. Halte 7 Sekunden. Atme 8 Sekunden aus. Du bist sicher.</p>
                                </div>
                            `;
                        } else {
                            html += `
                                <div class="absolute inset-0 flex flex-col bg-[#09090b] z-50 pointer-events-auto pb-6">
                                    <div class="p-6 border-b border-zinc-800/50 flex justify-between items-center backdrop-blur-md bg-zinc-900/50 pt-10 sticky top-0 z-20">
                                        <div><h3 class="font-bold text-zinc-100 serif italic text-xl">The Lobby</h3><div class="text-[10px] uppercase tracking-widest text-amber-500 font-bold mt-1">Starts at ${formatEventDate(state.currentDrop.eventTime)}</div></div>
                                        <div class="flex items-center gap-4">
                                            <button onclick="window.toggleBreathe()" class="text-amber-500/70 hover:text-amber-500 transition" title="Nervous?"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>
                                            <button onclick="window.setView('ticket')" class="text-zinc-500 hover:text-red-400 uppercase tracking-widest text-xs font-bold transition flex items-center gap-1" title="Du kannst jederzeit ohne Begründung gehen.">Safe Exit <svg class="w-4 h-4 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg></button>
                                        </div>
                                    </div>
                                    <div id="chat_messages" class="flex-1 overflow-y-auto p-6 chat-scroll flex flex-col gap-6 bg-gradient-to-b from-transparent to-zinc-900/50">
                                        <div class="text-center my-4 flex flex-col items-center gap-2">
                                            <span class="bg-zinc-800 text-zinc-400 text-[10px] uppercase tracking-widest px-4 py-2 rounded-full border border-zinc-700/50 shadow-sm">Anonymous connection to the cast.</span>
                                        </div>
                                       ${state.messages.map(msg => { 
    if(msg.isSystem) return `<div class="text-center my-2 w-full"><span class="text-[10px] text-zinc-500 uppercase tracking-widest bg-zinc-900/50 px-3 py-1.5 rounded-full border border-zinc-800/50 shadow-sm">${msg.text}</span></div>`;
    
    // NEU: Broadcast Design (Gold/Zentriert)
    if(msg.isBroadcast) return `
        <div class="w-full my-6 px-4 animate-fade-in">
            <div class="bg-amber-900/10 border border-amber-500/30 p-6 rounded-[32px] text-center shadow-[0_0_30px_rgba(217,119,6,0.1)]">
                <div class="text-[9px] uppercase tracking-[0.2em] text-amber-500 font-black mb-2">Director's Note</div>
                <div class="serif italic text-lg text-amber-50 leading-relaxed">"${msg.text}"</div>
            </div>
        </div>`;

    const isMe = msg.senderId === state.user?.uid; 
    return `<div class="max-w-[85%] ${isMe ? 'self-end text-right' : 'self-start'}">
        <div class="text-[10px] uppercase tracking-widest ${isMe ? 'text-amber-500/70' : 'text-zinc-500'} mb-1 font-bold">${isMe ? 'You' : msg.senderAlias}</div>
        <div class="${isMe ? 'bg-amber-900/20 text-amber-50 border border-amber-900/30' : 'bg-zinc-800/50 text-zinc-200 border border-zinc-700/50'} p-4 rounded-2xl ${isMe ? 'rounded-tr-sm' : 'rounded-tl-sm'} shadow-sm text-sm font-medium leading-relaxed backdrop-blur-sm">${msg.text}</div>
    </div>`; 
}).join('')}

                                    </div>
                                    <div class="p-4 bg-zinc-900/80 border-t border-zinc-800/50 backdrop-blur-md pb-8"><div class="flex gap-2 relative max-w-lg mx-auto"><input id="chat_input" type="text" class="flex-1 p-4 bg-zinc-950/50 rounded-xl border border-zinc-800 outline-none focus:border-amber-500/50 text-zinc-200 transition shadow-inner" placeholder="Whisper something..." onkeypress="if(event.key === 'Enter') window.sendMessage()"><button onclick="window.sendMessage()" class="bg-zinc-100 text-zinc-900 px-6 rounded-xl font-bold hover:bg-white transition shadow-[0_0_15px_rgba(255,255,255,0.1)]">➔</button></div></div>
                                </div>
                            `;
                        }
                    } else if (state.currentDrop.phase === 'live') {
                        const qIndex = state.currentDrop.activeQuestIndex || 0;
                        const quest = state.currentDrop.quests[qIndex] || "Keine Quests verfügbar.";
                        
                        const timeLimit = 15 * 60 * 1000;
                        const elapsed = now - (state.currentDrop.questStartTime || now);
                        const timeLeft = Math.max(0, timeLimit - elapsed);
                        const progressPercent = Math.min(100, (elapsed / timeLimit) * 100);
                        
                        const totalParticipants = Math.max(1, (state.currentDrop.totalSpots || 4) - state.currentDrop.spotsLeft);
                        const votes = state.currentDrop.readyVotes?.length || 0;
                        const hasVoted = state.currentDrop.readyVotes?.includes(state.user?.uid);

                        html += `
                            <div class="absolute inset-0 flex flex-col bg-[#09090b] z-50 items-center justify-center p-6 text-center pointer-events-auto pb-6">
                                <button onclick="window.setView('ticket')" class="absolute top-8 right-8 text-zinc-500 hover:text-red-400 uppercase tracking-widest text-xs font-bold transition flex items-center gap-1" title="Fühlst du dich unwohl? Du kannst jederzeit sicher abbrechen.">Safe Exit <svg class="w-4 h-4 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg></button>
                                
                                <div class="mb-12">
                                    <h2 class="text-4xl serif italic mb-3 gold-text">Eure Szene.</h2>
                                    <p class="text-zinc-400 text-sm tracking-widest uppercase">Lass die Geschichte sich entfalten.</p>
                                </div>
                                
                                <div class="w-full max-w-sm bg-zinc-900/80 border border-zinc-700/50 rounded-3xl p-8 backdrop-blur-md shadow-[0_0_50px_rgba(0,0,0,0.6)] flex flex-col items-center">
                                    <div class="w-full flex justify-between text-[10px] uppercase tracking-widest text-amber-500 font-bold mb-4">
                                        <span>Quest ${qIndex + 1} / ${state.currentDrop.quests.length}</span>
                                        <span class="font-mono">${formatMMSS(timeLeft)}</span>
                                    </div>
                                    
                                    <h3 class="text-2xl serif italic text-white leading-relaxed mb-8 flex-1 flex items-center">${quest}</h3>
                                    
                                    <div class="w-full h-1.5 bg-zinc-800 rounded-full mb-8 overflow-hidden shadow-inner">
                                        <div class="h-full bg-amber-500/80 progress-bar-smooth shadow-[0_0_10px_rgba(217,119,6,0.8)]" style="width: ${progressPercent}%"></div>
                                    </div>

                                    <button onclick="window.voteReady()" class="w-full border ${hasVoted ? 'bg-emerald-900/40 border-emerald-500/50 text-emerald-400' : 'bg-zinc-800 border-zinc-700 hover:bg-zinc-700 text-zinc-300'} py-3 rounded-xl text-xs uppercase tracking-widest font-bold transition flex justify-center items-center gap-2">
                                        ${hasVoted ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Warten auf andere' : 'Wir sind fertig'} 
                                        <span class="bg-black/30 px-2 py-0.5 rounded ml-2">${votes}/${totalParticipants}</span>
                                    </button>
                                </div>
                            </div>
                        `;
                    } else if (state.currentDrop.phase === 'intermission') {
                        const breakDuration = 60 * 1000;
                        const elapsed = now - (state.currentDrop.intermissionStartTime || now);
                        const breakLeft = Math.max(0, breakDuration - elapsed);

                        html += `
                            <div class="absolute inset-0 flex flex-col bg-[#09090b] z-50 items-center justify-center p-6 text-center pointer-events-auto pb-6">
                                <h2 class="text-4xl serif italic mb-4 text-blue-300">Kurze Pause.</h2>
                                <p class="text-zinc-400 text-sm max-w-xs leading-relaxed mb-12">Atmet durch. Geht zur Bar oder sammelt eure Gedanken. Gleich geht die nächste Runde los.</p>
                                
                                <div class="relative w-32 h-32 flex items-center justify-center">
                                    <svg class="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="45" fill="none" stroke="#1f2937" stroke-width="4"></circle>
                                        <circle cx="50" cy="50" r="45" fill="none" stroke="#93c5fd" stroke-width="4" stroke-dasharray="283" stroke-dashoffset="${283 - (breakLeft/breakDuration)*283}" class="transition-all duration-1000 ease-linear"></circle>
                                    </svg>
                                    <div class="text-2xl font-mono text-white">${formatMMSS(breakLeft)}</div>
                                </div>
                            </div>
                        `;
                    } else if (state.currentDrop.phase === 'finale') {
                        html += `
                            <div class="absolute inset-0 flex flex-col bg-[#09090b] z-50 items-center justify-center p-6 text-center pointer-events-auto pb-6">
                                <h2 class="text-4xl serif italic mb-4 gold-text">Die Szene ist im Kasten.</h2>
                                <p class="text-zinc-400 text-sm max-w-sm leading-relaxed mb-12">Die geführte Story ist vorbei. Ihr habt es toll gemacht. Der Abend gehört jetzt euch: Tauscht euch aus, trinkt in Ruhe aus, oder verabschiedet euch.</p>
                                <button onclick="window.advanceToCredits()" class="bg-zinc-100 text-zinc-900 px-8 py-4 rounded-xl font-bold hover:bg-white transition shadow-[0_0_15px_rgba(255,255,255,0.1)] uppercase tracking-widest text-xs">Wen möchtest du wiedersehen?</button>
                            </div>
                        `;
                    } else if (state.currentDrop.phase === 'credits') {
                        
                        // Finde alle einzigartigen Teilnehmer aus den Nachrichten
                        const uniqueParticipants = [];
                        const seenIds = new Set();
                        state.messages.forEach(m => {
                            if(m.senderId !== 'system' && m.senderId !== state.user?.uid && !seenIds.has(m.senderId)) {
                                seenIds.add(m.senderId);
                                uniqueParticipants.push({id: m.senderId, alias: m.senderAlias});
                            }
                        });

                        html += `
                            <div class="absolute inset-0 flex flex-col bg-[#09090b] z-50 p-6 overflow-y-auto pb-20 pointer-events-auto">
                                <div class="text-center mt-12 mb-8"><h2 class="text-3xl serif italic mb-3">Wen möchtest du wiedersehen?</h2><p class="text-zinc-400 text-sm max-w-sm mx-auto leading-relaxed">Wähle die Personen, mit denen du privat in Kontakt bleiben möchtest. Wenn sie dich auch wählen, entsteht ein Match. Der Gruppenchat der Szene bleibt ohnehin noch 7 Tage für alle offen.</p></div>
                                <div class="max-w-sm mx-auto w-full space-y-4">
                                    
                                    ${uniqueParticipants.length === 0 ? `<div class="p-6 border border-zinc-800 border-dashed rounded-2xl text-center text-zinc-500 text-sm">Leider gab es keine anderen aktiven Schreiber im Chat.</div>` : ''}
                                    
                                    ${uniqueParticipants.map(p => `
                                        <label class="flex items-center justify-between p-5 border border-zinc-800 rounded-2xl cursor-pointer hover:bg-zinc-900 transition group">
                                            <span class="font-bold text-zinc-300 group-hover:text-amber-500 transition">${p.alias}</span>
                                            <input type="checkbox" name="match_selections" value="${p.id}" class="w-5 h-5 accent-amber-500">
                                        </label>
                                    `).join('')}
                                    
<div class="mt-8 p-6 bg-zinc-900/50 border border-amber-500/20 rounded-2xl text-left">
    <h3 class="serif italic text-amber-500 text-lg mb-1">After-Glow Journal</h3>
    <p class="text-[10px] text-zinc-500 uppercase tracking-widest mb-4">Ein Moment für dich: Wofür bist du heute dankbar?</p>
    <textarea id="afterglow_journal" placeholder="Schreibe hier deine Gedanken auf..." 
              class="w-full h-24 bg-zinc-950 border border-zinc-800 rounded-xl p-3 text-sm text-zinc-300 outline-none focus:border-amber-500/50 transition"></textarea>
</div>

                                    <button onclick="window.submitCredits()" class="w-full bg-zinc-100 text-black font-bold py-4 rounded-xl mt-6 uppercase tracking-widest text-sm hover:bg-white transition">Auswahl speichern</button>
                                </div>
                            </div>
                        `;
                    }
                }

                html += `</div>`;

                                if (state.showSettings) {
                    html += `
                        <div class="fixed inset-0 bg-zinc-950/90 z-[9999] p-6 flex flex-col justify-center animate-fade-in pointer-events-auto">
                            <div class="bg-zinc-900 border border-zinc-800 rounded-3xl p-8 max-w-sm w-full mx-auto shadow-2xl relative">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-2xl serif italic">Settings</h2>
                                    <button onclick="window.toggleSettings()" class="text-zinc-500 hover:text-white transition">✕</button>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-2 mb-6">
                                    <div class="bg-zinc-950 p-4 rounded-2xl border border-zinc-800">
                                        <div class="text-[8px] uppercase tracking-widest text-zinc-500 font-bold mb-1">Monats-Tickets</div>
                                        <div class="text-lg font-bold text-zinc-200">${3 - (state.profile?.monthlyTicketsUsed || 0)}/3</div>
                                    </div>
<div onclick="window.setView('paywall')" 
     class="bg-zinc-950 p-4 rounded-2xl border transition cursor-pointer group ${ (state.profile?.extraTickets || 0) === 0 ? 'animate-pulse-gold border-amber-600' : 'border-zinc-800 hover:border-amber-500/50' }">
    <div class="text-[8px] uppercase tracking-widest text-zinc-500 font-bold mb-1 group-hover:text-amber-500 transition">Extra-Tickets</div>
    <div class="flex items-center justify-between">
        <div class="text-lg font-bold text-amber-500">${state.profile?.extraTickets || 0}</div>
        <svg class="w-4 h-4 text-amber-500/50 group-hover:text-amber-500 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
    </div>
</div>


                                </div>

                                <div class="space-y-4">
                                    <div>
                                        <label class="text-xs uppercase tracking-widest text-zinc-500 font-bold block mb-2">Location</label>
                                        <select onchange="window.changeCity(event)" class="w-full bg-zinc-950 border border-zinc-800 p-3 rounded-xl text-sm outline-none focus:border-amber-500 transition">
                                            ${CITIES.map(c => `<option value="${c}" ${state.selectedCity === c ? 'selected' : ''}>${c}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="p-4 bg-amber-900/10 border border-amber-500/20 rounded-xl flex justify-between items-center">
                                        <div>
                                            <div class="text-[10px] uppercase tracking-widest text-amber-500 font-bold mb-1">Your Alias</div>
                                            <div class="font-serif italic text-lg text-zinc-200">${state.profile?.alias || 'The Stranger'}</div>
                                        </div>
                                        <button onclick="window.regenerateAlias()" class="text-xs bg-amber-900/50 text-amber-400 px-3 py-1.5 rounded hover:bg-amber-800/50 transition border border-amber-700/50">Reroll</button> 
                                    </div>
                                    
                                    <button onclick="window.generateShareCard()" class="w-full py-4 bg-amber-900/10 text-amber-500 rounded-2xl font-bold uppercase text-[10px] tracking-widest border border-amber-900/30 hover:bg-amber-900/20 transition flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                        Export Alias Card
                                    </button>
                                </div>

                                <div class="mt-8 space-y-1 border-t border-zinc-800 pt-4">
                                    <button onclick="window.resetPassword()" class="w-full text-left p-2 text-[10px] uppercase tracking-widest text-zinc-500 hover:text-zinc-100 transition">Passwort Reset</button>
                                    <button onclick="window.handleLogout()" class="w-full text-left p-2 text-[10px] uppercase tracking-widest text-zinc-500 hover:text-zinc-100 transition">Ausloggen</button>
                                    <button onclick="window.deleteAcc()" class="w-full text-left p-2 text-[10px] uppercase tracking-widest text-red-900 hover:text-red-500 transition">Account löschen</button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                appDiv.innerHTML = html;
                
                // Cursor & Input Fokus erhalten
                if (isChatInput) {
                    const restoredInput = document.getElementById('chat_input');
                    if (restoredInput) {
                        restoredInput.value = chatInputValue;
                        restoredInput.focus();
                        try { restoredInput.setSelectionRange(cursorStart, cursorEnd); } catch(e){}
                    }
                }
            } catch (err) {
                appDiv.innerHTML = `<div class="max-w-lg mx-auto mt-20 p-8 bg-red-900/30 border border-red-500 text-red-200 rounded-xl">Render Fehler: ${err.message}</div>`;
            }
        }

    </script>
</body>
</html>
